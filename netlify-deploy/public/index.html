<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="QuizMaster - Zaawansowana platforma do tworzenia i przeprowadzania egzaminów online dla polskich szkół. Obsługuje egzamin ósmoklasisty oraz maturę.">
    <meta name="keywords" content="egzamin, ósmoklasisty, matura, generator arkuszy, edukacja, szkoła, test online">
    <meta name="author" content="QuizMaster Team">
    <meta name="theme-color" content="#7c3aed">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="QuizMaster - Generator Arkuszy Egzaminacyjnych">
    <meta property="og:description" content="Tworzenie i przeprowadzanie egzaminów online dla polskich szkół">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎓</text></svg>">
    
    <title>QuizMaster - Generator Arkuszy Egzaminacyjnych</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/zadania-db.js?v=2025071001"></script>
    <script src="js/docx-parser.js?v=2025071001"></script>
    <script src="js/init-enhanced.js?v=2025071001"></script>
    <script src="js/advanced-pdf-parser.js"></script>
    <script src="js/pdf-import-manager.js"></script>
    <script src="js/task-variant-generator.js"></script>
    <script src="js/achievements-system.js"></script>
    <script src="js/exam-templates-bank.js"></script>
    <script src="js/exam-scheduler.js"></script>
    <script src="js/recommendation-system.js"></script>
    <script src="js/competition-system.js"></script>
    <script src="js/test-data-generator.js"></script>
    <script src="js/advanced-math-module.js"></script>
    <script src="js/database-sync.js"></script>
    <script src="js/ui-improvements.js"></script>
    <script src="js/pdf-export.js"></script>
    <script src="js/push-notifications.js"></script>
    <script src="js/quick-review-mode.js"></script>
    <script src="js/parent-panel.js"></script>
    <script src="js/extended-gamification.js"></script>
    <script src="js/navigation-integration.js"></script>
    <script src="js/teacher-enhancements.js"></script>
    
    <!-- Moduły CKE i AI -->
    <script src="js/cke-parser-system.js"></script>
    <script src="js/step-grading-system.js"></script>
    <script src="js/ai-grader.js"></script>
    <script src="js/cke-import-ui.js"></script>
    <style>
        /* Import fontów */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Zmienne CSS */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-primary: #7c3aed;
            --accent-secondary: #a855f7;
            --accent-gradient: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-glow: 0 0 20px rgba(124, 58, 237, 0.5);
        }
        
        /* Reset i podstawowe style */
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Przyciski */
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-primary);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Inputy */
        .input-modern {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .input-modern:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        /* Karty */
        .card-modern {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .card-modern {
                padding: 1rem;
            }
        }
        
        .card-modern:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* Animacje */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(124, 58, 237, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(124, 58, 237, 0.8), 0 0 30px rgba(124, 58, 237, 0.6);
            }
        }
        
        /* Loader */
        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }
        
        /* Taby */
        .tab-modern {
            position: relative;
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .tab-modern:hover {
            color: var(--text-primary);
        }
        
        .tab-modern.active {
            color: var(--accent-primary);
        }
        
        .tab-modern.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-gradient);
        }
        
        /* Gradient text */
        .gradient-text {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Geometry task images */
        .geometry-image {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            padding: 2rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            backdrop-filter: blur(10px);
        }
        
        .geometry-image svg {
            max-width: 100%;
            height: auto;
            /* Usuń filter: brightness(0) invert(1); dla bardziej naturalnego wyglądu */
        }
        
        /* Specificzne style dla elementów SVG */
        .geometry-image svg text {
            fill: #e0e0e0 !important;
            font-weight: 500;
        }
        
        .geometry-image svg line,
        .geometry-image svg path {
            stroke: #ffffff !important;
            stroke-width: 2;
        }
        
        .geometry-image svg circle,
        .geometry-image svg rect,
        .geometry-image svg polygon,
        .geometry-image svg polyline {
            stroke: #ffffff !important;
            stroke-width: 2;
        }
        
        /* Wypełnienia dla różnych kolorów */
        .geometry-image svg [fill="lightblue"] {
            fill: rgba(59, 130, 246, 0.3) !important;
        }
        
        .geometry-image svg [fill="lightgreen"] {
            fill: rgba(34, 197, 94, 0.3) !important;
        }
        
        .geometry-image svg [fill="lightcoral"] {
            fill: rgba(239, 68, 68, 0.3) !important;
        }
        
        .geometry-image svg [fill="lightyellow"] {
            fill: rgba(250, 204, 21, 0.3) !important;
        }
        
        .geometry-image svg [fill="lightsteelblue"] {
            fill: rgba(147, 197, 253, 0.3) !important;
        }
        
        .geometry-image svg [fill="blue"] {
            fill: rgba(59, 130, 246, 0.5) !important;
        }
        
        .geometry-image svg [fill="red"] {
            fill: rgba(239, 68, 68, 0.8) !important;
            stroke: rgba(239, 68, 68, 1) !important;
        }
        
        /* Dla elementów bez wypełnienia */
        .geometry-image svg [fill="none"] {
            fill: none !important;
        }
        
        /* Specjalne style dla osi współrzędnych */
        .geometry-image svg line[stroke="black"] {
            stroke: rgba(255, 255, 255, 0.5) !important;
        }
        
        .geometry-image svg line[stroke="red"] {
            stroke: #ef4444 !important;
        }
        
        /* Dla linii przerywanych */
        .geometry-image svg [stroke-dasharray] {
            stroke: rgba(124, 58, 237, 0.8) !important;
        }
        
        .geometry-svg {
            max-width: 100%;
            height: auto;
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
        }
        
        /* Line clamp utility */
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Dodatkowe style dla przycisków kolorowych */
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-600:hover, .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-green-600:hover, .hover\:bg-green-700:hover { background-color: #15803d; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-red-600:hover, .hover\:bg-red-700:hover { background-color: #b91c1c; }
        .bg-purple-600 { background-color: #9333ea; }
        .bg-purple-600:hover, .hover\:bg-purple-700:hover { background-color: #7e22ce; }
        .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-600:hover, .hover\:bg-gray-700:hover { background-color: #374151; }
        
        /* Style dla gwiazdek oceny */
        .text-yellow-400 { color: #facc15; }
        .text-green-400 { color: #4ade80; }
        .text-purple-400 { color: #c084fc; }
        .text-blue-400 { color: #60a5fa; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // Inicjalizacja PDF.js
        if (typeof pdfjsLib !== 'undefined') {
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Klasa do zarządzania autoryzacją
        class AuthManager {
          static hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
          }

          static createUser(username, password, role = 'student', category = null) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const hashedPassword = this.hashPassword(password);
            
            if (users.find(u => u.username === username)) {
              throw new Error('Użytkownik już istnieje');
            }

            const newUser = {
              id: Date.now(),
              userId: Date.now(), // dla kompatybilności z test-data-generator
              username,
              password: hashedPassword,
              role,
              category: role === 'student' ? category : null,
              fullName: username.includes('rodzic.') ? 
                'Rodzic ' + username.replace('rodzic.', '').charAt(0).toUpperCase() + username.replace('rodzic.', '').slice(1) : 
                null,
              createdAt: new Date()
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            return newUser;
          }

          static login(username, password) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const hashedPassword = this.hashPassword(password);
            
            const user = users.find(u => u.username === username && u.password === hashedPassword);
            if (!user) {
              throw new Error('Nieprawidłowa nazwa użytkownika lub hasło');
            }

            // Zapisz sesję
            const session = {
              userId: user.id || user.userId, // obsługa obu formatów
              username: user.username,
              role: user.role,
              category: user.category,
              loginTime: new Date()
            };
            sessionStorage.setItem('currentUser', JSON.stringify(session));
            
            return session;
          }

          static logout() {
            sessionStorage.removeItem('currentUser');
          }

          static getCurrentUser() {
            const session = sessionStorage.getItem('currentUser');
            return session ? JSON.parse(session) : null;
          }

          static initDefaultUsers() {
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Napraw użytkowników bez userId
            let updated = false;
            users = users.map(user => {
              if (!user.userId && user.id) {
                updated = true;
                return { ...user, userId: user.id };
              }
              return user;
            });
            
            if (updated) {
              localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Zawsze sprawdź czy istnieje główny nauczyciel
            if (!users.find(u => u.username === 'paulinaodmatematyki')) {
              try {
                this.createUser('paulinaodmatematyki', 'paulina#314159265', 'teacher');
              } catch (e) {
                console.log('Nauczyciel paulinaodmatematyki już istnieje');
              }
            }
            
            if (users.length === 0) {
              // Stwórz domyślnych użytkowników
              this.createUser('admin', 'admin123', 'teacher');
              
              // Stwórz przykładowe konta rodziców
              this.createUser('rodzic.nowak', 'rodzic123', 'parent');
              this.createUser('rodzic.kowalski', 'rodzic123', 'parent');
              
              // Stwórz 20 przykładowych kont uczniów
              const studentsData = [
                // Egzamin ósmoklasisty (7 uczniów)
                { name: 'Anna Nowak', category: 'egzamin ósmoklasisty' },
                { name: 'Piotr Kowalski', category: 'egzamin ósmoklasisty' },
                { name: 'Katarzyna Wiśniewska', category: 'egzamin ósmoklasisty' },
                { name: 'Michał Wójcik', category: 'egzamin ósmoklasisty' },
                { name: 'Magdalena Kamińska', category: 'egzamin ósmoklasisty' },
                { name: 'Jakub Lewandowski', category: 'egzamin ósmoklasisty' },
                { name: 'Aleksandra Dąbrowska', category: 'egzamin ósmoklasisty' },
                
                // Matura podstawowa (7 uczniów)
                { name: 'Tomasz Zieliński', category: 'matura podstawowa' },
                { name: 'Natalia Szymańska', category: 'matura podstawowa' },
                { name: 'Adam Woźniak', category: 'matura podstawowa' },
                { name: 'Monika Kozłowska', category: 'matura podstawowa' },
                { name: 'Paweł Jankowski', category: 'matura podstawowa' },
                { name: 'Karolina Mazur', category: 'matura podstawowa' },
                { name: 'Mateusz Krawczyk', category: 'matura podstawowa' },
                
                // Matura rozszerzona (6 uczniów)
                { name: 'Ewa Piotrowska', category: 'matura rozszerzona' },
                { name: 'Bartosz Grabowski', category: 'matura rozszerzona' },
                { name: 'Joanna Pawłowska', category: 'matura rozszerzona' },
                { name: 'Krzysztof Michalski', category: 'matura rozszerzona' },
                { name: 'Agnieszka Król', category: 'matura rozszerzona' },
                { name: 'Rafał Wieczorek', category: 'matura rozszerzona' }
              ];
              
              studentsData.forEach((student, index) => {
                this.createUser(student.name.toLowerCase().replace(' ', '.'), 'uczen123', 'student', student.category);
              });
              
              // Generuj przykładowe wyniki dla uczniów
              this.generateSampleResults();
            }
          }
          
          static generateSampleResults() {
            const users = JSON.parse(localStorage.getItem('users') || '[]').filter(u => u.role === 'student');
            const results = [];
            
            users.forEach(user => {
              // Generuj 3-5 wyników dla każdego ucznia
              const numResults = Math.floor(Math.random() * 3) + 3;
              
              for (let i = 0; i < numResults; i++) {
                const daysAgo = Math.floor(Math.random() * 30);
                const date = new Date();
                date.setDate(date.getDate() - daysAgo);
                
                const result = {
                  examId: Date.now() + Math.random(),
                  examTitle: `Arkusz ${user.category} - Test ${i + 1}`,
                  studentName: user.username.replace('.', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                  studentId: user.id,
                  category: user.category,
                  correctAnswers: Math.floor(Math.random() * 8) + 3,
                  totalQuestions: 10,
                  earnedPoints: Math.floor(Math.random() * 80) + 20,
                  totalPoints: 100,
                  percentage: Math.floor(Math.random() * 50) + 50,
                  completedAt: date.toISOString(),
                  timeSpent: Math.floor(Math.random() * 1800) + 600 // 10-40 minut
                };
                
                results.push(result);
              }
            });
            
            localStorage.setItem('examResults', JSON.stringify(results));
          }
        }

        // Inicjalizacja domyślnych użytkowników
        AuthManager.initDefaultUsers();

        // Rozszerzona baza zadań z obrazkami
        // zadania are now loaded from js/zadania-db.js as window.zadania

        // Komponent główny
        function App() {
          const [view, setView] = useState('login'); // login, teacher, student, parent, exam, results, register
          const [user, setUser] = useState(null);
          const [currentExam, setCurrentExam] = useState(null);
          const [examResults, setExamResults] = useState(null);

          useEffect(() => {
            // Sprawdź czy użytkownik jest już zalogowany
            const currentUser = AuthManager.getCurrentUser();
            if (currentUser) {
              setUser(currentUser);
              setView(currentUser.role === 'teacher' ? 'teacher' : currentUser.role === 'parent' ? 'parent' : 'student');
            }
          }, []);

          return (
            <div className="min-h-screen bg-gray-900">
              {view === 'login' && <LoginView onLogin={(userData) => {
                setUser(userData);
                setView(userData.role === 'teacher' ? 'teacher' : userData.role === 'parent' ? 'parent' : 'student');
              }} onRegister={() => setView('register')} />}
              
              {view === 'register' && <RegisterView onRegister={(userData) => {
                setUser(userData);
                setView(userData.role === 'teacher' ? 'teacher' : userData.role === 'parent' ? 'parent' : 'student');
              }} onBack={() => setView('login')} />}
              
              {view === 'teacher' && <TeacherView user={user} onLogout={() => {
                AuthManager.logout();
                setUser(null);
                setView('login');
              }} />}
              
              {view === 'student' && <StudentView 
                user={user} 
                onStartExam={(exam) => {
                  setCurrentExam(exam);
                  setView('exam');
                }}
                onLogout={() => {
                  AuthManager.logout();
                  setUser(null);
                  setView('login');
                }} 
              />}
              
              {view === 'exam' && <ExamView 
                exam={currentExam} 
                user={user}
                onFinish={(results) => {
                  setExamResults(results);
                  setView('results');
                }}
              />}
              
              {view === 'results' && <ResultsView 
                results={examResults}
                onBack={() => setView('student')}
              />}
              
              {view === 'parent' && <ParentView 
                user={user}
                onLogout={() => {
                  AuthManager.logout();
                  setUser(null);
                  setView('login');
                }}
              />}
            </div>
          );
        }

        // Widok logowania
        function LoginView({ onLogin, onRegister }) {
          const [username, setUsername] = useState('');
          const [password, setPassword] = useState('');
          const [showPassword, setShowPassword] = useState(false);
          const [error, setError] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            try {
              const userData = AuthManager.login(username, password);
              onLogin(userData);
            } catch (err) {
              setError(err.message);
            }
          };

          return (
            <div className="flex items-center justify-center min-h-screen">
              <div className="glass-dark p-8 rounded-2xl shadow-2xl w-96 fade-in">
                <h1 className="text-3xl font-bold mb-6 text-center gradient-text">QuizMaster</h1>
                <h2 className="text-xl mb-6 text-center text-gray-300">Generator Arkuszy Egzaminacyjnych</h2>
                {error && (
                  <div className="bg-red-500/20 border border-red-500 text-red-300 p-3 rounded mb-4">
                    {error}
                  </div>
                )}
                <form onSubmit={handleSubmit}>
                  <input
                    type="text"
                    placeholder="Nazwa użytkownika"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    className="input-modern w-full mb-4"
                    required
                  />
                  <div className="relative mb-4">
                    <input
                      type={showPassword ? "text" : "password"}
                      placeholder="Hasło"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="input-modern w-full pr-10"
                      required
                    />
                    <button
                      type="button"
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"
                    >
                      <i className={`fas ${showPassword ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                    </button>
                  </div>
                  <button
                    type="submit"
                    className="btn-primary w-full mb-4"
                  >
                    Zaloguj się
                  </button>
                  <button
                    type="button"
                    onClick={onRegister}
                    className="btn-secondary w-full"
                  >
                    Zarejestruj się
                  </button>
                </form>
              </div>
            </div>
          );
        }

        // Widok rejestracji
        function RegisterView({ onRegister, onBack }) {
          const [formData, setFormData] = useState({
            username: '',
            password: '',
            confirmPassword: '',
            role: 'student',
            category: 'egzamin ósmoklasisty'
          });
          const [error, setError] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            
            if (formData.password !== formData.confirmPassword) {
              setError('Hasła nie są identyczne');
              return;
            }
            
            if (formData.password.length < 6) {
              setError('Hasło musi mieć co najmniej 6 znaków');
              return;
            }
            
            try {
              const user = AuthManager.createUser(
                formData.username,
                formData.password,
                formData.role,
                formData.role === 'student' ? formData.category : null
              );
              const session = AuthManager.login(formData.username, formData.password);
              onRegister(session);
            } catch (err) {
              setError(err.message);
            }
          };

          return (
            <div className="flex items-center justify-center min-h-screen">
              <div className="glass-dark p-8 rounded-2xl shadow-2xl w-96 fade-in">
                <h1 className="text-2xl font-bold mb-6 text-center">Rejestracja</h1>
                {error && (
                  <div className="bg-red-500/20 border border-red-500 text-red-300 p-3 rounded mb-4">
                    {error}
                  </div>
                )}
                <form onSubmit={handleSubmit}>
                  <input
                    type="text"
                    placeholder="Nazwa użytkownika"
                    value={formData.username}
                    onChange={(e) => setFormData({...formData, username: e.target.value})}
                    className="input-modern w-full mb-4"
                    required
                  />
                  <input
                    type="password"
                    placeholder="Hasło (min. 6 znaków)"
                    value={formData.password}
                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                    className="input-modern w-full mb-4"
                    required
                  />
                  <input
                    type="password"
                    placeholder="Potwierdź hasło"
                    value={formData.confirmPassword}
                    onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                    className="input-modern w-full mb-4"
                    required
                  />
                  <div className="mb-4">
                    <label className="block text-sm font-medium mb-2">Rola:</label>
                    <select
                      value={formData.role}
                      onChange={(e) => setFormData({...formData, role: e.target.value})}
                      className="input-modern w-full"
                    >
                      <option value="student">Uczeń</option>
                      <option value="teacher">Nauczyciel</option>
                      <option value="parent">Rodzic</option>
                    </select>
                  </div>
                  {formData.role === 'student' && (
                    <div className="mb-4">
                      <label className="block text-sm font-medium mb-2">Kategoria:</label>
                      <select
                        value={formData.category}
                        onChange={(e) => setFormData({...formData, category: e.target.value})}
                        className="input-modern w-full"
                      >
                        <option value="egzamin ósmoklasisty">Egzamin ósmoklasisty</option>
                        <option value="matura podstawowa">Matura podstawowa</option>
                        <option value="matura rozszerzona">Matura rozszerzona</option>
                      </select>
                    </div>
                  )}
                  {formData.role === 'parent' && (
                    <div className="bg-purple-900/20 border border-purple-700 rounded-lg p-4 mb-4">
                      <i className="fas fa-info-circle mr-2"></i>
                      <span className="text-sm">Po rejestracji będziesz mógł połączyć konto z dzieckiem używając specjalnego kodu.</span>
                    </div>
                  )}
                  {formData.role === 'teacher' && (
                    <div className="bg-blue-900/20 border border-blue-700 rounded-lg p-4 mb-4">
                      <i className="fas fa-info-circle mr-2"></i>
                      <span className="text-sm">Jako nauczyciel będziesz mógł tworzyć egzaminy, importować zadania i zarządzać uczniami.</span>
                    </div>
                  )}
                  <button
                    type="submit"
                    className="btn-primary w-full mb-4"
                  >
                    Zarejestruj się
                  </button>
                  <button
                    type="button"
                    onClick={onBack}
                    className="btn-secondary w-full"
                  >
                    Powrót do logowania
                  </button>
                </form>
              </div>
            </div>
          );
        }

        // Widok nauczyciela
        function TeacherView({ user, onLogout }) {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [selectedSubjects, setSelectedSubjects] = useState([]);
          const [examConfig, setExamConfig] = useState({
            questionsCount: 5,
            timeLimit: 30,
            targetCategories: ['egzamin ósmoklasisty'], // Domyślnie
            randomMode: true // Nowy parametr: true = losowy, false = ręczny wybór
          });
          const [selectedTasks, setSelectedTasks] = useState([]); // Dla ręcznego wyboru zadań
          const [pendingExams, setPendingExams] = useState([]);
          const [groups, setGroups] = useState([]);
          const [newGroupName, setNewGroupName] = useState('');
          const [selectedGroupForExam, setSelectedGroupForExam] = useState('all');
          const [showMoreDropdown, setShowMoreDropdown] = useState(false);

          // Odśwież listę przedmiotów
          const subjects = [...new Set(window.zadania.map(z => z.przedmiot))];

          // Zamknij dropdown po kliknięciu poza nim
          useEffect(() => {
            const handleClickOutside = (event) => {
              if (showMoreDropdown && !event.target.closest('.relative')) {
                setShowMoreDropdown(false);
              }
            };
            
            document.addEventListener('click', handleClickOutside);
            return () => document.removeEventListener('click', handleClickOutside);
          }, [showMoreDropdown]);

          // Załaduj grupy i oczekujące egzaminy przy starcie
          useEffect(() => {
            const savedGroups = JSON.parse(localStorage.getItem('studentGroups') || '[]');
            setGroups(savedGroups);
            
            // Załaduj oczekujące egzaminy
            const allExams = JSON.parse(localStorage.getItem('exams') || '[]');
            const pending = allExams.filter(e => e.status === 'pending');
            setPendingExams(pending);
          }, []);

          // Funkcje zarządzania grupami
          const createGroup = () => {
            if (!newGroupName.trim()) {
              alert('Podaj nazwę grupy');
              return;
            }
            
            const newGroup = {
              id: Date.now(),
              name: newGroupName,
              createdBy: user.username,
              createdAt: new Date(),
              students: []
            };
            
            const updatedGroups = [...groups, newGroup];
            setGroups(updatedGroups);
            localStorage.setItem('studentGroups', JSON.stringify(updatedGroups));
            setNewGroupName('');
          };

          const deleteGroup = (groupId) => {
            if (confirm('Czy na pewno chcesz usunąć tę grupę?')) {
              const updatedGroups = groups.filter(g => g.id !== groupId);
              setGroups(updatedGroups);
              localStorage.setItem('studentGroups', JSON.stringify(updatedGroups));
            }
          };

          const addStudentToGroup = (groupId, studentId) => {
            const updatedGroups = groups.map(group => {
              if (group.id === groupId) {
                return {
                  ...group,
                  students: [...new Set([...group.students, studentId])]
                };
              }
              return group;
            });
            setGroups(updatedGroups);
            localStorage.setItem('studentGroups', JSON.stringify(updatedGroups));
          };

          const removeStudentFromGroup = (groupId, studentId) => {
            const updatedGroups = groups.map(group => {
              if (group.id === groupId) {
                return {
                  ...group,
                  students: group.students.filter(id => id !== studentId)
                };
              }
              return group;
            });
            setGroups(updatedGroups);
            localStorage.setItem('studentGroups', JSON.stringify(updatedGroups));
          };


          // Funkcja do ładowania bazy danych z pliku JSON
          const handleDatabaseLoad = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
              const text = await file.text();
              const data = JSON.parse(text);
              
              // Sprawdź czy to tablica zadań
              let tasksToLoad = [];
              if (Array.isArray(data)) {
                tasksToLoad = data;
              } else if (data.questions && Array.isArray(data.questions)) {
                // Obsługa formatu quiz_data.json
                tasksToLoad = data.questions.map((question) => ({
                  id: `quiz_2025_${question.id}`,
                  przedmiot: 'egzamin ósmoklasisty',
                  temat: question.type || question.department,
                  tresc: question.question,
                  typ: 'zamkniete',
                  odpowiedzi: [
                    question.options.a,
                    question.options.b,
                    question.options.c,
                    question.options.d
                  ],
                  poprawna: question.correctAnswer.toUpperCase(),
                  punkty: 1,
                  poziom: 'podstawowy',
                  rok: '2025',
                  sesja: 'główna',
                  obrazek: question.hasImage && question.imageSvg ? question.imageSvg : null,
                  wyjaśnienie: question.explanation || null,
                  dział: question.department || null
                }));
              } else {
                throw new Error('Nieprawidłowy format pliku');
              }

              if (tasksToLoad.length === 0) {
                throw new Error('Plik nie zawiera zadań');
              }
              
              // Walidacja struktury zadań
              const invalidTasks = [];
              const validTasks = tasksToLoad.filter((task, index) => {
                const requiredFields = ['id', 'przedmiot', 'temat', 'tresc', 'typ', 'punkty'];
                const missingFields = requiredFields.filter(field => !task[field]);
                
                if (missingFields.length > 0) {
                  invalidTasks.push({
                    index: index + 1,
                    reason: `Brakujące pola: ${missingFields.join(', ')}`
                  });
                  return false;
                }
                
                if (task.typ === 'zamkniete') {
                  if (!task.odpowiedzi || !Array.isArray(task.odpowiedzi) || task.odpowiedzi.length === 0) {
                    invalidTasks.push({
                      index: index + 1,
                      reason: 'Brak odpowiedzi dla zadania zamkniętego'
                    });
                    return false;
                  }
                  if (!task.poprawna) {
                    invalidTasks.push({
                      index: index + 1,
                      reason: 'Brak poprawnej odpowiedzi'
                    });
                    return false;
                  }
                }
                
                return true;
              });
              
              if (invalidTasks.length > 0) {
                const errorMessage = `Znaleziono ${invalidTasks.length} błędnych zadań:\n` +
                  invalidTasks.slice(0, 5).map(err => `Zadanie ${err.index}: ${err.reason}`).join('\n') +
                  (invalidTasks.length > 5 ? `\n... i ${invalidTasks.length - 5} więcej` : '');
                alert(errorMessage);
              }

              // Pobierz istniejące zadania (pomijając usunięte)
              const allExistingTasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]');
              const existingTasks = allExistingTasks.filter(t => !t.deleted);
              
              // Sprawdź duplikaty
              const existingIds = new Set(existingTasks.map(t => t.id));
              const newTasks = validTasks.filter(t => !existingIds.has(t.id));
              
              if (newTasks.length === 0 && validTasks.length > 0) {
                alert('Wszystkie poprawne zadania z tego pliku już istnieją w bazie');
                return;
              }

              // Dodaj nowe zadania
              const allTasks = [...allExistingTasks, ...newTasks];
              localStorage.setItem('zadaniaDB', JSON.stringify(allTasks));
              window.zadania = allTasks.filter(t => !t.deleted);

              const summary = `Raport importu:\n` +
                `- Znaleziono zadań w pliku: ${tasksToLoad.length}\n` +
                `- Poprawnych zadań: ${validTasks.length}\n` +
                `- Duplikatów pominiętych: ${validTasks.length - newTasks.length}\n` +
                `- Dodano nowych zadań: ${newTasks.length}\n` +
                `- Łączna liczba zadań w bazie: ${window.zadania.length}`;
              
              alert(summary);
              
              // Odśwież widok
              setActiveTab('database');
              
            } catch (error) {
              console.error('Błąd ładowania bazy:', error);
              if (error instanceof SyntaxError) {
                alert('Błąd: Nieprawidłowy format JSON. Sprawdź poprawność pliku.');
              } else {
                alert(`Błąd: ${error.message}`);
              }
            }
            
            // Wyczyść input
            event.target.value = '';
          };

          // Funkcja do eksportowania bazy danych
          const handleDatabaseExport = () => {
            try {
              const tasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]');
              const dataStr = JSON.stringify(tasks, null, 2);
              const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
              
              const exportFileDefaultName = `baza-zadan-export-${new Date().toISOString().split('T')[0]}.json`;
              
              const linkElement = document.createElement('a');
              linkElement.setAttribute('href', dataUri);
              linkElement.setAttribute('download', exportFileDefaultName);
              linkElement.click();
              
              alert(`Wyeksportowano ${tasks.length} zadań`);
            } catch (error) {
              console.error('Błąd eksportu:', error);
              alert(`Błąd: ${error.message}`);
            }
          };

          // Funkcja do czyszczenia bazy danych
          const handleDatabaseClear = () => {
            if (confirm('Czy na pewno chcesz usunąć wszystkie zadania z bazy? Ta operacja jest nieodwracalna!')) {
              if (confirm('Czy jesteś absolutnie pewien? Wszystkie zadania zostaną usunięte!')) {
                localStorage.setItem('zadaniaDB', JSON.stringify([]));
                window.zadania = [];
                alert('Baza zadań została wyczyszczona');
                setActiveTab('database');
              }
            }
          };


          const generateExam = () => {
            let questions = window.zadania.filter(z => 
              (selectedSubjects.length === 0 || selectedSubjects.includes(z.przedmiot)) &&
              examConfig.targetCategories.includes(z.przedmiot)
            );
            
            // Losowe mieszanie i wybór zadań
            questions = questions.sort(() => Math.random() - 0.5).slice(0, examConfig.questionsCount);
            
            const exam = {
              id: Date.now(),
              title: `Arkusz egzaminacyjny - ${new Date().toLocaleDateString()}`,
              questions,
              timeLimit: examConfig.timeLimit,
              createdBy: user.username,
              createdAt: new Date(),
              targetCategories: examConfig.targetCategories,
              status: 'pending'
            };
            
            // Zapisz egzamin do localStorage
            const exams = JSON.parse(localStorage.getItem('exams') || '[]');
            exams.push(exam);
            localStorage.setItem('exams', JSON.stringify(exams));
            
            // Zapisz konfigurację arkusza dla banku szablonów
            localStorage.setItem('currentExamConfig', JSON.stringify({
              targetCategories: examConfig.targetCategories,
              questionsCount: examConfig.questionsCount,
              timeLimit: examConfig.timeLimit,
              questionIds: questions.map(q => q.id),
              selectedSubjects
            }));
            
            // Dodaj do listy oczekujących
            setPendingExams([...pendingExams, exam]);
            
            alert('Arkusz został wygenerowany!');
          };

          const sendExamToStudents = (examId, targetGroupId = null) => {
            const exams = JSON.parse(localStorage.getItem('exams') || '[]');
            const examIndex = exams.findIndex(e => e.id === examId);
            
            if (examIndex !== -1) {
              exams[examIndex].status = 'sent';
              exams[examIndex].sentAt = new Date();
              exams[examIndex].targetGroupId = targetGroupId;
              localStorage.setItem('exams', JSON.stringify(exams));
              
              // Powiadom uczniów (symulacja)
              const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
              const users = JSON.parse(localStorage.getItem('users') || '[]');
              let targetStudents = [];
              
              if (targetGroupId && targetGroupId !== 'all') {
                // Wyślij do konkretnej grupy
                const group = groups.find(g => g.id === parseInt(targetGroupId));
                if (group) {
                  targetStudents = users.filter(u => 
                    u.role === 'student' && 
                    group.students.includes(u.id) &&
                    exams[examIndex].targetCategories.includes(u.category)
                  );
                }
              } else {
                // Wyślij do wszystkich uczniów w kategorii
                targetStudents = users.filter(u => 
                  u.role === 'student' && 
                  exams[examIndex].targetCategories.includes(u.category)
                );
              }
              
              targetStudents.forEach(student => {
                notifications.push({
                  id: Date.now() + Math.random(),
                  userId: student.id,
                  examId: examId,
                  message: `Nowy arkusz: ${exams[examIndex].title}`,
                  read: false,
                  createdAt: new Date()
                });
              });
              
              localStorage.setItem('notifications', JSON.stringify(notifications));
              
              // Usuń z listy oczekujących
              setPendingExams(pendingExams.filter(e => e.id !== examId));
              
              const groupName = targetGroupId && targetGroupId !== 'all' 
                ? ` (grupa: ${groups.find(g => g.id === parseInt(targetGroupId))?.name})`
                : '';
              alert(`Arkusz został wysłany do ${targetStudents.length} uczniów${groupName}!`);
            }
          };

          return (
            <div className="container mx-auto p-6">
              <div className="glass-dark rounded-2xl shadow-2xl p-6 mb-6">
                <div className="flex justify-between items-center mb-6">
                  <h1 className="text-3xl font-bold gradient-text">Panel Nauczyciela</h1>
                  <div className="flex items-center gap-4">
                    <span className="text-gray-300">Witaj, {user.username}</span>
                    <button onClick={onLogout} className="text-red-400 hover:text-red-300">
                      <i className="fas fa-sign-out-alt"></i> Wyloguj
                    </button>
                  </div>
                </div>

                <div className="flex space-x-1 mb-6 border-b border-gray-700">
                  <button
                    onClick={() => setActiveTab('dashboard')}
                    className={`tab-modern ${activeTab === 'dashboard' ? 'active' : ''}`}
                  >
                    <i className="fas fa-home mr-2"></i>Panel główny
                  </button>
                  <button
                    onClick={() => setActiveTab('generator')}
                    className={`tab-modern ${activeTab === 'generator' ? 'active' : ''}`}
                  >
                    <i className="fas fa-file-alt mr-2"></i>Generator arkuszy
                  </button>
                  <button
                    onClick={() => setActiveTab('students')}
                    className={`tab-modern ${activeTab === 'students' ? 'active' : ''}`}
                  >
                    <i className="fas fa-user-graduate mr-2"></i>Uczniowie
                  </button>
                  <button
                    onClick={() => setActiveTab('statistics')}
                    className={`tab-modern ${activeTab === 'statistics' ? 'active' : ''}`}
                  >
                    <i className="fas fa-chart-bar mr-2"></i>Statystyki
                  </button>
                  <button
                    onClick={() => setActiveTab('pending')}
                    className={`tab-modern ${activeTab === 'pending' ? 'active' : ''} relative`}
                  >
                    <i className="fas fa-clock mr-2"></i>Oczekujące arkusze
                    {pendingExams.length > 0 && (
                      <span className="notification-badge">{pendingExams.length}</span>
                    )}
                  </button>
                  <button
                    onClick={() => setActiveTab('groups')}
                    className={`tab-modern ${activeTab === 'groups' ? 'active' : ''}`}
                  >
                    <i className="fas fa-users mr-2"></i>Grupy uczniów
                  </button>
                  <button
                    onClick={() => setActiveTab('results')}
                    className={`tab-modern ${activeTab === 'results' ? 'active' : ''}`}
                  >
                    <i className="fas fa-chart-line mr-2"></i>Wyniki
                  </button>
                  
                  {/* Dropdown menu dla pozostałych opcji */}
                  <div className="relative">
                    <button
                      onClick={() => setShowMoreDropdown(!showMoreDropdown)}
                      className={`tab-modern ${['practice', 'database', 'reports', 'pdf-export', 'notifications', 'selector', 'variants', 'templates', 'scheduler', 'cke-import'].includes(activeTab) ? 'active' : ''}`}
                    >
                      <i className="fas fa-ellipsis-h mr-2"></i>Więcej
                      <i className={`fas fa-chevron-down ml-2 transition-transform ${showMoreDropdown ? 'rotate-180' : ''}`}></i>
                    </button>
                    
                    {showMoreDropdown && (
                      <div className="absolute top-full left-0 mt-1 w-64 bg-gray-800 rounded-lg shadow-xl border border-gray-700 z-50">
                        <button
                          onClick={() => {
                            setActiveTab('practice');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center rounded-t-lg"
                        >
                          <i className="fas fa-graduation-cap mr-3 text-blue-400"></i>
                          <span>Tryb testowy</span>
                        </button>
                        <button
                          onClick={() => {
                            setActiveTab('database');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center"
                        >
                          <i className="fas fa-database mr-3 text-green-400"></i>
                          <span>Baza zadań</span>
                        </button>
                        <button
                          onClick={() => {
                            setActiveTab('reports');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center relative"
                        >
                          <i className="fas fa-exclamation-triangle mr-3 text-yellow-400"></i>
                          <span>Zgłoszone zadania</span>
                          {(() => {
                            const reports = JSON.parse(localStorage.getItem('taskReports') || '[]');
                            const unresolvedCount = reports.filter(r => !r.resolved).length;
                            return unresolvedCount > 0 ? (
                              <span className="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded">{unresolvedCount}</span>
                            ) : null;
                          })()}
                        </button>
                        <button
                          onClick={() => {
                            setActiveTab('pdf-export');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center"
                        >
                          <i className="fas fa-file-pdf mr-3 text-red-400"></i>
                          <span>Eksport PDF</span>
                        </button>
                        <button
                          onClick={() => {
                            setActiveTab('notifications');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center"
                        >
                          <i className="fas fa-bell mr-3 text-yellow-400"></i>
                          <span>Powiadomienia</span>
                        </button>
                        <div className="border-t border-gray-700 my-2"></div>
                        <button
                          onClick={() => {
                            setActiveTab('selector');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center"
                        >
                          <i className="fas fa-tasks mr-3 text-purple-400"></i>
                          <span>Wybór zadań</span>
                        </button>
                        <button
                          onClick={() => {
                            setActiveTab('variants');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center"
                        >
                          <i className="fas fa-magic mr-3 text-purple-400"></i>
                          <span>Generator wariantów</span>
                        </button>
                        <button
                          onClick={() => {
                            setActiveTab('templates');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center"
                        >
                          <i className="fas fa-folder-open mr-3 text-purple-400"></i>
                          <span>Bank arkuszy</span>
                        </button>
                        <button
                          onClick={() => {
                            setActiveTab('scheduler');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center"
                        >
                          <i className="fas fa-calendar-alt mr-3 text-purple-400"></i>
                          <span>Harmonogram</span>
                        </button>
                        <button
                          onClick={() => {
                            setActiveTab('cke-import');
                            setShowMoreDropdown(false);
                          }}
                          className="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center rounded-b-lg"
                        >
                          <i className="fas fa-file-import mr-3 text-orange-400"></i>
                          <span>Import CKE</span>
                        </button>
                      </div>
                    )}
                  </div>
                </div>

                {activeTab === 'dashboard' && (
                  <div dangerouslySetInnerHTML={{ 
                    __html: window.teacherEnhancements?.createTeacherDashboard() || '<p>Ładowanie dashboardu...</p>' 
                  }} />
                )}

                {activeTab === 'students' && (
                  <div dangerouslySetInnerHTML={{ 
                    __html: window.teacherEnhancements?.createStudentManagementSystem()?.renderStudentManagementPanel() || '<p>Ładowanie panelu uczniów...</p>' 
                  }} />
                )}

                {activeTab === 'generator' && (
                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">Konfiguracja arkusza</h2>
                      
                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">Kategorie docelowe:</label>
                        <div className="space-y-2">
                          {['egzamin ósmoklasisty', 'matura podstawowa', 'matura rozszerzona'].map(category => (
                            <label key={category} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={examConfig.targetCategories.includes(category)}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setExamConfig({
                                      ...examConfig,
                                      targetCategories: [...examConfig.targetCategories, category]
                                    });
                                  } else {
                                    setExamConfig({
                                      ...examConfig,
                                      targetCategories: examConfig.targetCategories.filter(c => c !== category)
                                    });
                                  }
                                }}
                                className="mr-2"
                              />
                              <span className="capitalize">{category}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">Przedmioty:</label>
                        <div className="space-y-2 max-h-40 overflow-y-auto">
                          {subjects.filter(s => examConfig.targetCategories.includes(s)).map(subject => (
                            <label key={subject} className="flex items-center">
                              <input
                                type="checkbox"
                                value={subject}
                                checked={selectedSubjects.includes(subject)}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setSelectedSubjects([...selectedSubjects, subject]);
                                  } else {
                                    setSelectedSubjects(selectedSubjects.filter(s => s !== subject));
                                  }
                                }}
                                className="mr-2"
                              />
                              <span className="capitalize">{subject}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">
                          Liczba zadań: {examConfig.questionsCount}
                        </label>
                        <input
                          type="range"
                          min="3"
                          max="20"
                          value={examConfig.questionsCount}
                          onChange={(e) => setExamConfig({...examConfig, questionsCount: parseInt(e.target.value)})}
                          className="w-full"
                        />
                      </div>

                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">
                          Czas (minuty): {examConfig.timeLimit}
                        </label>
                        <input
                          type="range"
                          min="10"
                          max="180"
                          step="5"
                          value={examConfig.timeLimit}
                          onChange={(e) => setExamConfig({...examConfig, timeLimit: parseInt(e.target.value)})}
                          className="w-full"
                        />
                      </div>

                      <div className="mb-4">
                        <label className="block text-sm font-medium mb-2">Tryb generowania:</label>
                        <div className="space-y-2">
                          <label className="flex items-center">
                            <input
                              type="radio"
                              name="generationMode"
                              checked={examConfig.randomMode}
                              onChange={() => setExamConfig({...examConfig, randomMode: true})}
                              className="mr-2"
                            />
                            <span>Losowy wybór zadań</span>
                          </label>
                          <label className="flex items-center">
                            <input
                              type="radio"
                              name="generationMode"
                              checked={!examConfig.randomMode}
                              onChange={() => {
                                setExamConfig({...examConfig, randomMode: false});
                                setActiveTab('selector');
                              }}
                              className="mr-2"
                            />
                            <span>Ręczny wybór zadań</span>
                          </label>
                        </div>
                      </div>

                      <button
                        onClick={() => {
                          if (examConfig.randomMode) {
                            generateExam();
                          } else {
                            setActiveTab('selector');
                          }
                        }}
                        className="btn-primary w-full"
                        disabled={examConfig.targetCategories.length === 0}
                      >
                        <i className={`fas ${examConfig.randomMode ? 'fa-magic' : 'fa-hand-pointer'} mr-2`}></i>
                        {examConfig.randomMode ? 'Generuj arkusz' : 'Wybierz zadania'}
                      </button>
                    </div>

                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">Podgląd ostatnich arkuszy</h2>
                      <RecentExams />
                    </div>
                  </div>
                )}


                {activeTab === 'statistics' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Statystyki i analiza</h2>
                    <div className="space-y-6">
                      <AdvancedStatistics />
                      <div className="border-t border-gray-700 pt-6">
                        <ClassAnalytics />
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'pending' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Arkusze oczekujące na wysłanie</h2>
                    {pendingExams.length === 0 ? (
                      <p className="text-gray-400">Brak arkuszy do wysłania</p>
                    ) : (
                      <div className="space-y-4">
                        {pendingExams.map(exam => (
                          <div key={exam.id} className="card-modern">
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <h3 className="font-semibold">{exam.title}</h3>
                                <p className="text-sm text-gray-400">
                                  Zadań: {exam.questions.length} | Czas: {exam.timeLimit} min
                                </p>
                                <p className="text-sm text-gray-400">
                                  Dla: {exam.targetCategories.join(', ')}
                                </p>
                                {exam.sourceFile && (
                                  <p className="text-sm text-gray-400">
                                    <i className="fas fa-file mr-1"></i>Z pliku: {exam.sourceFile}
                                  </p>
                                )}
                              </div>
                              <div className="flex items-center gap-2">
                                <select
                                  value={selectedGroupForExam}
                                  onChange={(e) => setSelectedGroupForExam(e.target.value)}
                                  className="input-modern text-sm"
                                >
                                  <option value="all">Wszyscy w kategorii</option>
                                  {groups.map(group => (
                                    <option key={group.id} value={group.id}>
                                      {group.name} ({group.students.length} uczniów)
                                    </option>
                                  ))}
                                </select>
                                <button
                                  onClick={() => sendExamToStudents(exam.id, selectedGroupForExam)}
                                  className="btn-primary"
                                >
                                  <i className="fas fa-paper-plane mr-2"></i>Wyślij
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'groups' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Zarządzanie grupami uczniów</h2>
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="card-modern">
                        <h3 className="text-lg font-semibold mb-4">Twoje grupy</h3>
                        <div className="mb-4">
                          <div className="flex gap-2">
                            <input
                              type="text"
                              placeholder="Nazwa nowej grupy"
                              value={newGroupName}
                              onChange={(e) => setNewGroupName(e.target.value)}
                              className="input-modern flex-1"
                            />
                            <button
                              onClick={createGroup}
                              className="btn-primary"
                            >
                              <i className="fas fa-plus"></i>
                            </button>
                          </div>
                        </div>
                        
                        {groups.length === 0 ? (
                          <p className="text-gray-400">Nie masz jeszcze żadnych grup</p>
                        ) : (
                          <div className="space-y-3">
                            {groups.map(group => (
                              <div key={group.id} className="p-3 bg-gray-800 rounded flex justify-between items-center">
                                <div>
                                  <h4 className="font-medium">{group.name}</h4>
                                  <p className="text-sm text-gray-400">
                                    Uczniów: {group.students.length}
                                  </p>
                                </div>
                                <button
                                  onClick={() => deleteGroup(group.id)}
                                  className="text-red-400 hover:text-red-300"
                                >
                                  <i className="fas fa-trash"></i>
                                </button>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                      
                      <div className="card-modern">
                        <h3 className="text-lg font-semibold mb-4">Przypisz uczniów do grup</h3>
                        <StudentGroupAssignment
                          groups={groups}
                          onAddStudent={addStudentToGroup}
                          onRemoveStudent={removeStudentFromGroup}
                        />
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'practice' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Tryb testowy - Podgląd</h2>
                    <div className="card-modern">
                      <p className="mb-4 text-gray-300">
                        Przetestuj tryb rozwiązywania zadań dostępny dla uczniów. 
                        Możesz sprawdzić działanie trybu ćwiczeniowego i egzaminacyjnego.
                      </p>
                      
                      <div className="bg-gray-800 p-4 rounded-lg mb-4">
                        <h3 className="font-semibold mb-2">Funkcje trybu testowego:</h3>
                        <ul className="text-sm text-gray-400 space-y-1">
                          <li>• Tryb ćwiczeniowy - z natychmiastową weryfikacją odpowiedzi</li>
                          <li>• Tryb egzaminacyjny - wyniki widoczne dopiero na końcu</li>
                          <li>• Filtrowanie zadań według kategorii i poziomu trudności</li>
                          <li>• Pomiar czasu rozwiązywania</li>
                          <li>• Szczegółowe statystyki wyników</li>
                        </ul>
                      </div>
                      
                      <div className="mb-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                        <p className="text-sm text-blue-300">
                          <i className="fas fa-info-circle mr-2"></i>
                          <strong>Wskazówka:</strong> Uczniowie mają dostęp do tego trybu ze swojego panelu.
                          Możesz przetestować funkcjonalność przed udostępnieniem uczniom.
                        </p>
                      </div>
                      
                      <a
                        href="test-practice.html"
                        target="_blank"
                        className="btn-primary w-full text-center inline-block"
                      >
                        <i className="fas fa-external-link-alt mr-2"></i>
                        Otwórz tryb testowy w nowej karcie
                      </a>
                      
                      <div className="mt-4 grid grid-cols-2 gap-4 text-center">
                        <div className="p-3 bg-gray-800 rounded">
                          <p className="text-2xl font-bold text-purple-400">{zadania.length}</p>
                          <p className="text-sm text-gray-400">Zadań w bazie</p>
                        </div>
                        <div className="p-3 bg-gray-800 rounded">
                          <p className="text-2xl font-bold text-purple-400">
                            {[...new Set(zadania.map(z => z.przedmiot))].length}
                          </p>
                          <p className="text-sm text-gray-400">Kategorii</p>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'database' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Zarządzanie bazą zadań</h2>
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="card-modern">
                        <h3 className="text-lg font-semibold mb-4">Statystyki bazy</h3>
                        <div className="space-y-3">
                          <div className="flex justify-between items-center p-3 bg-gray-800 rounded">
                            <span>Łączna liczba zadań:</span>
                            <span className="font-bold text-purple-400">{zadania.length}</span>
                          </div>
                          <div className="flex justify-between items-center p-3 bg-gray-800 rounded">
                            <span>Egzamin ósmoklasisty:</span>
                            <span className="font-bold">{zadania.filter(z => z.przedmiot === 'egzamin ósmoklasisty').length}</span>
                          </div>
                          <div className="flex justify-between items-center p-3 bg-gray-800 rounded">
                            <span>Matura podstawowa:</span>
                            <span className="font-bold">{zadania.filter(z => z.przedmiot === 'matura podstawowa').length}</span>
                          </div>
                          <div className="flex justify-between items-center p-3 bg-gray-800 rounded">
                            <span>Matura rozszerzona:</span>
                            <span className="font-bold">{zadania.filter(z => z.przedmiot === 'matura rozszerzona').length}</span>
                          </div>
                        </div>
                      </div>

                      <div className="card-modern">
                        <h3 className="text-lg font-semibold mb-4">Zarządzanie danymi</h3>
                        <div className="space-y-4">
                          <div>
                            <h4 className="font-medium mb-2">Załaduj bazę zadań</h4>
                            <p className="text-sm text-gray-400 mb-3">
                              Importuj zadania z pliku JSON. System automatycznie sprawdzi poprawność danych.
                            </p>
                            <div className="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-purple-500 transition mb-3">
                              <input
                                type="file"
                                accept=".json"
                                onChange={handleDatabaseLoad}
                                className="hidden"
                                id="databaseFileInput"
                              />
                              <label
                                htmlFor="databaseFileInput"
                                className="cursor-pointer"
                              >
                                <i className="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2 block"></i>
                                <p className="text-sm mb-2">Przeciągnij plik JSON lub kliknij</p>
                                <span className="btn-primary inline-block">
                                  <i className="fas fa-folder-open mr-2"></i>Wybierz plik
                                </span>
                              </label>
                            </div>
                            <div className="text-xs text-gray-500">
                              <p className="mb-1">Wspierane formaty:</p>
                              <ul className="list-disc list-inside">
                                <li>Standardowy format QuizMaster</li>
                                <li>quiz_data.json (automatyczna konwersja)</li>
                                <li>Tablice zadań w formacie JSON</li>
                              </ul>
                            </div>
                          </div>

                          <div>
                            <h4 className="font-medium mb-2">Eksportuj bazę zadań</h4>
                            <p className="text-sm text-gray-400 mb-3">
                              Zapisz obecną bazę zadań do pliku JSON
                            </p>
                            <button
                              onClick={handleDatabaseExport}
                              className="btn-secondary"
                            >
                              <i className="fas fa-download mr-2"></i>Eksportuj bazę
                            </button>
                          </div>

                          <div>
                            <h4 className="font-medium mb-2">Wyczyść bazę</h4>
                            <p className="text-sm text-gray-400 mb-3">
                              Usuń wszystkie zadania z bazy (operacja nieodwracalna)
                            </p>
                            <button
                              onClick={handleDatabaseClear}
                              className="btn-secondary text-red-400 border-red-400 hover:bg-red-400 hover:text-white"
                            >
                              <i className="fas fa-trash-alt mr-2"></i>Wyczyść bazę
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="mt-6 card-modern">
                      <h3 className="text-lg font-semibold mb-4">Ostatnio dodane zadania</h3>
                      <div className="space-y-2 max-h-64 overflow-y-auto">
                        {zadania.slice(-10).reverse().map((zadanie, index) => (
                          <div key={zadanie.id} className="p-3 bg-gray-800 rounded">
                            <p className="font-medium text-sm">{zadanie.przedmiot} - {zadanie.temat}</p>
                            <p className="text-xs text-gray-400">{zadanie.tresc.substring(0, 100)}...</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'reports' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Zgłoszone zadania</h2>
                    <ReportedTasksPanel user={user} />
                  </div>
                )}

                {activeTab === 'selector' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Ręczny wybór zadań do arkusza</h2>
                    <TaskSelector 
                      tasks={zadania.filter(z => !z.deleted && examConfig.targetCategories.includes(z.przedmiot))}
                      selectedTasks={selectedTasks}
                      onTasksChange={setSelectedTasks}
                      onCreateExam={(tasks) => {
                        const exam = {
                          id: Date.now(),
                          title: `Arkusz egzaminacyjny (ręczny wybór) - ${new Date().toLocaleDateString()}`,
                          questions: tasks,
                          timeLimit: examConfig.timeLimit,
                          createdBy: user.username,
                          createdAt: new Date(),
                          targetCategories: examConfig.targetCategories,
                          status: 'pending',
                          manualSelection: true
                        };
                        
                        const exams = JSON.parse(localStorage.getItem('exams') || '[]');
                        exams.push(exam);
                        localStorage.setItem('exams', JSON.stringify(exams));
                        
                        setPendingExams([...pendingExams, exam]);
                        setSelectedTasks([]);
                        setActiveTab('pending');
                        
                        alert(`Arkusz z ${tasks.length} wybranymi zadaniami został utworzony!`);
                      }}
                      examConfig={examConfig}
                    />
                  </div>
                )}

                {activeTab === 'variants' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Generator wariantów zadań</h2>
                    <VariantGeneratorTab user={user} />
                  </div>
                )}

                {activeTab === 'templates' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Bank arkuszy</h2>
                    <ExamTemplatesBankTab user={user} />
                  </div>
                )}

                {activeTab === 'scheduler' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Harmonogram</h2>
                    <ExamSchedulerTab user={user} />
                  </div>
                )}

                {activeTab === 'cke-import' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Import zadań z arkuszy CKE</h2>
                    <div dangerouslySetInnerHTML={{ 
                      __html: window.CKEImportUI ? new window.CKEImportUI().render() : '<p>Ładowanie modułu importu CKE...</p>' 
                    }} />
                  </div>
                )}

                {activeTab === 'results' && (
                  <div>
                    <h2 className="text-xl font-semibold mb-4">Wyniki uczniów i rekomendacje</h2>
                    <TeacherResultsView />
                  </div>
                )}

                {activeTab === 'pdf-export' && (
                  <div>
                    <h2 className="text-2xl font-bold mb-6">Eksport do PDF</h2>
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="card-modern">
                        <h3 className="text-xl font-semibold mb-4">
                          <i className="fas fa-user-graduate text-blue-400 mr-2"></i>
                          Raporty uczniów
                        </h3>
                        <p className="text-gray-400 mb-4">
                          Eksportuj szczegółowe raporty wyników dla wybranych uczniów
                        </p>
                        <button 
                          onClick={() => window.navigationIntegration?.exportStudentReports()}
                          className="btn-primary w-full"
                        >
                          <i className="fas fa-download mr-2"></i>
                          Generuj raporty
                        </button>
                      </div>

                      <div className="card-modern">
                        <h3 className="text-xl font-semibold mb-4">
                          <i className="fas fa-users text-green-400 mr-2"></i>
                          Raport klasowy
                        </h3>
                        <p className="text-gray-400 mb-4">
                          Generuj zbiorczy raport dla całej klasy lub grupy
                        </p>
                        <button 
                          onClick={() => window.navigationIntegration?.exportClassReport()}
                          className="btn-primary w-full"
                        >
                          <i className="fas fa-file-pdf mr-2"></i>
                          Eksportuj raport
                        </button>
                      </div>

                      <div className="card-modern">
                        <h3 className="text-xl font-semibold mb-4">
                          <i className="fas fa-certificate text-yellow-400 mr-2"></i>
                          Certyfikaty
                        </h3>
                        <p className="text-gray-400 mb-4">
                          Generuj certyfikaty ukończenia dla uczniów
                        </p>
                        <button 
                          onClick={() => window.navigationIntegration?.exportCertificates()}
                          className="btn-primary w-full"
                        >
                          <i className="fas fa-award mr-2"></i>
                          Utwórz certyfikaty
                        </button>
                      </div>

                      <div className="card-modern">
                        <h3 className="text-xl font-semibold mb-4">
                          <i className="fas fa-file-export text-purple-400 mr-2"></i>
                          Eksport arkuszy
                        </h3>
                        <p className="text-gray-400 mb-4">
                          Eksportuj arkusze egzaminacyjne do PDF
                        </p>
                        <button 
                          onClick={() => {
                            const exams = JSON.parse(localStorage.getItem('exams') || '[]');
                            if (exams.length === 0) {
                              alert('Brak arkuszy do eksportu');
                              return;
                            }
                            window.navigationIntegration?.modules?.pdfExport?.generateExamPDF(exams[0]);
                          }}
                          className="btn-primary w-full"
                        >
                          <i className="fas fa-print mr-2"></i>
                          Eksportuj arkusze
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'notifications' && (
                  <div>
                    <h2 className="text-2xl font-bold mb-6">Ustawienia powiadomień</h2>
                    <div className="max-w-2xl mx-auto">
                      <div id="notification-settings-teacher">
                        {window.navigationIntegration?.modules?.pushNotifications ? 
                          <div dangerouslySetInnerHTML={{ 
                            __html: window.navigationIntegration.modules.pushNotifications.createSettingsComponent() 
                          }} />
                        : 
                          <p className="text-gray-400">Ładowanie ustawień...</p>
                        }
                      </div>
                      
                      <div className="card-modern mt-6">
                        <h3 className="text-xl font-semibold mb-4">
                          <i className="fas fa-calendar-check text-green-400 mr-2"></i>
                          Planowanie powiadomień
                        </h3>
                        <p className="text-gray-400 mb-4">
                          Zaplanuj automatyczne powiadomienia o nadchodzących egzaminach
                        </p>
                        <button 
                          onClick={() => {
                            window.navigationIntegration?.modules?.pushNotifications?.scheduleNotifications();
                            alert('Powiadomienia zostały zaplanowane');
                          }}
                          className="btn-primary"
                        >
                          <i className="fas fa-clock mr-2"></i>
                          Zaplanuj powiadomienia
                        </button>
                      </div>

                      <div className="card-modern mt-6">
                        <h3 className="text-xl font-semibold mb-4">
                          <i className="fas fa-bullhorn text-blue-400 mr-2"></i>
                          Wyślij powiadomienie
                        </h3>
                        <div className="space-y-4">
                          <input 
                            type="text" 
                            id="notification-title"
                            placeholder="Tytuł powiadomienia"
                            className="input-modern w-full"
                          />
                          <textarea 
                            id="notification-body"
                            placeholder="Treść powiadomienia"
                            className="input-modern w-full h-24"
                          ></textarea>
                          <button 
                            onClick={() => {
                              const title = document.getElementById('notification-title').value;
                              const body = document.getElementById('notification-body').value;
                              if (title && body) {
                                window.navigationIntegration?.modules?.pushNotifications?.showNotification(title, { body });
                                alert('Powiadomienie wysłane');
                              } else {
                                alert('Wypełnij wszystkie pola');
                              }
                            }}
                            className="btn-primary w-full"
                          >
                            <i className="fas fa-paper-plane mr-2"></i>
                            Wyślij teraz
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        // Komponent wyboru zadań
        function TaskSelector({ tasks, selectedTasks, onTasksChange, onCreateExam, examConfig }) {
          const [filterTopic, setFilterTopic] = useState('');
          const [filterType, setFilterType] = useState('all');
          const [searchQuery, setSearchQuery] = useState('');
          const [currentPage, setCurrentPage] = useState(0);
          const tasksPerPage = 10;
          
          const topics = [...new Set(tasks.map(t => t.temat))];
          
          const filteredTasks = tasks.filter(task => {
            if (filterTopic && task.temat !== filterTopic) return false;
            if (filterType !== 'all' && task.typ !== filterType) return false;
            if (searchQuery) {
              const query = searchQuery.toLowerCase();
              return task.tresc.toLowerCase().includes(query) || 
                     task.temat.toLowerCase().includes(query);
            }
            return true;
          });
          
          const totalPages = Math.ceil(filteredTasks.length / tasksPerPage);
          const paginatedTasks = filteredTasks.slice(
            currentPage * tasksPerPage,
            (currentPage + 1) * tasksPerPage
          );
          
          const toggleTask = (taskId) => {
            if (selectedTasks.includes(taskId)) {
              onTasksChange(selectedTasks.filter(id => id !== taskId));
            } else {
              onTasksChange([...selectedTasks, taskId]);
            }
          };
          
          const selectedTaskObjects = tasks.filter(t => selectedTasks.includes(t.id));
          
          return (
            <div className="grid md:grid-cols-3 gap-6">
              <div className="md:col-span-2">
                <div className="card-modern mb-4">
                  <h3 className="text-lg font-semibold mb-4">Filtry</h3>
                  <div className="grid md:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Temat</label>
                      <select
                        value={filterTopic}
                        onChange={(e) => {
                          setFilterTopic(e.target.value);
                          setCurrentPage(0);
                        }}
                        className="input-modern w-full text-sm"
                      >
                        <option value="">Wszystkie tematy</option>
                        {topics.map(topic => (
                          <option key={topic} value={topic}>{topic}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Typ zadania</label>
                      <select
                        value={filterType}
                        onChange={(e) => {
                          setFilterType(e.target.value);
                          setCurrentPage(0);
                        }}
                        className="input-modern w-full text-sm"
                      >
                        <option value="all">Wszystkie typy</option>
                        <option value="zamkniete">Zamknięte</option>
                        <option value="otwarte">Otwarte</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Szukaj</label>
                      <input
                        type="text"
                        value={searchQuery}
                        onChange={(e) => {
                          setSearchQuery(e.target.value);
                          setCurrentPage(0);
                        }}
                        placeholder="Szukaj w treści..."
                        className="input-modern w-full text-sm"
                      />
                    </div>
                  </div>
                </div>
                
                <div className="card-modern">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-semibold">Dostępne zadania ({filteredTasks.length})</h3>
                    {totalPages > 1 && (
                      <div className="flex gap-2">
                        <button
                          onClick={() => setCurrentPage(Math.max(0, currentPage - 1))}
                          disabled={currentPage === 0}
                          className="btn-secondary text-sm disabled:opacity-50"
                        >
                          <i className="fas fa-chevron-left"></i>
                        </button>
                        <span className="text-sm self-center">
                          {currentPage + 1} / {totalPages}
                        </span>
                        <button
                          onClick={() => setCurrentPage(Math.min(totalPages - 1, currentPage + 1))}
                          disabled={currentPage === totalPages - 1}
                          className="btn-secondary text-sm disabled:opacity-50"
                        >
                          <i className="fas fa-chevron-right"></i>
                        </button>
                      </div>
                    )}
                  </div>
                  
                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {paginatedTasks.map(task => (
                      <div 
                        key={task.id} 
                        className={`p-4 bg-gray-800 rounded cursor-pointer transition ${
                          selectedTasks.includes(task.id) ? 'ring-2 ring-purple-500' : 'hover:bg-gray-700'
                        }`}
                        onClick={() => toggleTask(task.id)}
                      >
                        <div className="flex items-start gap-3">
                          <input
                            type="checkbox"
                            checked={selectedTasks.includes(task.id)}
                            onChange={() => {}}
                            className="mt-1"
                          />
                          <div className="flex-1">
                            <div className="flex justify-between items-start mb-2">
                              <span className="font-medium">{task.temat}</span>
                              <span className="text-sm text-gray-400">{task.punkty} pkt</span>
                            </div>
                            <p className="text-sm mb-2">{task.tresc}</p>
                            {task.typ === 'zamkniete' && (
                              <div className="text-xs text-gray-400">
                                Odpowiedzi: {task.odpowiedzi.join(', ')}
                              </div>
                            )}
                            <div className="flex gap-2 mt-2">
                              <span className="text-xs bg-purple-600/20 text-purple-300 px-2 py-1 rounded">
                                {task.typ === 'zamkniete' ? 'Zamknięte' : 'Otwarte'}
                              </span>
                              <span className="text-xs bg-blue-600/20 text-blue-300 px-2 py-1 rounded">
                                {task.poziom || 'podstawowy'}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              
              <div className="md:col-span-1">
                <div className="card-modern sticky top-6">
                  <h3 className="text-lg font-semibold mb-4">Wybrane zadania ({selectedTasks.length})</h3>
                  
                  {selectedTasks.length === 0 ? (
                    <p className="text-gray-400 text-center py-8">Wybierz zadania z listy</p>
                  ) : (
                    <>
                      <div className="space-y-2 max-h-64 overflow-y-auto mb-4">
                        {selectedTaskObjects.map((task, index) => (
                          <div key={task.id} className="p-2 bg-gray-800 rounded text-sm">
                            <div className="flex justify-between items-start">
                              <span className="font-medium">{index + 1}. {task.temat}</span>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  toggleTask(task.id);
                                }}
                                className="text-red-400 hover:text-red-300"
                              >
                                <i className="fas fa-times"></i>
                              </button>
                            </div>
                            <p className="text-xs text-gray-400 mt-1">
                              {task.typ === 'zamkniete' ? 'Zamknięte' : 'Otwarte'} - {task.punkty} pkt
                            </p>
                          </div>
                        ))}
                      </div>
                      
                      <div className="border-t border-gray-700 pt-4">
                        <div className="text-sm text-gray-400 mb-4">
                          <p>Liczba zadań: {selectedTasks.length}</p>
                          <p>Liczba punktów: {selectedTaskObjects.reduce((sum, t) => sum + t.punkty, 0)}</p>
                          <p>Szacowany czas: {Math.round(selectedTasks.length * 3)} min</p>
                        </div>
                        
                        <button
                          onClick={() => onCreateExam(selectedTaskObjects)}
                          className="btn-primary w-full"
                          disabled={selectedTasks.length === 0}
                        >
                          <i className="fas fa-check mr-2"></i>
                          Utwórz arkusz
                        </button>
                        
                        <button
                          onClick={() => onTasksChange([])}
                          className="btn-secondary w-full mt-2"
                        >
                          <i className="fas fa-times mr-2"></i>
                          Wyczyść wybór
                        </button>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // Komponent banku arkuszy dla nauczyciela
        function ExamTemplatesBankTab({ user }) {
          const [templates, setTemplates] = useState([]);
          const [sharedTemplates, setSharedTemplates] = useState([]);
          const [searchQuery, setSearchQuery] = useState('');
          const [filterCategory, setFilterCategory] = useState('all');
          const [sortBy, setSortBy] = useState('date');
          const [showSaveDialog, setShowSaveDialog] = useState(false);
          const [templateName, setTemplateName] = useState('');
          const [templateDescription, setTemplateDescription] = useState('');

          // Załaduj szablony przy montowaniu
          useEffect(() => {
            loadTemplates();
            loadSharedTemplates();
          }, []);

          const loadTemplates = () => {
            const saved = localStorage.getItem(`examTemplates_${user.id}`);
            if (saved) {
              setTemplates(JSON.parse(saved));
            }
          };

          const loadSharedTemplates = () => {
            // W rzeczywistej aplikacji byłoby to pobierane z serwera
            const shared = localStorage.getItem('sharedExamTemplates');
            if (shared) {
              setSharedTemplates(JSON.parse(shared));
            }
          };

          const saveTemplate = () => {
            const currentExam = JSON.parse(localStorage.getItem('currentExamConfig') || '{}');
            const newTemplate = {
              id: Date.now(),
              name: templateName,
              description: templateDescription,
              config: currentExam,
              createdAt: new Date().toISOString(),
              author: user.nazwa,
              authorId: user.id,
              downloads: 0,
              rating: 0,
              ratings: [],
              isShared: false
            };

            const updatedTemplates = [...templates, newTemplate];
            setTemplates(updatedTemplates);
            localStorage.setItem(`examTemplates_${user.id}`, JSON.stringify(updatedTemplates));
            
            setShowSaveDialog(false);
            setTemplateName('');
            setTemplateDescription('');
            alert('Szablon został zapisany');
          };

          const useTemplate = (template) => {
            localStorage.setItem('currentExamConfig', JSON.stringify(template.config));
            alert('Szablon został załadowany');
            // Przekieruj do generatora arkuszy
            window.location.reload();
          };

          const deleteTemplate = (templateId) => {
            if (confirm('Czy na pewno chcesz usunąć ten szablon?')) {
              const updatedTemplates = templates.filter(t => t.id !== templateId);
              setTemplates(updatedTemplates);
              localStorage.setItem(`examTemplates_${user.id}`, JSON.stringify(updatedTemplates));
              alert('Szablon został usunięty');
            }
          };

          const toggleShareTemplate = (templateId) => {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            template.isShared = !template.isShared;
            
            if (template.isShared) {
              // Dodaj do udostępnionych
              const allShared = JSON.parse(localStorage.getItem('sharedExamTemplates') || '[]');
              allShared.push(template);
              localStorage.setItem('sharedExamTemplates', JSON.stringify(allShared));
              alert('Szablon został udostępniony');
            } else {
              // Usuń z udostępnionych
              const allShared = JSON.parse(localStorage.getItem('sharedExamTemplates') || '[]');
              const filtered = allShared.filter(t => t.id !== templateId);
              localStorage.setItem('sharedExamTemplates', JSON.stringify(filtered));
              alert('Cofnięto udostępnienie szablonu');
            }

            const updatedTemplates = [...templates];
            setTemplates(updatedTemplates);
            localStorage.setItem(`examTemplates_${user.id}`, JSON.stringify(updatedTemplates));
            loadSharedTemplates();
          };

          const downloadSharedTemplate = (template) => {
            // Zwiększ liczbę pobrań
            template.downloads++;
            const allShared = JSON.parse(localStorage.getItem('sharedExamTemplates') || '[]');
            const index = allShared.findIndex(t => t.id === template.id);
            if (index !== -1) {
              allShared[index] = template;
              localStorage.setItem('sharedExamTemplates', JSON.stringify(allShared));
            }

            // Dodaj do własnych szablonów
            const newTemplate = {
              ...template,
              id: Date.now(),
              isShared: false,
              downloads: 0,
              rating: 0,
              ratings: [],
              downloadedFrom: template.author,
              downloadedAt: new Date().toISOString()
            };

            const updatedTemplates = [...templates, newTemplate];
            setTemplates(updatedTemplates);
            localStorage.setItem(`examTemplates_${user.id}`, JSON.stringify(updatedTemplates));
            
            alert('Szablon został pobrany');
            loadSharedTemplates();
          };

          const rateTemplate = (templateId, rating) => {
            const allShared = JSON.parse(localStorage.getItem('sharedExamTemplates') || '[]');
            const template = allShared.find(t => t.id === templateId);
            
            if (template) {
              // Sprawdź czy użytkownik już ocenił
              const existingRating = template.ratings.find(r => r.userId === user.id);
              if (existingRating) {
                existingRating.rating = rating;
              } else {
                template.ratings.push({ userId: user.id, rating });
              }
              
              // Oblicz średnią ocenę
              template.rating = template.ratings.reduce((sum, r) => sum + r.rating, 0) / template.ratings.length;
              
              localStorage.setItem('sharedExamTemplates', JSON.stringify(allShared));
              loadSharedTemplates();
              alert('Dziękujemy za ocenę');
            }
          };

          // Filtrowanie i sortowanie szablonów
          const filteredSharedTemplates = sharedTemplates
            .filter(template => {
              if (filterCategory !== 'all' && !template.config.targetCategories?.includes(filterCategory)) {
                return false;
              }
              if (searchQuery) {
                const query = searchQuery.toLowerCase();
                return template.name.toLowerCase().includes(query) ||
                       template.description.toLowerCase().includes(query) ||
                       template.author.toLowerCase().includes(query);
              }
              return true;
            })
            .sort((a, b) => {
              switch (sortBy) {
                case 'rating':
                  return b.rating - a.rating;
                case 'downloads':
                  return b.downloads - a.downloads;
                case 'date':
                default:
                  return new Date(b.createdAt) - new Date(a.createdAt);
              }
            });

          const bankStats = {
            totalTemplates: sharedTemplates.length,
            totalDownloads: sharedTemplates.reduce((sum, t) => sum + t.downloads, 0),
            averageRating: sharedTemplates.length > 0 
              ? (sharedTemplates.reduce((sum, t) => sum + t.rating, 0) / sharedTemplates.length).toFixed(1)
              : 0,
            topContributors: Object.entries(
              sharedTemplates.reduce((acc, t) => {
                acc[t.author] = (acc[t.author] || 0) + 1;
                return acc;
              }, {})
            ).sort((a, b) => b[1] - a[1]).slice(0, 5)
          };

          return (
            <div className="space-y-6">
              {/* Pasek akcji */}
              <div className="flex justify-between items-center mb-6">
                <button
                  onClick={() => setShowSaveDialog(true)}
                  className="btn-primary"
                  disabled={!localStorage.getItem('currentExamConfig')}
                >
                  <i className="fas fa-save mr-2"></i>
                  Zapisz aktualny arkusz jako szablon
                </button>
              </div>

              {/* Zakładki */}
              <div className="flex space-x-4 border-b border-gray-700">
                <button
                  className={`pb-2 px-4 ${filterCategory === 'all' ? 'border-b-2 border-purple-500 text-purple-500' : ''}`}
                  onClick={() => setFilterCategory('all')}
                >
                  Wszystkie szablony
                </button>
                <button
                  className={`pb-2 px-4 ${filterCategory === 'own' ? 'border-b-2 border-purple-500 text-purple-500' : ''}`}
                  onClick={() => setFilterCategory('own')}
                >
                  Moje szablony ({templates.length})
                </button>
                <button
                  className={`pb-2 px-4 ${filterCategory === 'shared' ? 'border-b-2 border-purple-500 text-purple-500' : ''}`}
                  onClick={() => setFilterCategory('shared')}
                >
                  Udostępnione ({sharedTemplates.length})
                </button>
              </div>

              {/* Sekcja własnych szablonów */}
              {(filterCategory === 'all' || filterCategory === 'own') && (
                <div className="card-modern">
                  <h3 className="text-lg font-semibold mb-4">Moje szablony</h3>
                  {templates.length === 0 ? (
                    <p className="text-gray-400 text-center py-8">
                      Nie masz jeszcze żadnych zapisanych szablonów
                    </p>
                  ) : (
                    <div className="grid gap-4">
                      {templates.map(template => (
                        <div key={template.id} className="bg-gray-800 rounded-lg p-4">
                          <div className="flex justify-between items-start">
                            <div className="flex-1">
                              <h4 className="font-semibold mb-1">{template.name}</h4>
                              <p className="text-sm text-gray-400 mb-2">{template.description}</p>
                              <div className="flex items-center text-xs text-gray-500 space-x-4">
                                <span>
                                  <i className="fas fa-calendar mr-1"></i>
                                  {new Date(template.createdAt).toLocaleDateString()}
                                </span>
                                {template.downloadedFrom && (
                                  <span>
                                    <i className="fas fa-download mr-1"></i>
                                    Pobrano od: {template.downloadedFrom}
                                  </span>
                                )}
                                {template.isShared && (
                                  <span className="text-green-400">
                                    <i className="fas fa-share mr-1"></i>
                                    Udostępniony
                                  </span>
                                )}
                              </div>
                            </div>
                            <div className="flex space-x-2 ml-4">
                              <button
                                onClick={() => useTemplate(template)}
                                className="btn-sm bg-blue-600 hover:bg-blue-700"
                                title="Użyj szablonu"
                              >
                                <i className="fas fa-play"></i>
                              </button>
                              <button
                                onClick={() => toggleShareTemplate(template.id)}
                                className={`btn-sm ${template.isShared ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}`}
                                title={template.isShared ? 'Cofnij udostępnienie' : 'Udostępnij'}
                              >
                                <i className="fas fa-share"></i>
                              </button>
                              <button
                                onClick={() => deleteTemplate(template.id)}
                                className="btn-sm bg-red-600 hover:bg-red-700"
                                title="Usuń szablon"
                              >
                                <i className="fas fa-trash"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Sekcja udostępnionych szablonów */}
              {(filterCategory === 'all' || filterCategory === 'shared') && (
                <div className="card-modern">
                  <h3 className="text-lg font-semibold mb-4">Przeglądarka udostępnionych szablonów</h3>
                  
                  {/* Filtry i wyszukiwarka */}
                  <div className="grid md:grid-cols-3 gap-4 mb-6">
                    <input
                      type="text"
                      placeholder="Szukaj szablonów..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="input-modern"
                    />
                    <select
                      value={filterCategory}
                      onChange={(e) => setFilterCategory(e.target.value)}
                      className="input-modern"
                    >
                      <option value="all">Wszystkie kategorie</option>
                      <option value="egzamin ósmoklasisty">Egzamin ósmoklasisty</option>
                      <option value="matura podstawowa">Matura podstawowa</option>
                      <option value="matura rozszerzona">Matura rozszerzona</option>
                    </select>
                    <select
                      value={sortBy}
                      onChange={(e) => setSortBy(e.target.value)}
                      className="input-modern"
                    >
                      <option value="date">Najnowsze</option>
                      <option value="rating">Najlepiej oceniane</option>
                      <option value="downloads">Najpopularniejsze</option>
                    </select>
                  </div>

                  {filteredSharedTemplates.length === 0 ? (
                    <p className="text-gray-400 text-center py-8">
                      Nie znaleziono szablonów spełniających kryteria
                    </p>
                  ) : (
                    <div className="grid gap-4">
                      {filteredSharedTemplates.map(template => (
                        <div key={template.id} className="bg-gray-800 rounded-lg p-4">
                          <div className="flex justify-between items-start">
                            <div className="flex-1">
                              <h4 className="font-semibold mb-1">{template.name}</h4>
                              <p className="text-sm text-gray-400 mb-2">{template.description}</p>
                              <div className="flex items-center text-xs text-gray-500 space-x-4">
                                <span>
                                  <i className="fas fa-user mr-1"></i>
                                  {template.author}
                                </span>
                                <span>
                                  <i className="fas fa-calendar mr-1"></i>
                                  {new Date(template.createdAt).toLocaleDateString()}
                                </span>
                                <span>
                                  <i className="fas fa-download mr-1"></i>
                                  {template.downloads} pobrań
                                </span>
                                <span className="flex items-center">
                                  <i className="fas fa-star mr-1 text-yellow-400"></i>
                                  {template.rating.toFixed(1)} ({template.ratings.length})
                                </span>
                              </div>
                            </div>
                            <div className="flex items-center space-x-2 ml-4">
                              {/* Ocena */}
                              <div className="flex items-center space-x-1">
                                {[1, 2, 3, 4, 5].map(star => (
                                  <button
                                    key={star}
                                    onClick={() => rateTemplate(template.id, star)}
                                    className={`text-lg ${star <= template.rating ? 'text-yellow-400' : 'text-gray-600'} hover:text-yellow-400`}
                                    disabled={template.authorId === user.id}
                                  >
                                    <i className="fas fa-star"></i>
                                  </button>
                                ))}
                              </div>
                              <button
                                onClick={() => downloadSharedTemplate(template)}
                                className="btn-sm bg-purple-600 hover:bg-purple-700"
                                title="Pobierz szablon"
                                disabled={template.authorId === user.id}
                              >
                                <i className="fas fa-download"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Statystyki banku */}
              <div className="card-modern">
                <h3 className="text-lg font-semibold mb-4">Statystyki banku arkuszy</h3>
                <div className="grid md:grid-cols-4 gap-4">
                  <div className="bg-gray-800 rounded-lg p-4 text-center">
                    <div className="text-2xl font-bold text-purple-400">{bankStats.totalTemplates}</div>
                    <div className="text-sm text-gray-400">Szablonów</div>
                  </div>
                  <div className="bg-gray-800 rounded-lg p-4 text-center">
                    <div className="text-2xl font-bold text-blue-400">{bankStats.totalDownloads}</div>
                    <div className="text-sm text-gray-400">Pobrań</div>
                  </div>
                  <div className="bg-gray-800 rounded-lg p-4 text-center">
                    <div className="text-2xl font-bold text-yellow-400">{bankStats.averageRating}</div>
                    <div className="text-sm text-gray-400">Średnia ocena</div>
                  </div>
                  <div className="bg-gray-800 rounded-lg p-4">
                    <div className="text-sm font-semibold mb-2">Top autorzy:</div>
                    <div className="text-xs space-y-1">
                      {bankStats.topContributors.map(([author, count], idx) => (
                        <div key={author} className="flex justify-between">
                          <span>{idx + 1}. {author}</span>
                          <span className="text-gray-400">{count}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              {/* Dialog zapisywania szablonu */}
              {showSaveDialog && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-gray-900 rounded-lg p-6 max-w-md w-full">
                    <h3 className="text-xl font-semibold mb-4">Zapisz szablon arkusza</h3>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-2">Nazwa szablonu</label>
                        <input
                          type="text"
                          value={templateName}
                          onChange={(e) => setTemplateName(e.target.value)}
                          placeholder="np. Arkusz - Funkcje kwadratowe"
                          className="input-modern w-full"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-2">Opis</label>
                        <textarea
                          value={templateDescription}
                          onChange={(e) => setTemplateDescription(e.target.value)}
                          placeholder="Opisz zawartość szablonu..."
                          rows="3"
                          className="input-modern w-full"
                        />
                      </div>
                      <div className="flex justify-end space-x-3">
                        <button
                          onClick={() => {
                            setShowSaveDialog(false);
                            setTemplateName('');
                            setTemplateDescription('');
                          }}
                          className="btn-secondary"
                        >
                          Anuluj
                        </button>
                        <button
                          onClick={saveTemplate}
                          className="btn-primary"
                          disabled={!templateName.trim()}
                        >
                          Zapisz
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // Komponent harmonogramu dla nauczyciela
        function ExamSchedulerTab({ user }) {
          const [events, setEvents] = useState([]);
          const [selectedDate, setSelectedDate] = useState(new Date());
          const [currentMonth, setCurrentMonth] = useState(new Date());
          const [showEventDialog, setShowEventDialog] = useState(false);
          const [editingEvent, setEditingEvent] = useState(null);
          const [eventForm, setEventForm] = useState({
            title: '',
            type: 'exam', // exam, quiz, homework
            date: '',
            time: '',
            duration: 60,
            description: '',
            class: '',
            reminder: true,
            reminderDays: 1
          });

          // Załaduj wydarzenia przy montowaniu
          useEffect(() => {
            loadEvents();
          }, [user]);

          const loadEvents = () => {
            const savedEvents = localStorage.getItem(`examSchedule_${user.id}`);
            if (savedEvents) {
              setEvents(JSON.parse(savedEvents));
            }
          };

          const saveEvents = (newEvents) => {
            setEvents(newEvents);
            localStorage.setItem(`examSchedule_${user.id}`, JSON.stringify(newEvents));
          };

          // Funkcje kalendarza
          const getDaysInMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const days = [];
            
            // Dodaj puste dni na początku
            for (let i = 0; i < startingDayOfWeek; i++) {
              days.push(null);
            }
            
            // Dodaj dni miesiąca
            for (let i = 1; i <= daysInMonth; i++) {
              days.push(new Date(year, month, i));
            }
            
            return days;
          };

          const getEventsForDate = (date) => {
            if (!date) return [];
            return events.filter(event => {
              const eventDate = new Date(event.date);
              return eventDate.toDateString() === date.toDateString();
            });
          };

          const formatEventTime = (event) => {
            const time = event.time || '00:00';
            return time;
          };

          const getEventTypeIcon = (type) => {
            switch(type) {
              case 'exam': return 'fa-file-alt';
              case 'quiz': return 'fa-clipboard-check';
              case 'homework': return 'fa-book';
              default: return 'fa-calendar';
            }
          };

          const getEventTypeColor = (type) => {
            switch(type) {
              case 'exam': return 'text-red-400';
              case 'quiz': return 'text-yellow-400';
              case 'homework': return 'text-blue-400';
              default: return 'text-gray-400';
            }
          };

          const getEventTypeName = (type) => {
            switch(type) {
              case 'exam': return 'Egzamin';
              case 'quiz': return 'Kartkówka';
              case 'homework': return 'Zadanie domowe';
              default: return 'Wydarzenie';
            }
          };

          const handleSaveEvent = () => {
            if (!eventForm.title || !eventForm.date) {
              alert('Proszę wypełnić wymagane pola');
              return;
            }

            const newEvent = {
              ...eventForm,
              id: editingEvent ? editingEvent.id : Date.now(),
              createdBy: user.username,
              createdAt: editingEvent ? editingEvent.createdAt : new Date().toISOString()
            };

            let updatedEvents;
            if (editingEvent) {
              updatedEvents = events.map(e => e.id === editingEvent.id ? newEvent : e);
            } else {
              updatedEvents = [...events, newEvent];
            }

            saveEvents(updatedEvents);
            resetEventForm();
            setShowEventDialog(false);

            // Symulacja wysłania przypomnień
            if (newEvent.reminder) {
              scheduleReminders(newEvent);
            }
          };

          const scheduleReminders = (event) => {
            // W rzeczywistej aplikacji tutaj byłaby integracja z systemem powiadomień
            console.log(`Przypomnienie zaplanowane na ${event.reminderDays} dni przed wydarzeniem "${event.title}"`);
          };

          const handleDeleteEvent = (eventId) => {
            if (confirm('Czy na pewno chcesz usunąć to wydarzenie?')) {
              const updatedEvents = events.filter(e => e.id !== eventId);
              saveEvents(updatedEvents);
            }
          };

          const handleEditEvent = (event) => {
            setEditingEvent(event);
            setEventForm({
              ...event,
              date: event.date.split('T')[0], // Format do input date
              time: event.time || ''
            });
            setShowEventDialog(true);
          };

          const resetEventForm = () => {
            setEventForm({
              title: '',
              type: 'exam',
              date: '',
              time: '',
              duration: 60,
              description: '',
              class: '',
              reminder: true,
              reminderDays: 1
            });
            setEditingEvent(null);
          };

          const changeMonth = (direction) => {
            const newMonth = new Date(currentMonth);
            newMonth.setMonth(currentMonth.getMonth() + direction);
            setCurrentMonth(newMonth);
          };

          const getUpcomingEvents = () => {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);

            return events
              .filter(event => {
                const eventDate = new Date(event.date);
                return eventDate >= today && eventDate <= nextWeek;
              })
              .sort((a, b) => new Date(a.date) - new Date(b.date));
          };

          const monthNames = [
            'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
            'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
          ];

          const dayNames = ['Nd', 'Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'Sb'];

          return (
            <div className="space-y-6">
              {/* Nagłówek z przyciskami */}
              <div className="flex justify-between items-center">
                <div className="flex items-center space-x-4">
                  <button
                    onClick={() => setCurrentMonth(new Date())}
                    className="btn-secondary"
                  >
                    <i className="fas fa-calendar-day mr-2"></i>
                    Dziś
                  </button>
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => changeMonth(-1)}
                      className="btn-sm bg-gray-700 hover:bg-gray-600"
                    >
                      <i className="fas fa-chevron-left"></i>
                    </button>
                    <h3 className="text-lg font-semibold min-w-[150px] text-center">
                      {monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}
                    </h3>
                    <button
                      onClick={() => changeMonth(1)}
                      className="btn-sm bg-gray-700 hover:bg-gray-600"
                    >
                      <i className="fas fa-chevron-right"></i>
                    </button>
                  </div>
                </div>
                <button
                  onClick={() => {
                    resetEventForm();
                    setShowEventDialog(true);
                  }}
                  className="btn-primary"
                >
                  <i className="fas fa-plus mr-2"></i>
                  Dodaj wydarzenie
                </button>
              </div>

              <div className="grid md:grid-cols-3 gap-6">
                {/* Kalendarz */}
                <div className="md:col-span-2">
                  <div className="card-modern">
                    <div className="grid grid-cols-7 gap-1 mb-2">
                      {dayNames.map(day => (
                        <div key={day} className="text-center text-sm font-semibold text-gray-400 py-2">
                          {day}
                        </div>
                      ))}
                    </div>
                    <div className="grid grid-cols-7 gap-1">
                      {getDaysInMonth(currentMonth).map((date, index) => {
                        const dayEvents = date ? getEventsForDate(date) : [];
                        const isToday = date && date.toDateString() === new Date().toDateString();
                        const isSelected = date && selectedDate && date.toDateString() === selectedDate.toDateString();
                        
                        return (
                          <div
                            key={index}
                            className={`
                              min-h-[80px] p-2 rounded cursor-pointer transition-colors
                              ${!date ? 'bg-transparent' : 'bg-gray-800 hover:bg-gray-700'}
                              ${isToday ? 'ring-2 ring-blue-500' : ''}
                              ${isSelected ? 'bg-gray-700' : ''}
                            `}
                            onClick={() => date && setSelectedDate(date)}
                          >
                            {date && (
                              <>
                                <div className="text-sm font-medium mb-1">
                                  {date.getDate()}
                                </div>
                                <div className="space-y-1">
                                  {dayEvents.slice(0, 2).map(event => (
                                    <div
                                      key={event.id}
                                      className={`text-xs p-1 rounded ${getEventTypeColor(event.type)} bg-gray-900 truncate`}
                                      title={event.title}
                                    >
                                      <i className={`fas ${getEventTypeIcon(event.type)} mr-1`}></i>
                                      {event.title}
                                    </div>
                                  ))}
                                  {dayEvents.length > 2 && (
                                    <div className="text-xs text-gray-400">
                                      +{dayEvents.length - 2} więcej
                                    </div>
                                  )}
                                </div>
                              </>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* Wydarzenia wybranego dnia */}
                  {selectedDate && (
                    <div className="card-modern mt-4">
                      <h3 className="text-lg font-semibold mb-4">
                        Wydarzenia - {selectedDate.toLocaleDateString('pl-PL', { 
                          weekday: 'long', 
                          year: 'numeric', 
                          month: 'long', 
                          day: 'numeric' 
                        })}
                      </h3>
                      {getEventsForDate(selectedDate).length === 0 ? (
                        <p className="text-gray-400">Brak wydarzeń w tym dniu</p>
                      ) : (
                        <div className="space-y-3">
                          {getEventsForDate(selectedDate).map(event => (
                            <div key={event.id} className="bg-gray-800 rounded-lg p-4">
                              <div className="flex justify-between items-start">
                                <div className="flex-1">
                                  <div className="flex items-center mb-2">
                                    <i className={`fas ${getEventTypeIcon(event.type)} ${getEventTypeColor(event.type)} mr-2`}></i>
                                    <h4 className="font-semibold">{event.title}</h4>
                                  </div>
                                  <div className="text-sm text-gray-400 space-y-1">
                                    <div>
                                      <i className="fas fa-clock mr-2"></i>
                                      {formatEventTime(event)} - {event.duration} min
                                    </div>
                                    {event.class && (
                                      <div>
                                        <i className="fas fa-users mr-2"></i>
                                        Klasa: {event.class}
                                      </div>
                                    )}
                                    {event.description && (
                                      <div>
                                        <i className="fas fa-info-circle mr-2"></i>
                                        {event.description}
                                      </div>
                                    )}
                                  </div>
                                </div>
                                <div className="flex space-x-2 ml-4">
                                  <button
                                    onClick={() => handleEditEvent(event)}
                                    className="btn-sm bg-blue-600 hover:bg-blue-700"
                                    title="Edytuj"
                                  >
                                    <i className="fas fa-edit"></i>
                                  </button>
                                  <button
                                    onClick={() => handleDeleteEvent(event.id)}
                                    className="btn-sm bg-red-600 hover:bg-red-700"
                                    title="Usuń"
                                  >
                                    <i className="fas fa-trash"></i>
                                  </button>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* Panel boczny - nadchodzące wydarzenia */}
                <div className="space-y-4">
                  <div className="card-modern">
                    <h3 className="text-lg font-semibold mb-4">
                      <i className="fas fa-bell mr-2"></i>
                      Nadchodzące wydarzenia (7 dni)
                    </h3>
                    {getUpcomingEvents().length === 0 ? (
                      <p className="text-gray-400">Brak nadchodzących wydarzeń</p>
                    ) : (
                      <div className="space-y-3">
                        {getUpcomingEvents().map(event => {
                          const eventDate = new Date(event.date);
                          const daysUntil = Math.ceil((eventDate - new Date()) / (1000 * 60 * 60 * 24));
                          
                          return (
                            <div key={event.id} className="bg-gray-800 rounded-lg p-3">
                              <div className="flex items-start justify-between">
                                <div>
                                  <div className="flex items-center mb-1">
                                    <i className={`fas ${getEventTypeIcon(event.type)} ${getEventTypeColor(event.type)} mr-2`}></i>
                                    <span className="font-medium">{event.title}</span>
                                  </div>
                                  <div className="text-sm text-gray-400">
                                    {eventDate.toLocaleDateString('pl-PL', { 
                                      weekday: 'short', 
                                      day: 'numeric', 
                                      month: 'short' 
                                    })}
                                    {event.time && ` o ${event.time}`}
                                  </div>
                                  {event.class && (
                                    <div className="text-sm text-gray-400">
                                      Klasa: {event.class}
                                    </div>
                                  )}
                                </div>
                                <div className="text-right">
                                  <div className={`text-sm font-semibold ${
                                    daysUntil === 0 ? 'text-red-400' :
                                    daysUntil === 1 ? 'text-yellow-400' :
                                    'text-green-400'
                                  }`}>
                                    {daysUntil === 0 ? 'Dziś' :
                                     daysUntil === 1 ? 'Jutro' :
                                     `Za ${daysUntil} dni`}
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>

                  {/* Statystyki */}
                  <div className="card-modern">
                    <h3 className="text-lg font-semibold mb-4">
                      <i className="fas fa-chart-pie mr-2"></i>
                      Statystyki
                    </h3>
                    <div className="space-y-3">
                      <div className="flex justify-between items-center">
                        <span className="text-gray-400">Wszystkie wydarzenia:</span>
                        <span className="font-semibold">{events.length}</span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-gray-400">Egzaminy:</span>
                        <span className="font-semibold text-red-400">
                          {events.filter(e => e.type === 'exam').length}
                        </span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-gray-400">Kartkówki:</span>
                        <span className="font-semibold text-yellow-400">
                          {events.filter(e => e.type === 'quiz').length}
                        </span>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-gray-400">Zadania domowe:</span>
                        <span className="font-semibold text-blue-400">
                          {events.filter(e => e.type === 'homework').length}
                        </span>
                      </div>
                    </div>
                  </div>

                  {/* Legenda */}
                  <div className="card-modern">
                    <h3 className="text-lg font-semibold mb-4">
                      <i className="fas fa-info-circle mr-2"></i>
                      Legenda
                    </h3>
                    <div className="space-y-2">
                      <div className="flex items-center">
                        <i className="fas fa-file-alt text-red-400 mr-2"></i>
                        <span className="text-sm">Egzamin</span>
                      </div>
                      <div className="flex items-center">
                        <i className="fas fa-clipboard-check text-yellow-400 mr-2"></i>
                        <span className="text-sm">Kartkówka</span>
                      </div>
                      <div className="flex items-center">
                        <i className="fas fa-book text-blue-400 mr-2"></i>
                        <span className="text-sm">Zadanie domowe</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Dialog dodawania/edycji wydarzenia */}
              {showEventDialog && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-gray-900 rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <h3 className="text-xl font-semibold mb-4">
                      {editingEvent ? 'Edytuj wydarzenie' : 'Dodaj nowe wydarzenie'}
                    </h3>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-2">Tytuł *</label>
                        <input
                          type="text"
                          value={eventForm.title}
                          onChange={(e) => setEventForm({...eventForm, title: e.target.value})}
                          placeholder="np. Sprawdzian z matematyki"
                          className="input-modern w-full"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium mb-2">Typ wydarzenia</label>
                        <select
                          value={eventForm.type}
                          onChange={(e) => setEventForm({...eventForm, type: e.target.value})}
                          className="input-modern w-full"
                        >
                          <option value="exam">Egzamin</option>
                          <option value="quiz">Kartkówka</option>
                          <option value="homework">Zadanie domowe</option>
                        </select>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium mb-2">Data *</label>
                          <input
                            type="date"
                            value={eventForm.date}
                            onChange={(e) => setEventForm({...eventForm, date: e.target.value})}
                            className="input-modern w-full"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-2">Godzina</label>
                          <input
                            type="time"
                            value={eventForm.time}
                            onChange={(e) => setEventForm({...eventForm, time: e.target.value})}
                            className="input-modern w-full"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium mb-2">Czas trwania (minuty)</label>
                        <input
                          type="number"
                          value={eventForm.duration}
                          onChange={(e) => setEventForm({...eventForm, duration: parseInt(e.target.value) || 60})}
                          min="15"
                          max="240"
                          step="15"
                          className="input-modern w-full"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium mb-2">Klasa/Grupa</label>
                        <input
                          type="text"
                          value={eventForm.class}
                          onChange={(e) => setEventForm({...eventForm, class: e.target.value})}
                          placeholder="np. 8A, Grupa zaawansowana"
                          className="input-modern w-full"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium mb-2">Opis</label>
                        <textarea
                          value={eventForm.description}
                          onChange={(e) => setEventForm({...eventForm, description: e.target.value})}
                          placeholder="Dodatkowe informacje..."
                          rows="3"
                          className="input-modern w-full"
                        />
                      </div>

                      <div>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={eventForm.reminder}
                            onChange={(e) => setEventForm({...eventForm, reminder: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm">Wyślij przypomnienie</span>
                        </label>
                        {eventForm.reminder && (
                          <div className="mt-2">
                            <label className="block text-sm font-medium mb-1">Dni przed wydarzeniem</label>
                            <select
                              value={eventForm.reminderDays}
                              onChange={(e) => setEventForm({...eventForm, reminderDays: parseInt(e.target.value)})}
                              className="input-modern w-full"
                            >
                              <option value="1">1 dzień</option>
                              <option value="2">2 dni</option>
                              <option value="3">3 dni</option>
                              <option value="7">Tydzień</option>
                            </select>
                          </div>
                        )}
                      </div>

                      <div className="flex justify-end space-x-3 pt-4">
                        <button
                          onClick={() => {
                            setShowEventDialog(false);
                            resetEventForm();
                          }}
                          className="btn-secondary"
                        >
                          Anuluj
                        </button>
                        <button
                          onClick={handleSaveEvent}
                          className="btn-primary"
                        >
                          {editingEvent ? 'Zapisz zmiany' : 'Dodaj wydarzenie'}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // Komponent generatora wariantów dla nauczyciela
        function VariantGeneratorTab({ user }) {
          const [selectedTasks, setSelectedTasks] = useState([]);
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [showApiConfig, setShowApiConfig] = useState(false);
          const [generatorInstance] = useState(() => new TaskVariantGenerator());
          const [stats, setStats] = useState(generatorInstance.getUsageStats());
          
          useEffect(() => {
            // Sprawdź czy mamy token sesji
            const token = localStorage.getItem('geminiSessionToken');
            if (token) {
              setIsAuthenticated(true);
            } else {
              // Automatycznie autoryzuj użytkownika
              generatorInstance.authenticate(user.userId, user.role).then(success => {
                setIsAuthenticated(success);
              });
            }
          }, [user]);
          
          const tasks = window.zadania.filter(z => !z.deleted && z.typ === 'zamkniete');
          
          return (
            <div>
              {/* Status autoryzacji */}
              {!isAuthenticated && (
                <div className="card-modern mb-6 border-2 border-yellow-500">
                  <h3 className="text-lg font-semibold mb-4">
                    <i className="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>
                    Brak autoryzacji
                  </h3>
                  <p className="text-sm text-gray-400 mb-4">
                    Nie udało się połączyć z serwerem generatora. Upewnij się, że serwer działa na porcie 3001.
                  </p>
                  <button
                    onClick={async () => {
                      const success = await generatorInstance.authenticate(user.userId, user.role);
                      if (success) {
                        setIsAuthenticated(true);
                        alert('Autoryzacja zakończona sukcesem!');
                      } else {
                        alert('Błąd autoryzacji. Sprawdź czy serwer działa.');
                      }
                    }}
                    className="btn-primary"
                  >
                    <i className="fas fa-sync mr-2"></i>Spróbuj ponownie
                  </button>
                </div>
              )}
              
              {/* Statystyki użycia */}
              <div className="grid md:grid-cols-4 gap-4 mb-6">
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Łączne żądania</p>
                  <p className="text-2xl font-bold text-purple-400">{stats.totalRequests}</p>
                </div>
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Łączny koszt</p>
                  <p className="text-2xl font-bold text-green-400">${stats.totalCost.toFixed(4)}</p>
                </div>
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Średni koszt</p>
                  <p className="text-2xl font-bold text-blue-400">${stats.avgCostPerRequest.toFixed(4)}</p>
                </div>
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Skuteczność</p>
                  <p className="text-2xl font-bold text-yellow-400">{(stats.successRate * 100).toFixed(1)}%</p>
                </div>
              </div>
              
              <div className="grid md:grid-cols-2 gap-6">
                {/* Lista zadań do wyboru */}
                <div className="card-modern">
                  <h3 className="text-lg font-semibold mb-4">Wybierz zadania do generacji wariantów</h3>
                  <div className="space-y-2 max-h-96 overflow-y-auto">
                    {tasks.map(task => {
                      const canGenerate = generatorInstance.canGenerateVariant(task);
                      const isSelected = selectedTasks.includes(task.id);
                      
                      return (
                        <div 
                          key={task.id} 
                          className={`p-3 rounded cursor-pointer transition ${
                            !canGenerate.canGenerate ? 'bg-gray-900 opacity-50 cursor-not-allowed' :
                            isSelected ? 'bg-purple-600/20 border border-purple-500' : 'bg-gray-800 hover:bg-gray-700'
                          }`}
                          onClick={() => {
                            if (canGenerate.canGenerate) {
                              setSelectedTasks(prev => 
                                isSelected 
                                  ? prev.filter(id => id !== task.id)
                                  : [...prev, task.id]
                              );
                            }
                          }}
                        >
                          <div className="flex items-start gap-2">
                            <input
                              type="checkbox"
                              checked={isSelected}
                              onChange={() => {}}
                              disabled={!canGenerate.canGenerate}
                              className="mt-1"
                            />
                            <div className="flex-1">
                              <p className="font-medium text-sm">{task.temat}</p>
                              <p className="text-xs text-gray-400 line-clamp-2">{task.tresc}</p>
                              {canGenerate.canGenerate && (
                                <div className="flex items-center gap-2 mt-1">
                                  {canGenerate.requiresAI && (
                                    <span className="text-xs bg-blue-600/20 text-blue-400 px-2 py-0.5 rounded">
                                      <i className="fas fa-brain mr-1"></i>Wymaga AI
                                    </span>
                                  )}
                                  <span className="text-xs text-gray-500">
                                    Koszt: ${canGenerate.estimatedCost.toFixed(4)}
                                  </span>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
                
                {/* Panel generacji */}
                <div className="card-modern">
                  <h3 className="text-lg font-semibold mb-4">Opcje generacji</h3>
                  
                  {selectedTasks.length === 0 ? (
                    <p className="text-gray-400 text-center py-8">Wybierz zadania z listy</p>
                  ) : (
                    <BatchGeneratorPanel 
                      selectedTasks={selectedTasks.map(id => tasks.find(t => t.id === id))}
                      generator={generatorInstance}
                      onComplete={() => {
                        setStats(generatorInstance.getUsageStats());
                        setSelectedTasks([]);
                      }}
                    />
                  )}
                </div>
              </div>
              
              {/* Przyciski akcji */}
              <div className="mt-6 flex justify-between">
                <button
                  onClick={() => setShowApiConfig(!showApiConfig)}
                  className="btn-secondary"
                >
                  <i className="fas fa-cog mr-2"></i>Konfiguracja API
                </button>
                <button
                  onClick={() => {
                    if (confirm('Czy na pewno chcesz zresetować statystyki?')) {
                      generatorInstance.resetStats();
                      setStats(generatorInstance.getUsageStats());
                    }
                  }}
                  className="btn-secondary text-red-400 border-red-400"
                >
                  <i className="fas fa-trash mr-2"></i>Reset statystyk
                </button>
              </div>
            </div>
          );
        }
        
        // Komponent batch generatora
        function BatchGeneratorPanel({ selectedTasks, generator, onComplete }) {
          const [quantity, setQuantity] = useState(5);
          const [useAI, setUseAI] = useState(true);
          const [thinkingBudget, setThinkingBudget] = useState(512);
          const [generating, setGenerating] = useState(false);
          const [progress, setProgress] = useState({ current: 0, total: 0 });
          
          const aiRequiredTasks = selectedTasks.filter(t => 
            generator.canGenerateVariant(t).requiresAI
          );
          
          const estimatedCost = selectedTasks.reduce((sum, task) => {
            const { requiresAI, estimatedCost } = generator.canGenerateVariant(task);
            return sum + (requiresAI && useAI ? estimatedCost : 0) * quantity;
          }, 0);
          
          const handleGenerate = async () => {
            setGenerating(true);
            setProgress({ current: 0, total: selectedTasks.length * quantity });
            
            try {
              const results = await generator.generateBatch(
                selectedTasks, 
                quantity,
                { useAI, thinkingBudget }
              );
              
              // Zapisz wygenerowane warianty
              const existingVariants = JSON.parse(localStorage.getItem('generatedVariants') || '[]');
              const newVariants = [...existingVariants, ...results.generated];
              localStorage.setItem('generatedVariants', JSON.stringify(newVariants));
              
              alert(`Wygenerowano ${results.generated.length} wariantów!\nKoszt: $${results.totalCost.toFixed(4)}`);
              onComplete();
              
            } catch (error) {
              alert(`Błąd generacji: ${error.message}`);
            } finally {
              setGenerating(false);
            }
          };
          
          return (
            <div className="space-y-4">
              <div className="p-4 bg-purple-600/10 rounded-lg border border-purple-600/30">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium">Wybrane zadania:</span>
                  <span className="font-bold">{selectedTasks.length}</span>
                </div>
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium">Zadania wymagające AI:</span>
                  <span className="font-bold text-blue-400">{aiRequiredTasks.length}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-sm font-medium">Szacowany koszt:</span>
                  <span className="font-bold text-green-400">${estimatedCost.toFixed(4)}</span>
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2">
                  Liczba wariantów na zadanie: {quantity}
                </label>
                <input
                  type="range"
                  min="1"
                  max="20"
                  value={quantity}
                  onChange={(e) => setQuantity(parseInt(e.target.value))}
                  className="w-full"
                  disabled={generating}
                />
              </div>
              
              <div>
                <label className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={useAI}
                    onChange={(e) => setUseAI(e.target.checked)}
                    disabled={generating || aiRequiredTasks.length === selectedTasks.length}
                  />
                  <span className="text-sm">Użyj AI dla złożonych zadań</span>
                </label>
                {aiRequiredTasks.length === selectedTasks.length && (
                  <p className="text-xs text-yellow-400 mt-1">
                    Wszystkie wybrane zadania wymagają AI
                  </p>
                )}
              </div>
              
              {useAI && (
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Thinking Budget: {thinkingBudget} tokenów
                  </label>
                  <input
                    type="range"
                    min="0"
                    max="4096"
                    step="256"
                    value={thinkingBudget}
                    onChange={(e) => setThinkingBudget(parseInt(e.target.value))}
                    className="w-full"
                    disabled={generating}
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Szybko</span>
                    <span>Jakość</span>
                  </div>
                </div>
              )}
              
              {generating && (
                <div className="w-full bg-gray-700 rounded-full h-2">
                  <div 
                    className="bg-purple-600 h-2 rounded-full transition-all"
                    style={{ width: `${(progress.current / progress.total) * 100}%` }}
                  />
                </div>
              )}
              
              <button
                onClick={handleGenerate}
                disabled={generating || selectedTasks.length === 0}
                className="btn-primary w-full"
              >
                {generating ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                    Generowanie...
                  </>
                ) : (
                  <>
                    <i className="fas fa-magic mr-2"></i>
                    Generuj {selectedTasks.length * quantity} wariantów
                  </>
                )}
              </button>
            </div>
          );
        }

        // Komponent wyników i rekomendacji dla nauczyciela
        function TeacherResultsView() {
          const [selectedStudent, setSelectedStudent] = useState(null);
          const [students, setStudents] = useState([]);
          const [results, setResults] = useState([]);
          const [filterCategory, setFilterCategory] = useState('all');
          const [showRecommendations, setShowRecommendations] = useState(false);

          useEffect(() => {
            loadStudentsAndResults();
          }, []);

          const loadStudentsAndResults = () => {
            // Pobierz wszystkich uczniów
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const studentUsers = users.filter(u => u.role === 'student');
            setStudents(studentUsers);

            // Pobierz wszystkie wyniki
            const allResults = JSON.parse(localStorage.getItem('examResults') || '[]');
            setResults(allResults);
          };

          const getStudentResults = (studentId) => {
            return results.filter(r => r.studentId === studentId);
          };

          const getStudentStats = (studentId) => {
            const studentResults = getStudentResults(studentId);
            if (studentResults.length === 0) {
              return { avgScore: 0, totalExams: 0, lastExam: null };
            }

            const totalScore = studentResults.reduce((sum, r) => sum + r.score, 0);
            const avgScore = totalScore / studentResults.length;
            const lastExam = studentResults.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt))[0];

            return {
              avgScore: Math.round(avgScore),
              totalExams: studentResults.length,
              lastExam: lastExam.completedAt
            };
          };

          const filteredStudents = filterCategory === 'all' 
            ? students 
            : students.filter(s => s.category === filterCategory);

          return (
            <div className="space-y-6">
              {/* Filtry */}
              <div className="card-modern">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">Filtruj uczniów</h3>
                  <select
                    value={filterCategory}
                    onChange={(e) => setFilterCategory(e.target.value)}
                    className="px-4 py-2 bg-gray-700 rounded-lg"
                  >
                    <option value="all">Wszystkie kategorie</option>
                    <option value="egzamin ósmoklasisty">Egzamin ósmoklasisty</option>
                    <option value="matura podstawowa">Matura podstawowa</option>
                    <option value="matura rozszerzona">Matura rozszerzona</option>
                  </select>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-6">
                {/* Lista uczniów */}
                <div className="card-modern">
                  <h3 className="text-lg font-semibold mb-4">Lista uczniów</h3>
                  <div className="space-y-2 max-h-96 overflow-y-auto">
                    {filteredStudents.length === 0 ? (
                      <p className="text-gray-400">Brak uczniów w tej kategorii</p>
                    ) : (
                      filteredStudents.map(student => {
                        const stats = getStudentStats(student.userId);
                        return (
                          <div
                            key={student.userId}
                            onClick={() => {
                              setSelectedStudent(student);
                              setShowRecommendations(false);
                            }}
                            className={`p-4 rounded-lg cursor-pointer transition ${
                              selectedStudent?.userId === student.userId
                                ? 'bg-purple-600/20 border border-purple-500'
                                : 'bg-gray-800 hover:bg-gray-700'
                            }`}
                          >
                            <div className="flex justify-between items-center">
                              <div>
                                <h4 className="font-medium">{student.username}</h4>
                                <p className="text-sm text-gray-400">{student.category}</p>
                              </div>
                              <div className="text-right">
                                <p className="text-lg font-semibold">
                                  {stats.avgScore}%
                                </p>
                                <p className="text-xs text-gray-400">
                                  {stats.totalExams} egzaminów
                                </p>
                              </div>
                            </div>
                          </div>
                        );
                      })
                    )}
                  </div>
                </div>

                {/* Szczegóły wybranego ucznia */}
                <div className="card-modern">
                  {selectedStudent ? (
                    <div>
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold">
                          Szczegóły: {selectedStudent.username}
                        </h3>
                        <button
                          onClick={() => setShowRecommendations(!showRecommendations)}
                          className="btn-primary text-sm"
                        >
                          <i className={`fas fa-${showRecommendations ? 'chart-bar' : 'lightbulb'} mr-2`}></i>
                          {showRecommendations ? 'Pokaż wyniki' : 'Pokaż rekomendacje'}
                        </button>
                      </div>

                      {showRecommendations ? (
                        <div>
                          <h4 className="font-medium mb-3">Personalizowane rekomendacje</h4>
                          <PersonalizedRecommendations selectedStudentId={selectedStudent.userId} />
                        </div>
                      ) : (
                        <div>
                          <h4 className="font-medium mb-3">Historia wyników</h4>
                          <div className="space-y-3 max-h-80 overflow-y-auto">
                            {getStudentResults(selectedStudent.userId).length === 0 ? (
                              <p className="text-gray-400">Brak wyników dla tego ucznia</p>
                            ) : (
                              getStudentResults(selectedStudent.userId)
                                .sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt))
                                .map(result => (
                                  <div key={result.id} className="p-3 bg-gray-800 rounded">
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <h5 className="font-medium">{result.examTitle}</h5>
                                        <p className="text-sm text-gray-400">
                                          {new Date(result.completedAt).toLocaleDateString('pl-PL')}
                                        </p>
                                      </div>
                                      <div className="text-right">
                                        <p className={`text-lg font-semibold ${
                                          result.score >= 80 ? 'text-green-400' :
                                          result.score >= 60 ? 'text-yellow-400' :
                                          result.score >= 40 ? 'text-orange-400' :
                                          'text-red-400'
                                        }`}>
                                          {result.score}%
                                        </p>
                                        <p className="text-xs text-gray-400">
                                          {result.correctAnswers}/{result.totalQuestions}
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                ))
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="text-center py-12">
                      <i className="fas fa-user text-4xl text-gray-600 mb-4"></i>
                      <p className="text-gray-400">Wybierz ucznia z listy, aby zobaczyć szczegóły</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Statystyki ogólne */}
              <div className="card-modern">
                <h3 className="text-lg font-semibold mb-4">Statystyki ogólne</h3>
                <div className="grid md:grid-cols-4 gap-4">
                  <div className="bg-gray-800 rounded-lg p-4 text-center">
                    <p className="text-3xl font-bold text-purple-400">{students.length}</p>
                    <p className="text-sm text-gray-400">Uczniów</p>
                  </div>
                  <div className="bg-gray-800 rounded-lg p-4 text-center">
                    <p className="text-3xl font-bold text-blue-400">{results.length}</p>
                    <p className="text-sm text-gray-400">Egzaminów</p>
                  </div>
                  <div className="bg-gray-800 rounded-lg p-4 text-center">
                    <p className="text-3xl font-bold text-green-400">
                      {results.length > 0 
                        ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length)
                        : 0}%
                    </p>
                    <p className="text-sm text-gray-400">Średni wynik</p>
                  </div>
                  <div className="bg-gray-800 rounded-lg p-4 text-center">
                    <p className="text-3xl font-bold text-yellow-400">
                      {results.filter(r => r.score >= 80).length}
                    </p>
                    <p className="text-sm text-gray-400">Wyników 80%+</p>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        // Komponent zgłoszonych zadań
        function ReportedTasksPanel({ user }) {
          const [reports, setReports] = useState([]);
          const [filterResolved, setFilterResolved] = useState(false);
          
          useEffect(() => {
            const allReports = JSON.parse(localStorage.getItem('taskReports') || '[]');
            setReports(allReports);
          }, []);
          
          const handleDeleteTask = (taskId, reportId) => {
            if (confirm('Czy na pewno chcesz usunąć to zadanie z bazy danych?')) {
              // Oznacz zadanie jako usunięte
              const tasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]');
              const updatedTasks = tasks.map(task => {
                if (task.id === taskId) {
                  return { ...task, deleted: true, deletedBy: user.username, deletedAt: new Date() };
                }
                return task;
              });
              
              localStorage.setItem('zadaniaDB', JSON.stringify(updatedTasks));
              window.zadania = updatedTasks.filter(t => !t.deleted);
              
              // Oznacz zgłoszenie jako rozwiązane
              markReportAsResolved(reportId, 'deleted');
            }
          };
          
          const markReportAsResolved = (reportId, action = 'resolved') => {
            const allReports = JSON.parse(localStorage.getItem('taskReports') || '[]');
            const updatedReports = allReports.map(report => {
              if (report.id === reportId) {
                return { 
                  ...report, 
                  resolved: true, 
                  resolvedBy: user.username, 
                  resolvedAt: new Date(),
                  resolution: action
                };
              }
              return report;
            });
            
            localStorage.setItem('taskReports', JSON.stringify(updatedReports));
            setReports(updatedReports);
          };
          
          const filteredReports = filterResolved 
            ? reports 
            : reports.filter(r => !r.resolved);
          
          const groupedReports = filteredReports.reduce((acc, report) => {
            if (!acc[report.taskId]) {
              acc[report.taskId] = [];
            }
            acc[report.taskId].push(report);
            return acc;
          }, {});
          
          if (Object.keys(groupedReports).length === 0) {
            return (
              <div className="card-modern">
                <p className="text-gray-400 text-center py-8">
                  {filterResolved ? 'Brak zgłoszeń' : 'Brak nowych zgłoszeń'}
                </p>
                {!filterResolved && (
                  <button
                    onClick={() => setFilterResolved(true)}
                    className="btn-secondary w-full mt-4"
                  >
                    Pokaż rozwiązane zgłoszenia
                  </button>
                )}
              </div>
            );
          }
          
          return (
            <div>
              <div className="mb-4 flex justify-between items-center">
                <p className="text-sm text-gray-400">
                  Znaleziono {Object.keys(groupedReports).length} zadań ze zgłoszeniami
                </p>
                <button
                  onClick={() => setFilterResolved(!filterResolved)}
                  className="btn-secondary text-sm"
                >
                  {filterResolved ? 'Ukryj rozwiązane' : 'Pokaż rozwiązane'}
                </button>
              </div>
              
              <div className="space-y-4">
                {Object.entries(groupedReports).map(([taskId, taskReports]) => {
                  const task = window.zadania.find(z => z.id === taskId) || 
                    JSON.parse(localStorage.getItem('zadaniaDB') || '[]').find(z => z.id === taskId);
                  
                  if (!task) return null;
                  
                  return (
                    <div key={taskId} className="card-modern">
                      <div className="mb-4">
                        <h3 className="font-semibold text-lg mb-2">
                          {task.przedmiot} - {task.temat}
                        </h3>
                        <p className="text-gray-300 mb-2">{task.tresc}</p>
                        {task.typ === 'zamkniete' && (
                          <div className="text-sm text-gray-400">
                            <p>Odpowiedzi: {task.odpowiedzi.join(', ')}</p>
                            <p>Poprawna: {task.poprawna}</p>
                          </div>
                        )}
                      </div>
                      
                      <div className="border-t border-gray-700 pt-4">
                        <h4 className="text-sm font-semibold mb-2">Zgłoszenia ({taskReports.length}):</h4>
                        <div className="space-y-2 mb-4">
                          {taskReports.map(report => (
                            <div key={report.id} className="p-3 bg-gray-800 rounded text-sm">
                              <div className="flex justify-between items-start">
                                <div>
                                  <p className="font-medium">
                                    {report.studentName} 
                                    <span className="text-gray-400 ml-2">
                                      {new Date(report.timestamp).toLocaleString()}
                                    </span>
                                  </p>
                                  {report.comment && (
                                    <p className="text-gray-300 mt-1">Komentarz: {report.comment}</p>
                                  )}
                                  <p className="text-xs text-gray-500 mt-1">
                                    Egzamin: {report.examTitle}
                                  </p>
                                </div>
                                {report.resolved && (
                                  <span className="text-xs bg-green-600/20 text-green-400 px-2 py-1 rounded">
                                    Rozwiązane
                                  </span>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                        
                        {!taskReports.some(r => r.resolved) && (
                          <div className="flex gap-2">
                            <button
                              onClick={() => handleDeleteTask(taskId, taskReports[0].id)}
                              className="btn-primary bg-red-600 hover:bg-red-700"
                            >
                              <i className="fas fa-trash mr-2"></i>Usuń zadanie
                            </button>
                            <button
                              onClick={() => markReportAsResolved(taskReports[0].id, 'dismissed')}
                              className="btn-secondary"
                            >
                              <i className="fas fa-times mr-2"></i>Odrzuć zgłoszenie
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        }

        // Komponent przypisywania uczniów do grup
        function StudentGroupAssignment({ groups, onAddStudent, onRemoveStudent }) {
          const [selectedGroup, setSelectedGroup] = useState(groups[0]?.id || '');
          const users = JSON.parse(localStorage.getItem('users') || '[]').filter(u => u.role === 'student');
          
          const currentGroup = groups.find(g => g.id === parseInt(selectedGroup));
          const studentsInGroup = currentGroup ? users.filter(u => currentGroup.students.includes(u.id)) : [];
          const studentsNotInGroup = currentGroup ? users.filter(u => !currentGroup.students.includes(u.id)) : users;
          
          if (groups.length === 0) {
            return <p className="text-gray-400">Najpierw utwórz grupę</p>;
          }
          
          return (
            <div>
              <select
                value={selectedGroup}
                onChange={(e) => setSelectedGroup(e.target.value)}
                className="input-modern w-full mb-4"
              >
                {groups.map(group => (
                  <option key={group.id} value={group.id}>
                    {group.name}
                  </option>
                ))}
              </select>
              
              <div className="space-y-4">
                <div>
                  <h4 className="text-sm font-medium mb-2 text-gray-400">Uczniowie w grupie</h4>
                  {studentsInGroup.length === 0 ? (
                    <p className="text-sm text-gray-500">Brak uczniów w tej grupie</p>
                  ) : (
                    <div className="space-y-2 max-h-40 overflow-y-auto">
                      {studentsInGroup.map(student => (
                        <div key={student.id} className="flex justify-between items-center p-2 bg-gray-800 rounded">
                          <span className="text-sm">
                            {student.username.replace('.', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                          </span>
                          <button
                            onClick={() => onRemoveStudent(parseInt(selectedGroup), student.id)}
                            className="text-red-400 hover:text-red-300 text-sm"
                          >
                            <i className="fas fa-minus-circle"></i>
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                <div>
                  <h4 className="text-sm font-medium mb-2 text-gray-400">Dostępni uczniowie</h4>
                  {studentsNotInGroup.length === 0 ? (
                    <p className="text-sm text-gray-500">Wszyscy uczniowie są już w tej grupie</p>
                  ) : (
                    <div className="space-y-2 max-h-40 overflow-y-auto">
                      {studentsNotInGroup.map(student => (
                        <div key={student.id} className="flex justify-between items-center p-2 bg-gray-800 rounded">
                          <span className="text-sm">
                            {student.username.replace('.', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                            <span className="text-xs text-gray-500 ml-2">({student.category})</span>
                          </span>
                          <button
                            onClick={() => onAddStudent(parseInt(selectedGroup), student.id)}
                            className="text-green-400 hover:text-green-300 text-sm"
                          >
                            <i className="fas fa-plus-circle"></i>
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // Komponent ostatnich arkuszy
        function RecentExams() {
          const exams = JSON.parse(localStorage.getItem('exams') || '[]')
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
            .slice(0, 5);

          if (exams.length === 0) {
            return <p className="text-gray-400">Brak utworzonych arkuszy</p>;
          }

          return (
            <div className="space-y-3">
              {exams.map(exam => (
                <div key={exam.id} className="p-3 bg-gray-800 rounded">
                  <h4 className="font-medium">{exam.title}</h4>
                  <p className="text-sm text-gray-400">
                    Zadań: {exam.questions.length} | Status: {exam.status === 'sent' ? 'Wysłany' : 'Oczekuje'}
                  </p>
                  <p className="text-xs text-gray-500">
                    {new Date(exam.createdAt).toLocaleString()}
                  </p>
                </div>
              ))}
            </div>
          );
        }

        // Komponent modalnego okna do dodawania komentarza
        function CommentModal({ isOpen, onClose, onSave, currentComment }) {
          const [comment, setComment] = useState(currentComment || '');
          
          useEffect(() => {
            setComment(currentComment || '');
          }, [currentComment]);
          
          if (!isOpen) return null;
          
          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
              <div className="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-lg font-semibold mb-4">Dodaj komentarz do wyniku</h3>
                <textarea
                  value={comment}
                  onChange={(e) => setComment(e.target.value)}
                  className="w-full h-32 p-3 bg-gray-700 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"
                  placeholder="Wpisz komentarz dla ucznia..."
                />
                <div className="flex gap-3 mt-4">
                  <button
                    onClick={() => {
                      onSave(comment);
                      onClose();
                    }}
                    className="btn-primary flex-1"
                  >
                    <i className="fas fa-save mr-2"></i>Zapisz
                  </button>
                  <button
                    onClick={onClose}
                    className="btn-secondary flex-1"
                  >
                    <i className="fas fa-times mr-2"></i>Anuluj
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // Komponent listy szczegółowych wyników z możliwością dodawania komentarzy
        function DetailedResultsList({ results }) {
          const [commentModalOpen, setCommentModalOpen] = useState(false);
          const [selectedResult, setSelectedResult] = useState(null);
          const [comments, setComments] = useState({});
          
          // Załaduj komentarze z localStorage
          useEffect(() => {
            const savedComments = JSON.parse(localStorage.getItem('examComments') || '{}');
            setComments(savedComments);
          }, []);
          
          // Zapisz komentarz
          const saveComment = (resultId, comment) => {
            const updatedComments = {
              ...comments,
              [resultId]: comment
            };
            setComments(updatedComments);
            localStorage.setItem('examComments', JSON.stringify(updatedComments));
          };
          
          // Pobierz dane ucznia
          const getStudentName = (studentId) => {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const student = users.find(u => u.id === studentId);
            if (!student) return 'Nieznany uczeń';
            return student.username.replace('.', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
          };
          
          return (
            <>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="border-b border-gray-700">
                      <th className="text-left py-3 px-4">Uczeń</th>
                      <th className="text-left py-3 px-4">Arkusz</th>
                      <th className="text-left py-3 px-4">Data</th>
                      <th className="text-left py-3 px-4">Wynik</th>
                      <th className="text-left py-3 px-4">Czas</th>
                      <th className="text-left py-3 px-4">Komentarz</th>
                      <th className="text-left py-3 px-4">Akcje</th>
                    </tr>
                  </thead>
                  <tbody>
                    {results.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt)).map((result) => {
                      const resultId = `${result.studentId}_${result.examId}_${result.completedAt}`;
                      const hasComment = comments[resultId];
                      
                      return (
                        <tr key={resultId} className="border-b border-gray-700 hover:bg-gray-800">
                          <td className="py-3 px-4">{getStudentName(result.studentId)}</td>
                          <td className="py-3 px-4">{result.examTitle}</td>
                          <td className="py-3 px-4">{new Date(result.completedAt).toLocaleDateString()}</td>
                          <td className="py-3 px-4">
                            <span className={`font-bold ${result.percentage >= 50 ? 'text-green-400' : 'text-red-400'}`}>
                              {result.percentage}%
                            </span>
                          </td>
                          <td className="py-3 px-4">{Math.floor((result.timeSpent || 0) / 60)} min</td>
                          <td className="py-3 px-4">
                            {hasComment && (
                              <div className="flex items-center gap-2">
                                <i className="fas fa-comment text-purple-400"></i>
                                <span className="text-sm text-gray-400">Dodano</span>
                              </div>
                            )}
                          </td>
                          <td className="py-3 px-4">
                            <button
                              onClick={() => {
                                setSelectedResult(resultId);
                                setCommentModalOpen(true);
                              }}
                              className="btn-secondary btn-sm"
                              title={hasComment ? "Edytuj komentarz" : "Dodaj komentarz"}
                            >
                              <i className={`fas ${hasComment ? 'fa-edit' : 'fa-comment-medical'}`}></i>
                            </button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              
              <CommentModal
                isOpen={commentModalOpen}
                onClose={() => {
                  setCommentModalOpen(false);
                  setSelectedResult(null);
                }}
                onSave={(comment) => {
                  if (selectedResult) {
                    saveComment(selectedResult, comment);
                  }
                }}
                currentComment={selectedResult ? comments[selectedResult] : ''}
              />
            </>
          );
        }

        // Komponent zaawansowanych statystyk
        function AdvancedStatistics() {
          const [filterType, setFilterType] = useState('all'); // all, student, date, category
          const [selectedStudent, setSelectedStudent] = useState('');
          const [selectedDate, setSelectedDate] = useState('');
          const [selectedCategory, setSelectedCategory] = useState('');
          
          const results = JSON.parse(localStorage.getItem('examResults') || '[]');
          const students = JSON.parse(localStorage.getItem('users') || '[]').filter(u => u.role === 'student');
          
          // Filtruj wyniki
          const filteredResults = useMemo(() => {
            let filtered = [...results];
            
            if (filterType === 'student' && selectedStudent) {
              filtered = filtered.filter(r => r.studentId === parseInt(selectedStudent));
            } else if (filterType === 'date' && selectedDate) {
              filtered = filtered.filter(r => {
                const resultDate = new Date(r.completedAt).toISOString().split('T')[0];
                return resultDate === selectedDate;
              });
            } else if (filterType === 'category' && selectedCategory) {
              filtered = filtered.filter(r => r.category === selectedCategory);
            }
            
            return filtered;
          }, [results, filterType, selectedStudent, selectedDate, selectedCategory]);
          
          // Oblicz statystyki
          const stats = useMemo(() => {
            if (filteredResults.length === 0) {
              return {
                avgScore: 0,
                totalExams: 0,
                passRate: 0,
                avgTime: 0,
                bestScore: 0,
                worstScore: 0
              };
            }
            
            const scores = filteredResults.map(r => r.percentage);
            const times = filteredResults.map(r => r.timeSpent || 0);
            
            return {
              avgScore: scores.reduce((a, b) => a + b, 0) / scores.length,
              totalExams: filteredResults.length,
              passRate: (scores.filter(s => s >= 50).length / scores.length) * 100,
              avgTime: times.reduce((a, b) => a + b, 0) / times.length,
              bestScore: Math.max(...scores),
              worstScore: Math.min(...scores)
            };
          }, [filteredResults]);
          
          return (
            <div>
              <div className="mb-6">
                <h3 className="text-lg font-semibold mb-4">Filtry statystyk</h3>
                <div className="grid md:grid-cols-4 gap-4">
                  <select
                    value={filterType}
                    onChange={(e) => setFilterType(e.target.value)}
                    className="input-modern"
                  >
                    <option value="all">Wszystkie wyniki</option>
                    <option value="student">Według ucznia</option>
                    <option value="date">Według daty</option>
                    <option value="category">Według kategorii</option>
                  </select>
                  
                  {filterType === 'student' && (
                    <select
                      value={selectedStudent}
                      onChange={(e) => setSelectedStudent(e.target.value)}
                      className="input-modern"
                    >
                      <option value="">Wybierz ucznia</option>
                      {students.map(student => (
                        <option key={student.id} value={student.id}>
                          {student.username.replace('.', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                        </option>
                      ))}
                    </select>
                  )}
                  
                  {filterType === 'date' && (
                    <input
                      type="date"
                      value={selectedDate}
                      onChange={(e) => setSelectedDate(e.target.value)}
                      className="input-modern"
                    />
                  )}
                  
                  {filterType === 'category' && (
                    <select
                      value={selectedCategory}
                      onChange={(e) => setSelectedCategory(e.target.value)}
                      className="input-modern"
                    >
                      <option value="">Wybierz kategorię</option>
                      <option value="egzamin ósmoklasisty">Egzamin ósmoklasisty</option>
                      <option value="matura podstawowa">Matura podstawowa</option>
                      <option value="matura rozszerzona">Matura rozszerzona</option>
                    </select>
                  )}
                </div>
              </div>
              
              <div className="grid md:grid-cols-3 gap-6 mb-6">
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Średni wynik</p>
                  <p className="text-3xl font-bold gradient-text">{stats.avgScore.toFixed(1)}%</p>
                </div>
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Liczba egzaminów</p>
                  <p className="text-3xl font-bold">{stats.totalExams}</p>
                </div>
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Procent zdanych</p>
                  <p className="text-3xl font-bold text-green-400">{stats.passRate.toFixed(1)}%</p>
                </div>
              </div>
              
              <div className="grid md:grid-cols-3 gap-6 mb-6">
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Średni czas</p>
                  <p className="text-2xl font-bold">{Math.floor(stats.avgTime / 60)} min</p>
                </div>
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Najlepszy wynik</p>
                  <p className="text-2xl font-bold text-green-400">{stats.bestScore}%</p>
                </div>
                <div className="card-modern text-center">
                  <p className="text-sm text-gray-400">Najgorszy wynik</p>
                  <p className="text-2xl font-bold text-red-400">{stats.worstScore}%</p>
                </div>
              </div>
              
              {filteredResults.length > 0 && (
                <>
                  <div className="card-modern">
                    <h3 className="text-lg font-semibold mb-4">Wykres wyników</h3>
                    <ScoreChart results={filteredResults} />
                  </div>
                  
                  <div className="card-modern mt-6">
                    <h3 className="text-lg font-semibold mb-4">Szczegółowe wyniki</h3>
                    <DetailedResultsList results={filteredResults} />
                  </div>
                </>
              )}
              
              <div className="mt-6 flex gap-4">
                <button
                  onClick={() => exportStatisticsToExcel(filteredResults, filterType)}
                  className="btn-primary"
                >
                  <i className="fas fa-file-excel mr-2"></i>Eksportuj do Excel
                </button>
                <button
                  onClick={() => generateStatisticsReport(filteredResults, stats, filterType)}
                  className="btn-secondary"
                >
                  <i className="fas fa-file-pdf mr-2"></i>Generuj raport PDF
                </button>
              </div>
            </div>
          );
        }

        // Komponent wykresu wyników
        function ScoreChart({ results }) {
          const chartRef = useRef(null);
          const canvasRef = useRef(null);
          
          useEffect(() => {
            if (canvasRef.current && results.length > 0) {
              const ctx = canvasRef.current.getContext('2d');
              
              // Zniszcz poprzedni wykres jeśli istnieje
              if (chartRef.current) {
                chartRef.current.destroy();
              }
              
              // Przygotuj dane
              const labels = results.map(r => 
                new Date(r.completedAt).toLocaleDateString()
              );
              const scores = results.map(r => r.percentage);
              
              // Stwórz nowy wykres
              chartRef.current = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: [{
                    label: 'Wynik (%)',
                    data: scores,
                    borderColor: '#7c3aed',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    tension: 0.3
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      labels: {
                        color: '#fff'
                      }
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      max: 100,
                      ticks: {
                        color: '#fff'
                      },
                      grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                      }
                    },
                    x: {
                      ticks: {
                        color: '#fff'
                      },
                      grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                      }
                    }
                  }
                }
              });
            }
            
            return () => {
              if (chartRef.current) {
                chartRef.current.destroy();
              }
            };
          }, [results]);
          
          return (
            <div className="chart-container">
              <canvas ref={canvasRef}></canvas>
            </div>
          );
        }

        // Komponent analizy klas/grup
        function ClassAnalytics() {
          const [selectedGroup, setSelectedGroup] = useState('all');
          const [selectedSubject, setSelectedSubject] = useState('all');
          const [dateRange, setDateRange] = useState({
            start: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            end: new Date().toISOString().split('T')[0]
          });
          
          const groups = JSON.parse(localStorage.getItem('studentGroups') || '[]');
          const students = JSON.parse(localStorage.getItem('users') || '[]').filter(u => u.role === 'student');
          const results = JSON.parse(localStorage.getItem('examResults') || '[]');
          const tasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]').filter(t => !t.deleted);
          
          // Filtruj wyniki
          const filteredResults = useMemo(() => {
            let filtered = [...results];
            
            // Filtr grupy
            if (selectedGroup !== 'all') {
              const group = groups.find(g => g.id === parseInt(selectedGroup));
              if (group) {
                filtered = filtered.filter(r => group.students.includes(r.studentId));
              }
            }
            
            // Filtr przedmiotu
            if (selectedSubject !== 'all') {
              filtered = filtered.filter(r => r.category === selectedSubject);
            }
            
            // Filtr dat
            filtered = filtered.filter(r => {
              const resultDate = new Date(r.completedAt).toISOString().split('T')[0];
              return resultDate >= dateRange.start && resultDate <= dateRange.end;
            });
            
            return filtered;
          }, [results, selectedGroup, selectedSubject, dateRange, groups]);
          
          // Oblicz średnie wyniki per grupa
          const groupStats = useMemo(() => {
            const stats = {};
            
            // Dla wszystkich uczniów
            stats.all = {
              name: 'Wszyscy uczniowie',
              avgScore: 0,
              studentCount: students.length,
              examCount: 0,
              students: students.map(s => s.id)
            };
            
            // Dla każdej grupy
            groups.forEach(group => {
              stats[group.id] = {
                name: group.name,
                avgScore: 0,
                studentCount: group.students.length,
                examCount: 0,
                students: group.students
              };
            });
            
            // Oblicz statystyki
            Object.keys(stats).forEach(key => {
              const groupStudents = stats[key].students;
              const groupResults = filteredResults.filter(r => groupStudents.includes(r.studentId));
              
              if (groupResults.length > 0) {
                stats[key].avgScore = groupResults.reduce((sum, r) => sum + r.percentage, 0) / groupResults.length;
                stats[key].examCount = groupResults.length;
              }
            });
            
            return stats;
          }, [filteredResults, groups, students]);
          
          // Znajdź najtrudniejsze tematy
          const difficultTopics = useMemo(() => {
            const topicStats = {};
            
            filteredResults.forEach(result => {
              // Sprawdź czy answers istnieje i jest obiektem lub tablicą
              if (!result.answers) return;
              
              // Jeśli answers jest obiektem, przekształć na tablicę
              const answersArray = Array.isArray(result.answers) 
                ? result.answers 
                : Object.entries(result.answers || {}).map(([questionId, answer]) => ({
                    questionId: parseInt(questionId),
                    selectedAnswer: answer,
                    isCorrect: result.questions && result.questions.find(q => q.id === parseInt(questionId))?.poprawna === answer
                  }));
              
              answersArray.forEach(answer => {
                const task = tasks.find(t => t.id === answer.questionId);
                if (task) {
                  const topic = task.temat;
                  if (!topicStats[topic]) {
                    topicStats[topic] = {
                      correct: 0,
                      total: 0,
                      tasks: new Set()
                    };
                  }
                  
                  topicStats[topic].total++;
                  if (answer.isCorrect) {
                    topicStats[topic].correct++;
                  }
                  topicStats[topic].tasks.add(task.id);
                }
              });
            });
            
            // Przekształć na tablicę i posortuj
            return Object.entries(topicStats)
              .map(([topic, stats]) => ({
                topic,
                percentage: stats.total > 0 ? (stats.correct / stats.total) * 100 : 0,
                total: stats.total,
                taskCount: stats.tasks.size
              }))
              .sort((a, b) => a.percentage - b.percentage)
              .slice(0, 10);
          }, [filteredResults, tasks]);
          
          // Ranking uczniów
          const studentRanking = useMemo(() => {
            const studentStats = {};
            
            // Zbierz statystyki dla każdego ucznia
            filteredResults.forEach(result => {
              if (!studentStats[result.studentId]) {
                const student = students.find(s => s.id === result.studentId);
                studentStats[result.studentId] = {
                  id: result.studentId,
                  name: student ? student.username.replace('.', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : 'Nieznany',
                  scores: [],
                  totalExams: 0,
                  avgScore: 0,
                  bestScore: 0,
                  worstScore: 100
                };
              }
              
              studentStats[result.studentId].scores.push(result.percentage);
              studentStats[result.studentId].totalExams++;
            });
            
            // Oblicz średnie i ekstremalne wyniki
            Object.values(studentStats).forEach(student => {
              if (student.scores.length > 0) {
                student.avgScore = student.scores.reduce((sum, score) => sum + score, 0) / student.scores.length;
                student.bestScore = Math.max(...student.scores);
                student.worstScore = Math.min(...student.scores);
              }
            });
            
            // Posortuj według średniej
            return Object.values(studentStats)
              .sort((a, b) => b.avgScore - a.avgScore);
          }, [filteredResults, students]);
          
          // Uczniowie potrzebujący pomocy
          const studentsNeedingHelp = useMemo(() => {
            return studentRanking.filter(student => student.avgScore < 50);
          }, [studentRanking]);
          
          // Analiza błędów
          const errorAnalysis = useMemo(() => {
            const taskErrors = {};
            
            filteredResults.forEach(result => {
              // Sprawdź czy answers istnieje
              if (!result.answers) return;
              
              // Jeśli answers jest obiektem, przekształć na tablicę
              const answersArray = Array.isArray(result.answers) 
                ? result.answers 
                : Object.entries(result.answers || {}).map(([questionId, answer]) => ({
                    questionId: parseInt(questionId),
                    selectedAnswer: answer,
                    isCorrect: result.questions && result.questions.find(q => q.id === parseInt(questionId))?.poprawna === answer
                  }));
              
              answersArray.forEach(answer => {
                if (!answer.isCorrect) {
                  if (!taskErrors[answer.questionId]) {
                    const task = tasks.find(t => t.id === answer.questionId);
                    taskErrors[answer.questionId] = {
                      id: answer.questionId,
                      question: task ? task.tresc.substring(0, 100) + '...' : 'Nieznane zadanie',
                      topic: task ? task.temat : 'Nieznany',
                      subject: task ? task.przedmiot : 'Nieznany',
                      errors: 0,
                      attempts: 0
                    };
                  }
                  taskErrors[answer.questionId].errors++;
                }
                
                if (taskErrors[answer.questionId]) {
                  taskErrors[answer.questionId].attempts++;
                } else {
                  const task = tasks.find(t => t.id === answer.questionId);
                  taskErrors[answer.questionId] = {
                    id: answer.questionId,
                    question: task ? task.tresc.substring(0, 100) + '...' : 'Nieznane zadanie',
                    topic: task ? task.temat : 'Nieznany',
                    subject: task ? task.przedmiot : 'Nieznany',
                    errors: 0,
                    attempts: 1
                  };
                }
              });
            });
            
            // Oblicz procent błędów i posortuj
            return Object.values(taskErrors)
              .map(task => ({
                ...task,
                errorRate: (task.errors / task.attempts) * 100
              }))
              .sort((a, b) => b.errorRate - a.errorRate)
              .slice(0, 15);
          }, [filteredResults, tasks]);
          
          // Komponent heat map
          const HeatMapChart = ({ data }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            
            useEffect(() => {
              if (canvasRef.current && data.length > 0) {
                const ctx = canvasRef.current.getContext('2d');
                
                if (chartRef.current) {
                  chartRef.current.destroy();
                }
                
                // Przygotuj dane dla heat map
                const dates = [...new Set(data.map(r => new Date(r.completedAt).toISOString().split('T')[0]))].sort();
                const studentIds = [...new Set(data.map(r => r.studentId))];
                
                // Stwórz macierz wyników
                const matrix = studentIds.map(studentId => {
                  const student = students.find(s => s.id === studentId);
                  const studentName = student ? student.username.split('.')[1] || student.username : 'Uczeń ' + studentId;
                  
                  return {
                    label: studentName,
                    data: dates.map(date => {
                      const dayResults = data.filter(r => 
                        r.studentId === studentId && 
                        new Date(r.completedAt).toISOString().split('T')[0] === date
                      );
                      
                      if (dayResults.length === 0) return null;
                      
                      const avgScore = dayResults.reduce((sum, r) => sum + r.percentage, 0) / dayResults.length;
                      return avgScore;
                    })
                  };
                });
                
                // Alternatywne podejście - użyjemy bubble chart jako heat map
                const bubbleData = [];
                matrix.forEach((student, y) => {
                  student.data.forEach((score, x) => {
                    if (score !== null) {
                      bubbleData.push({
                        x: x,
                        y: y,
                        r: 10,
                        score: score,
                        studentName: student.label,
                        date: dates[x]
                      });
                    }
                  });
                });
                
                chartRef.current = new Chart(ctx, {
                  type: 'bubble',
                  data: {
                    datasets: [{
                      label: 'Wyniki uczniów',
                      data: bubbleData,
                      backgroundColor: (ctx) => {
                        const value = ctx.raw.score;
                        if (value >= 80) return 'rgba(34, 197, 94, 0.8)';
                        if (value >= 60) return 'rgba(251, 191, 36, 0.8)';
                        if (value >= 40) return 'rgba(251, 146, 60, 0.8)';
                        return 'rgba(239, 68, 68, 0.8)';
                      },
                      borderWidth: 1,
                      borderColor: 'rgba(255, 255, 255, 0.3)'
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: false
                      },
                      tooltip: {
                        callbacks: {
                          label: (context) => {
                            const data = context.raw;
                            return [
                              `Uczeń: ${data.studentName}`,
                              `Data: ${data.date}`,
                              `Wynik: ${data.score.toFixed(1)}%`
                            ];
                          }
                        }
                      }
                    },
                    scales: {
                      x: {
                        type: 'linear',
                        position: 'bottom',
                        ticks: {
                          callback: function(value) {
                            return dates[value] || '';
                          },
                          color: '#fff',
                          maxRotation: 45,
                          minRotation: 45,
                          stepSize: 1
                        },
                        grid: {
                          color: 'rgba(255, 255, 255, 0.1)'
                        },
                        min: -0.5,
                        max: dates.length - 0.5
                      },
                      y: {
                        type: 'linear',
                        ticks: {
                          callback: function(value) {
                            return matrix[value]?.label || '';
                          },
                          color: '#fff',
                          stepSize: 1
                        },
                        grid: {
                          color: 'rgba(255, 255, 255, 0.1)'
                        },
                        min: -0.5,
                        max: matrix.length - 0.5
                      }
                    }
                  }
                });
              }
              
              return () => {
                if (chartRef.current) {
                  chartRef.current.destroy();
                }
              };
            }, [data]);
            
            return (
              <div style={{ height: '400px' }}>
                <canvas ref={canvasRef}></canvas>
              </div>
            );
          };
          
          return (
            <div className="space-y-6">
              <h3 className="text-xl font-semibold">Analiza klas i grup</h3>
              
              {/* Filtry */}
              <div className="card-modern">
                <h4 className="font-semibold mb-4">Filtry analizy</h4>
                <div className="grid md:grid-cols-4 gap-4">
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Grupa</label>
                    <select
                      value={selectedGroup}
                      onChange={(e) => setSelectedGroup(e.target.value)}
                      className="input-modern"
                    >
                      <option value="all">Wszystkie grupy</option>
                      {groups.map(group => (
                        <option key={group.id} value={group.id}>
                          {group.name} ({group.students.length} uczniów)
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Przedmiot</label>
                    <select
                      value={selectedSubject}
                      onChange={(e) => setSelectedSubject(e.target.value)}
                      className="input-modern"
                    >
                      <option value="all">Wszystkie przedmioty</option>
                      <option value="egzamin ósmoklasisty">Egzamin ósmoklasisty</option>
                      <option value="matura podstawowa">Matura podstawowa</option>
                      <option value="matura rozszerzona">Matura rozszerzona</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Data od</label>
                    <input
                      type="date"
                      value={dateRange.start}
                      onChange={(e) => setDateRange({...dateRange, start: e.target.value})}
                      className="input-modern"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Data do</label>
                    <input
                      type="date"
                      value={dateRange.end}
                      onChange={(e) => setDateRange({...dateRange, end: e.target.value})}
                      className="input-modern"
                    />
                  </div>
                </div>
              </div>
              
              {/* Średnie wyniki per grupa */}
              <div className="card-modern">
                <h4 className="font-semibold mb-4">Średnie wyniki grup</h4>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="text-left border-b border-gray-700">
                        <th className="p-3">Grupa</th>
                        <th className="p-3">Liczba uczniów</th>
                        <th className="p-3">Liczba egzaminów</th>
                        <th className="p-3">Średni wynik</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(groupStats).map(([key, stats]) => (
                        <tr key={key} className="border-b border-gray-800 hover:bg-gray-800">
                          <td className="p-3">{stats.name}</td>
                          <td className="p-3">{stats.studentCount}</td>
                          <td className="p-3">{stats.examCount}</td>
                          <td className="p-3">
                            <span className={`font-bold ${stats.avgScore >= 50 ? 'text-green-400' : 'text-red-400'}`}>
                              {stats.avgScore.toFixed(1)}%
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
              
              {/* Heat map wyników */}
              {filteredResults.length > 0 && (
                <div className="card-modern">
                  <h4 className="font-semibold mb-4">Mapa wyników uczniów w czasie</h4>
                  <div className="mb-3">
                    <div className="flex gap-4 text-sm">
                      <span className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-green-500 rounded"></span> 80-100%
                      </span>
                      <span className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-yellow-500 rounded"></span> 60-79%
                      </span>
                      <span className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-orange-500 rounded"></span> 40-59%
                      </span>
                      <span className="flex items-center gap-2">
                        <span className="w-4 h-4 bg-red-500 rounded"></span> 0-39%
                      </span>
                    </div>
                  </div>
                  <HeatMapChart data={filteredResults} />
                </div>
              )}
              
              {/* Najtrudniejsze tematy */}
              <div className="grid md:grid-cols-2 gap-6">
                <div className="card-modern">
                  <h4 className="font-semibold mb-4">
                    <i className="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>
                    Najtrudniejsze tematy
                  </h4>
                  {difficultTopics.length === 0 ? (
                    <p className="text-gray-400">Brak danych</p>
                  ) : (
                    <div className="space-y-3">
                      {difficultTopics.map((topic, idx) => (
                        <div key={idx} className="p-3 bg-gray-800 rounded">
                          <div className="flex justify-between items-start">
                            <div className="flex-1">
                              <p className="font-medium">{topic.topic}</p>
                              <p className="text-xs text-gray-400">
                                Zadań: {topic.taskCount} | Odpowiedzi: {topic.total}
                              </p>
                            </div>
                            <span className={`text-lg font-bold ${topic.percentage < 50 ? 'text-red-400' : 'text-yellow-400'}`}>
                              {topic.percentage.toFixed(1)}%
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                {/* Uczniowie potrzebujący pomocy */}
                <div className="card-modern">
                  <h4 className="font-semibold mb-4">
                    <i className="fas fa-user-graduate text-red-400 mr-2"></i>
                    Uczniowie potrzebujący pomocy
                  </h4>
                  {studentsNeedingHelp.length === 0 ? (
                    <p className="text-gray-400">Wszyscy uczniowie mają średnią powyżej 50%</p>
                  ) : (
                    <div className="space-y-3">
                      {studentsNeedingHelp.map((student) => (
                        <div key={student.id} className="p-3 bg-red-900 bg-opacity-20 border border-red-700 rounded">
                          <div className="flex justify-between items-center">
                            <div>
                              <p className="font-medium">{student.name}</p>
                              <p className="text-xs text-gray-400">
                                Egzaminów: {student.totalExams} | Najlepszy: {student.bestScore.toFixed(0)}%
                              </p>
                            </div>
                            <span className="text-xl font-bold text-red-400">
                              {student.avgScore.toFixed(1)}%
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
              
              {/* Ranking uczniów */}
              <div className="card-modern">
                <h4 className="font-semibold mb-4">
                  <i className="fas fa-trophy text-yellow-400 mr-2"></i>
                  Ranking uczniów
                </h4>
                {studentRanking.length === 0 ? (
                  <p className="text-gray-400">Brak danych</p>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="text-left border-b border-gray-700">
                          <th className="p-3">Miejsce</th>
                          <th className="p-3">Uczeń</th>
                          <th className="p-3">Liczba egzaminów</th>
                          <th className="p-3">Średni wynik</th>
                          <th className="p-3">Najlepszy</th>
                          <th className="p-3">Najgorszy</th>
                        </tr>
                      </thead>
                      <tbody>
                        {studentRanking.slice(0, 10).map((student, idx) => (
                          <tr key={student.id} className="border-b border-gray-800 hover:bg-gray-800">
                            <td className="p-3">
                              {idx === 0 && <i className="fas fa-trophy text-yellow-400 mr-2"></i>}
                              {idx === 1 && <i className="fas fa-medal text-gray-400 mr-2"></i>}
                              {idx === 2 && <i className="fas fa-medal text-orange-600 mr-2"></i>}
                              {idx + 1}
                            </td>
                            <td className="p-3 font-medium">{student.name}</td>
                            <td className="p-3">{student.totalExams}</td>
                            <td className="p-3">
                              <span className={`font-bold ${student.avgScore >= 50 ? 'text-green-400' : 'text-red-400'}`}>
                                {student.avgScore.toFixed(1)}%
                              </span>
                            </td>
                            <td className="p-3 text-green-400">{student.bestScore.toFixed(0)}%</td>
                            <td className="p-3 text-red-400">{student.worstScore.toFixed(0)}%</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
              
              {/* Analiza błędów */}
              <div className="card-modern">
                <h4 className="font-semibold mb-4">
                  <i className="fas fa-times-circle text-red-400 mr-2"></i>
                  Zadania sprawiające największe problemy
                </h4>
                {errorAnalysis.length === 0 ? (
                  <p className="text-gray-400">Brak danych</p>
                ) : (
                  <div className="space-y-3">
                    {errorAnalysis.map((task) => (
                      <div key={task.id} className="p-4 bg-gray-800 rounded">
                        <div className="flex justify-between items-start mb-2">
                          <div className="flex-1">
                            <p className="font-medium text-sm">{task.question}</p>
                            <p className="text-xs text-gray-400 mt-1">
                              {task.subject} - {task.topic}
                            </p>
                          </div>
                          <div className="text-right ml-4">
                            <p className="text-lg font-bold text-red-400">{task.errorRate.toFixed(1)}%</p>
                            <p className="text-xs text-gray-400">błędów</p>
                          </div>
                        </div>
                        <div className="flex justify-between text-xs text-gray-500">
                          <span>Błędnych odpowiedzi: {task.errors}</span>
                          <span>Wszystkich prób: {task.attempts}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              
              {/* Przyciski eksportu */}
              <div className="flex gap-4">
                <button
                  onClick={() => exportClassAnalytics(filteredResults, groupStats, difficultTopics, studentRanking, errorAnalysis)}
                  className="btn-primary"
                >
                  <i className="fas fa-file-excel mr-2"></i>
                  Eksportuj analizę do Excel
                </button>
                <button
                  onClick={() => generateClassReport(filteredResults, groupStats, difficultTopics, studentRanking, errorAnalysis, studentsNeedingHelp)}
                  className="btn-secondary"
                >
                  <i className="fas fa-file-pdf mr-2"></i>
                  Generuj raport PDF
                </button>
              </div>
            </div>
          );
        }

        // Widok ucznia
        function StudentView({ user, onStartExam, onLogout }) {
          const [notifications, setNotifications] = useState([]);
          const [activeTab, setActiveTab] = useState('dashboard');
          const [showOnboarding, setShowOnboarding] = useState(false);
          
          useEffect(() => {
            // Pobierz powiadomienia dla ucznia
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const userNotifications = allNotifications.filter(n => n.userId === user.userId && !n.read);
            setNotifications(userNotifications);
            
            // Sprawdź czy użytkownik już widział onboarding
            const hasSeenOnboarding = localStorage.getItem(`onboarding_${user.userId}`);
            if (!hasSeenOnboarding) {
              setShowOnboarding(true);
            }
          }, [user.userId]);
          
          const markNotificationAsRead = (notificationId) => {
            const allNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const index = allNotifications.findIndex(n => n.id === notificationId);
            if (index !== -1) {
              allNotifications[index].read = true;
              localStorage.setItem('notifications', JSON.stringify(allNotifications));
              setNotifications(notifications.filter(n => n.id !== notificationId));
            }
          };
          
          // Pobierz grupy do których należy uczeń
          const allGroups = JSON.parse(localStorage.getItem('studentGroups') || '[]');
          const userGroups = allGroups.filter(g => g.students.includes(user.userId));
          const userGroupIds = userGroups.map(g => g.id);
          
          const exams = JSON.parse(localStorage.getItem('exams') || '[]')
            .filter(e => {
              if (e.status !== 'sent') return false;
              if (!e.targetCategories.includes(user.category)) return false;
              
              // Jeśli egzamin jest przypisany do grupy, sprawdź czy uczeń należy do tej grupy
              if (e.targetGroupId && e.targetGroupId !== 'all') {
                return userGroupIds.includes(parseInt(e.targetGroupId));
              }
              
              // Jeśli egzamin jest dla wszystkich, pokaż go
              return true;
            });
          
          const results = JSON.parse(localStorage.getItem('examResults') || '[]')
            .filter(r => r.studentId === user.userId);

          const completeOnboarding = () => {
            localStorage.setItem(`onboarding_${user.userId}`, 'true');
            setShowOnboarding(false);
          };

          return (
            <div className="container mx-auto p-6">
              <div className="glass-dark rounded-2xl shadow-2xl p-6">
                <div className="flex justify-between items-center mb-6">
                  <h1 className="text-3xl font-bold gradient-text">Panel Ucznia</h1>
                  <div className="flex items-center gap-4">
                    <span className="text-gray-300">
                      {user.username} ({user.category})
                      {userGroups.length > 0 && (
                        <span className="ml-2 text-sm text-purple-400">
                          | Grupy: {userGroups.map(g => g.name).join(', ')}
                        </span>
                      )}
                    </span>
                    <div className="relative">
                      {notifications.length > 0 && (
                        <span className="notification-badge">{notifications.length}</span>
                      )}
                      <button className="text-gray-300 hover:text-white mr-4">
                        <i className="fas fa-bell"></i>
                      </button>
                    </div>
                    <button onClick={onLogout} className="text-red-400 hover:text-red-300">
                      <i className="fas fa-sign-out-alt"></i> Wyloguj
                    </button>
                  </div>
                </div>

                {notifications.length > 0 && (
                  <div className="mb-6">
                    <h2 className="text-xl font-semibold mb-3">Powiadomienia</h2>
                    <div className="space-y-2">
                      {notifications.map(notification => (
                        <div key={notification.id} className="bg-purple-500/20 border border-purple-500 p-3 rounded flex justify-between items-center">
                          <p>{notification.message}</p>
                          <button
                            onClick={() => markNotificationAsRead(notification.id)}
                            className="text-sm text-purple-300 hover:text-white"
                          >
                            Oznacz jako przeczytane
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Navigation Tabs */}
                <div className="flex space-x-1 mb-6 border-b border-gray-700">
                  <button
                    onClick={() => setActiveTab('dashboard')}
                    className={`tab-modern ${activeTab === 'dashboard' ? 'active' : ''}`}
                  >
                    <i className="fas fa-home mr-2"></i>Dashboard
                  </button>
                  <button
                    onClick={() => setActiveTab('exams')}
                    className={`tab-modern ${activeTab === 'exams' ? 'active' : ''}`}
                  >
                    <i className="fas fa-file-alt mr-2"></i>Arkusze
                  </button>
                  <button
                    onClick={() => setActiveTab('results')}
                    className={`tab-modern ${activeTab === 'results' ? 'active' : ''}`}
                  >
                    <i className="fas fa-chart-line mr-2"></i>Wyniki
                  </button>
                  <button
                    onClick={() => setActiveTab('training')}
                    className={`tab-modern ${activeTab === 'training' ? 'active' : ''}`}
                  >
                    <i className="fas fa-dumbbell mr-2"></i>Trening
                  </button>
                  <button
                    onClick={() => setActiveTab('achievements')}
                    className={`tab-modern ${activeTab === 'achievements' ? 'active' : ''}`}
                  >
                    <i className="fas fa-trophy mr-2"></i>Osiągnięcia
                  </button>
                </div>

                {/* Dashboard Tab */}
                {activeTab === 'dashboard' && (
                  <div className="space-y-6">
                    {/* Feature Tiles */}
                    <div className="grid md:grid-cols-4 gap-4">
                      <div className="card-modern text-center hover:bg-purple-600/20 transition-all cursor-pointer"
                           onClick={() => setActiveTab('exams')}>
                        <div className="text-4xl mb-3">
                          <i className="fas fa-file-alt text-purple-400"></i>
                        </div>
                        <h3 className="font-semibold mb-2">Arkusze egzaminacyjne</h3>
                        <p className="text-sm text-gray-400">
                          Dostępne: {exams.length}
                        </p>
                      </div>
                      
                      <div className="card-modern text-center hover:bg-blue-600/20 transition-all cursor-pointer"
                           onClick={() => setActiveTab('training')}>
                        <div className="text-4xl mb-3">
                          <i className="fas fa-dumbbell text-blue-400"></i>
                        </div>
                        <h3 className="font-semibold mb-2">Tryb treningowy</h3>
                        <p className="text-sm text-gray-400">
                          Ćwicz bez limitu czasu
                        </p>
                      </div>
                      
                      <div className="card-modern text-center hover:bg-green-600/20 transition-all cursor-pointer"
                           onClick={() => window.safeModuleCall('quickReview', 'openQuickReview')}>
                        <div className="text-4xl mb-3">
                          <i className="fas fa-brain text-green-400"></i>
                        </div>
                        <h3 className="font-semibold mb-2">Szybka powtórka</h3>
                        <p className="text-sm text-gray-400">
                          Powtórz błędne odpowiedzi
                        </p>
                      </div>
                      
                      <div className="card-modern text-center hover:bg-yellow-600/20 transition-all cursor-pointer"
                           onClick={() => setActiveTab('achievements')}>
                        <div className="text-4xl mb-3">
                          <i className="fas fa-trophy text-yellow-400"></i>
                        </div>
                        <h3 className="font-semibold mb-2">Osiągnięcia</h3>
                        <p className="text-sm text-gray-400">
                          Twój postęp
                        </p>
                      </div>
                    </div>
                    
                    {/* AI Features */}
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">
                        <i className="fas fa-robot mr-2 text-purple-400"></i>
                        Funkcje AI
                      </h2>
                      <div className="grid md:grid-cols-3 gap-4">
                        <div className="bg-gray-800 p-4 rounded-lg hover:bg-gray-700 transition-all cursor-pointer"
                             onClick={() => {
                               // Pokaż loader
                               const loader = document.createElement('div');
                               loader.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                               loader.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uruchamianie AI Grader...';
                               document.body.appendChild(loader);
                               
                               // Wywołaj funkcję
                               const result = window.safeModuleCall('aiGrader', 'openAIGrader');
                               
                               // Usuń loader po 2 sekundach
                               setTimeout(() => {
                                 if (loader.parentNode) {
                                   loader.remove();
                                 }
                                 
                                 // Pokaż toast z rezultatem
                                 const toast = document.createElement('div');
                                 toast.className = result ? 
                                   'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50' :
                                   'fixed top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                                 toast.innerHTML = result ? 
                                   '<i class="fas fa-check mr-2"></i>AI Grader uruchomiony!' :
                                   '<i class="fas fa-exclamation-triangle mr-2"></i>Funkcja niedostępna';
                                 document.body.appendChild(toast);
                                 
                                 setTimeout(() => {
                                   if (toast.parentNode) {
                                     toast.remove();
                                   }
                                 }, 3000);
                               }, 2000);
                             }}>
                          <div className="flex items-center mb-2">
                            <i className="fas fa-user-check text-blue-400 mr-2"></i>
                            <h3 className="font-semibold">Ocenianie AI</h3>
                          </div>
                          <p className="text-sm text-gray-400">
                            Automatyczne sprawdzanie odpowiedzi
                          </p>
                        </div>
                        
                        <div className="bg-gray-800 p-4 rounded-lg hover:bg-gray-700 transition-all cursor-pointer"
                             onClick={() => window.safeModuleCall('recommendations', 'showRecommendations')}>
                          <div className="flex items-center mb-2">
                            <i className="fas fa-lightbulb text-yellow-400 mr-2"></i>
                            <h3 className="font-semibold">Rekomendacje</h3>
                          </div>
                          <p className="text-sm text-gray-400">
                            Spersonalizowane sugestie
                          </p>
                        </div>
                        
                        <div className="bg-gray-800 p-4 rounded-lg hover:bg-gray-700 transition-all cursor-pointer"
                             onClick={() => window.safeModuleCall('stepGrading', 'openStepGrading')}>
                          <div className="flex items-center mb-2">
                            <i className="fas fa-list-ol text-green-400 mr-2"></i>
                            <h3 className="font-semibold">Ocena krokowa</h3>
                          </div>
                          <p className="text-sm text-gray-400">
                            Szczegółowa analiza rozwiązań
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    {/* Import Features */}
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">
                        <i className="fas fa-file-import mr-2 text-orange-400"></i>
                        Import i analiza
                      </h2>
                      <div className="grid md:grid-cols-2 gap-4">
                        <div className="bg-gray-800 p-4 rounded-lg hover:bg-gray-700 transition-all cursor-pointer"
                             onClick={() => window.safeModuleCall('ckeImportUI', 'openCKEImport')}>
                          <div className="flex items-center mb-2">
                            <i className="fas fa-file-import text-orange-400 mr-2"></i>
                            <h3 className="font-semibold">Import CKE</h3>
                          </div>
                          <p className="text-sm text-gray-400">
                            Importuj arkusze z Centralnej Komisji Egzaminacyjnej
                          </p>
                        </div>
                        
                        <div className="bg-gray-800 p-4 rounded-lg hover:bg-gray-700 transition-all cursor-pointer"
                             onClick={() => window.safeModuleCall('advancedMath', 'openMathModule')}>
                          <div className="flex items-center mb-2">
                            <i className="fas fa-calculator text-blue-400 mr-2"></i>
                            <h3 className="font-semibold">Zaawansowana matematyka</h3>
                          </div>
                          <p className="text-sm text-gray-400">
                            Narzędzia matematyczne i analiza wzorów
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    {/* Quick Stats */}
                    <div className="grid md:grid-cols-3 gap-4">
                      <div className="card-modern text-center">
                        <div className="text-2xl font-bold text-purple-400 mb-2">
                          {results.length}
                        </div>
                        <div className="text-sm text-gray-400">
                          Rozwiązane arkusze
                        </div>
                      </div>
                      
                      <div className="card-modern text-center">
                        <div className="text-2xl font-bold text-green-400 mb-2">
                          {results.length > 0 ? 
                            Math.round(results.reduce((acc, r) => acc + (r.correctAnswers / r.totalQuestions * 100), 0) / results.length) 
                            : 0}%
                        </div>
                        <div className="text-sm text-gray-400">
                          Średni wynik
                        </div>
                      </div>
                      
                      <div className="card-modern text-center">
                        <div className="text-2xl font-bold text-yellow-400 mb-2">
                          {results.length > 0 ? 
                            Math.max(...results.map(r => Math.round(r.correctAnswers / r.totalQuestions * 100))) 
                            : 0}%
                        </div>
                        <div className="text-sm text-gray-400">
                          Najlepszy wynik
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Exams Tab */}
                {activeTab === 'exams' && (
                  <div className="grid md:grid-cols-3 gap-6">
                    <div className="card-modern md:col-span-2">
                      <h2 className="text-xl font-semibold mb-4">
                        <i className="fas fa-calendar-alt mr-2 text-purple-400"></i>
                        Kalendarz wydarzeń
                      </h2>
                      <StudentMiniCalendar userId={user.userId} userGroups={userGroupIds} />
                    </div>
                    
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">Dostępne arkusze</h2>
                      {exams.length === 0 ? (
                        <p className="text-gray-400">Brak dostępnych arkuszy dla Twojej kategorii</p>
                      ) : (
                        <div className="space-y-3">
                          {exams.map(exam => (
                            <div key={exam.id} className="p-4 bg-gray-800 rounded hover:bg-gray-700 transition">
                              <h3 className="font-medium">{exam.title}</h3>
                              <p className="text-sm text-gray-400">
                                Zadań: {exam.questions.length} | Czas: {exam.timeLimit} min
                              </p>
                              <p className="text-xs text-gray-500">
                                Od: {exam.createdBy}
                                {exam.targetGroupId && exam.targetGroupId !== 'all' && (
                                  <span className="ml-2">
                                    | Dla grupy: {allGroups.find(g => g.id === parseInt(exam.targetGroupId))?.name}
                                  </span>
                                )}
                              </p>
                              <button
                                onClick={() => onStartExam(exam)}
                                className="mt-2 btn-primary text-sm"
                              >
                                <i className="fas fa-play mr-2"></i>Rozpocznij
                              </button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Results Tab */}
                {activeTab === 'results' && (
                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">Twoje wyniki</h2>
                      <StudentResults results={results} />
                    </div>
                  </div>
                )}

                {/* Training Tab */}
                {activeTab === 'training' && (
                  <div className="grid md:grid-cols-2 gap-6">
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">
                        <i className="fas fa-dumbbell mr-2 text-blue-400"></i>
                        Tryb treningowy
                      </h2>
                      <p className="text-gray-400 mb-4">
                        Ćwicz rozwiązywanie zadań z bazy w trybie testowym lub egzaminacyjnym
                      </p>
                      <a
                        href="test-practice.html"
                        className="btn-primary inline-block text-center w-full"
                      >
                        <i className="fas fa-graduation-cap mr-2"></i>
                        Rozpocznij trening
                      </a>
                    </div>
                    
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">
                        <i className="fas fa-brain mr-2 text-green-400"></i>
                        Szybka Powtórka
                      </h2>
                      <p className="text-gray-400 mb-4">
                        Przejrzyj błędne odpowiedzi i trudne tematy
                      </p>
                      <button
                        onClick={() => window.navigationIntegration?.openQuickReview()}
                        className="btn-primary w-full"
                      >
                        <i className="fas fa-redo mr-2"></i>
                        Rozpocznij powtórkę
                      </button>
                    </div>
                  </div>
                )}

                {/* Achievements Tab */}
                {activeTab === 'achievements' && (
                  <div className="space-y-6">
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">
                        <i className="fas fa-trophy mr-2 text-yellow-400"></i>
                        Twoje osiągnięcia
                      </h2>
                      <AchievementsPanel userId={user.userId} />
                    </div>
                    
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">
                        <i className="fas fa-gamepad mr-2 text-purple-400"></i>
                        System Gamifikacji
                      </h2>
                      <div id="gamification-mini-stats">
                        <div dangerouslySetInnerHTML={{ 
                          __html: window.navigationIntegration?.renderGamificationMiniStats() || '<p class="text-gray-400">Ładowanie...</p>'
                        }} />
                      </div>
                      <button
                        onClick={() => {
                          const modal = document.createElement('div');
                          modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
                          modal.innerHTML = `
                            <div class="glass-dark p-8 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto">
                              <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold">System Gamifikacji</h2>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                                  <i class="fas fa-times text-2xl"></i>
                                </button>
                              </div>
                              <div>${window.navigationIntegration?.modules?.gamification?.renderFullDashboard() || ''}</div>
                            </div>
                          `;
                          document.body.appendChild(modal);
                        }}
                        className="btn-secondary w-full mt-4"
                      >
                        <i className="fas fa-chart-line mr-2"></i>
                        Zobacz szczegóły
                      </button>
                    </div>
                    
                    <div className="grid md:grid-cols-2 gap-6">
                      <div className="card-modern">
                        <h2 className="text-xl font-semibold mb-4">
                          <i className="fas fa-link mr-2 text-blue-400"></i>
                          Połącz z rodzicem
                        </h2>
                        <p className="text-gray-400 mb-4">
                          Udostępnij kod połączenia rodzicowi
                        </p>
                        <button
                          onClick={() => {
                            const code = `${user.userId}-${Date.now().toString(36).toUpperCase()}`;
                            const linkData = {
                              code,
                              childId: user.userId,
                              createdAt: new Date().toISOString(),
                              expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                            };
                            
                            let links = JSON.parse(localStorage.getItem('parentLinkCodes') || '[]');
                            links.push(linkData);
                            localStorage.setItem('parentLinkCodes', JSON.stringify(links));
                            
                            alert(`Twój kod połączenia:\n\n${code}\n\nKod ważny przez 7 dni`);
                          }}
                          className="btn-primary w-full"
                        >
                          <i className="fas fa-qrcode mr-2"></i>
                          Generuj kod
                        </button>
                      </div>
                      
                      <div className="card-modern">
                        <h2 className="text-xl font-semibold mb-4">
                          <i className="fas fa-users mr-2 text-purple-400"></i>
                          Rywalizacja
                        </h2>
                        <CompetitionPanel userId={user.userId} userCategory={user.category} />
                      </div>
                    </div>
                    
                    <div className="card-modern">
                      <h2 className="text-xl font-semibold mb-4">
                        <i className="fas fa-lightbulb mr-2 text-yellow-400"></i>
                        Personalizowane rekomendacje
                      </h2>
                      <PersonalizedRecommendations userId={user.userId} />
                    </div>
                  </div>
                )}
                
                {/* Onboarding Modal */}
                {showOnboarding && (
                  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
                    <div className="glass-dark p-8 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                      <div className="text-center">
                        <div className="text-6xl mb-4">
                          <i className="fas fa-graduation-cap text-purple-400"></i>
                        </div>
                        <h2 className="text-3xl font-bold mb-4">Witaj w QuizMaster!</h2>
                        <p className="text-lg text-gray-300 mb-6">
                          Poznaj najważniejsze funkcje systemu egzaminacyjnego
                        </p>
                        
                        <div className="grid md:grid-cols-2 gap-6 mb-6">
                          <div className="bg-gray-800 p-6 rounded-xl">
                            <i className="fas fa-file-alt text-4xl text-purple-400 mb-3"></i>
                            <h3 className="font-semibold mb-2">Arkusze egzaminacyjne</h3>
                            <p className="text-sm text-gray-400">
                              Rozwiązuj arkusze przygotowane przez nauczycieli
                            </p>
                          </div>
                          
                          <div className="bg-gray-800 p-6 rounded-xl">
                            <i className="fas fa-dumbbell text-4xl text-blue-400 mb-3"></i>
                            <h3 className="font-semibold mb-2">Tryb treningowy</h3>
                            <p className="text-sm text-gray-400">
                              Ćwicz zadania bez limitu czasu
                            </p>
                          </div>
                          
                          <div className="bg-gray-800 p-6 rounded-xl">
                            <i className="fas fa-robot text-4xl text-green-400 mb-3"></i>
                            <h3 className="font-semibold mb-2">Funkcje AI</h3>
                            <p className="text-sm text-gray-400">
                              Automatyczne ocenianie i rekomendacje
                            </p>
                          </div>
                          
                          <div className="bg-gray-800 p-6 rounded-xl">
                            <i className="fas fa-trophy text-4xl text-yellow-400 mb-3"></i>
                            <h3 className="font-semibold mb-2">Osiągnięcia</h3>
                            <p className="text-sm text-gray-400">
                              Zbieraj punkty i odblokuj nagrody
                            </p>
                          </div>
                        </div>
                        
                        <div className="bg-blue-900/20 border border-blue-700 rounded-lg p-4 mb-6">
                          <div className="flex items-center justify-center mb-2">
                            <i className="fas fa-lightbulb text-blue-400 mr-2"></i>
                            <span className="font-semibold">Wskazówka</span>
                          </div>
                          <p className="text-sm text-gray-300">
                            Zacznij od zakładki "Dashboard" aby zobaczyć wszystkie dostępne funkcje,
                            następnie przejdź do "Arkusze" aby rozpocząć rozwiązywanie zadań.
                          </p>
                        </div>
                        
                        <button
                          onClick={completeOnboarding}
                          className="btn-primary text-lg px-8 py-3"
                        >
                          <i className="fas fa-check mr-2"></i>
                          Rozpocznij naukę!
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        // Komponent mini-kalendarza dla ucznia
        function StudentMiniCalendar({ userId, userGroups }) {
          const [events, setEvents] = useState([]);
          const [selectedWeek, setSelectedWeek] = useState(0); // 0 = bieżący tydzień
          
          useEffect(() => {
            loadEvents();
          }, [selectedWeek]);
          
          const loadEvents = () => {
            // Sprawdź czy ExamScheduler jest dostępny
            if (typeof ExamScheduler === 'undefined') {
              console.warn('ExamScheduler nie jest dostępny');
              setEvents([]);
              return;
            }
            
            // Inicjalizuj scheduler
            const scheduler = new ExamScheduler();
            
            // Oblicz zakres dat dla wybranego tygodnia
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (selectedWeek * 7)); // Poniedziałek
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Niedziela
            endOfWeek.setHours(23, 59, 59, 999);
            
            // Pobierz wydarzenia dla ucznia
            const allEvents = scheduler.getEvents(startOfWeek, endOfWeek, {
              studentId: userId
            });
            
            // Filtruj wydarzenia które dotyczą ucznia (przez grupy lub bezpośrednio)
            const filteredEvents = allEvents.filter(event => {
              // Jeśli wydarzenie jest dla konkretnych uczniów
              if (event.targetStudents && event.targetStudents.includes(userId)) {
                return true;
              }
              
              // Jeśli wydarzenie jest dla grup
              if (event.targetGroups && event.targetGroups.length > 0) {
                return event.targetGroups.some(groupId => userGroups.includes(groupId));
              }
              
              // Jeśli wydarzenie nie ma określonych celów (dla wszystkich)
              if ((!event.targetGroups || event.targetGroups.length === 0) && 
                  (!event.targetStudents || event.targetStudents.length === 0)) {
                return true;
              }
              
              return false;
            });
            
            setEvents(filteredEvents);
          };
          
          const getEventIcon = (type) => {
            const icons = {
              exam: 'fa-file-alt text-red-400',
              quiz: 'fa-question-circle text-orange-400',
              homework: 'fa-home text-blue-400',
              other: 'fa-calendar text-gray-400'
            };
            return icons[type] || icons.other;
          };
          
          const formatTime = (time) => {
            return time ? time.substring(0, 5) : '';
          };
          
          const getDaysOfWeek = () => {
            const days = [];
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (selectedWeek * 7));
            
            for (let i = 0; i < 7; i++) {
              const date = new Date(startOfWeek);
              date.setDate(startOfWeek.getDate() + i);
              days.push(date);
            }
            
            return days;
          };
          
          const isToday = (date) => {
            const today = new Date();
            return date.toDateString() === today.toDateString();
          };
          
          const isPast = (date) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return date < today;
          };
          
          const getEventsForDay = (date) => {
            const dateStr = date.toISOString().split('T')[0];
            return events.filter(event => event.date === dateStr);
          };
          
          const getUpcomingDeadlines = () => {
            const now = new Date();
            const upcoming = events.filter(event => {
              const eventDate = new Date(event.date + 'T' + event.time);
              const hoursDiff = (eventDate - now) / (1000 * 60 * 60);
              return hoursDiff > 0 && hoursDiff <= 48 && event.status === 'scheduled';
            });
            
            return upcoming.sort((a, b) => {
              const dateA = new Date(a.date + 'T' + a.time);
              const dateB = new Date(b.date + 'T' + b.time);
              return dateA - dateB;
            });
          };
          
          const daysOfWeek = getDaysOfWeek();
          const upcomingDeadlines = getUpcomingDeadlines();
          
          return (
            <div className="space-y-4">
              {/* Nawigacja tygodni */}
              <div className="flex justify-between items-center mb-4">
                <button 
                  onClick={() => setSelectedWeek(selectedWeek - 1)}
                  className="p-2 hover:bg-gray-700 rounded transition"
                >
                  <i className="fas fa-chevron-left"></i>
                </button>
                
                <h3 className="text-lg font-medium">
                  {selectedWeek === 0 ? 'Ten tydzień' : 
                   selectedWeek === 1 ? 'Przyszły tydzień' :
                   selectedWeek === -1 ? 'Poprzedni tydzień' :
                   `${selectedWeek > 0 ? '+' : ''}${selectedWeek} tyg.`}
                </h3>
                
                <button 
                  onClick={() => setSelectedWeek(selectedWeek + 1)}
                  className="p-2 hover:bg-gray-700 rounded transition"
                >
                  <i className="fas fa-chevron-right"></i>
                </button>
              </div>
              
              {/* Widok tygodniowy */}
              <div className="grid grid-cols-7 gap-2 text-xs">
                {['Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'Sb', 'Nd'].map((day, idx) => (
                  <div key={idx} className="text-center font-semibold text-gray-400">
                    {day}
                  </div>
                ))}
                
                {daysOfWeek.map((date, idx) => {
                  const dayEvents = getEventsForDay(date);
                  const dayClasses = `
                    p-2 rounded-lg border transition cursor-pointer
                    ${isToday(date) ? 'border-purple-500 bg-purple-900/20' : 'border-gray-700'}
                    ${isPast(date) ? 'opacity-50' : ''}
                    ${dayEvents.length > 0 ? 'hover:bg-gray-700' : 'hover:bg-gray-800'}
                  `;
                  
                  return (
                    <div key={idx} className={dayClasses}>
                      <div className="text-center mb-1">
                        <span className={isToday(date) ? 'font-bold text-purple-400' : ''}>
                          {date.getDate()}
                        </span>
                      </div>
                      
                      {dayEvents.slice(0, 2).map((event, eventIdx) => (
                        <div 
                          key={eventIdx}
                          className="mb-1 p-1 rounded text-xs"
                          style={{ backgroundColor: event.color + '30' }}
                          title={`${event.title} - ${formatTime(event.time)}`}
                        >
                          <i className={`fas ${getEventIcon(event.type).split(' ')[0]} mr-1`}></i>
                          <span className="truncate">{formatTime(event.time)}</span>
                        </div>
                      ))}
                      
                      {dayEvents.length > 2 && (
                        <div className="text-xs text-gray-400 text-center">
                          +{dayEvents.length - 2}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
              
              {/* Nadchodzące terminy */}
              {upcomingDeadlines.length > 0 && (
                <div className="mt-4 p-3 bg-yellow-900/20 border border-yellow-600 rounded-lg">
                  <h4 className="text-sm font-semibold mb-2 text-yellow-400">
                    <i className="fas fa-exclamation-triangle mr-2"></i>
                    Zbliżające się terminy (48h)
                  </h4>
                  <div className="space-y-2">
                    {upcomingDeadlines.map((event, idx) => {
                      const eventDate = new Date(event.date + 'T' + event.time);
                      const hoursLeft = Math.ceil((eventDate - new Date()) / (1000 * 60 * 60));
                      
                      return (
                        <div key={idx} className="flex items-center justify-between text-sm">
                          <div className="flex items-center">
                            <i className={`fas ${getEventIcon(event.type)} mr-2`}></i>
                            <span>{event.title}</span>
                          </div>
                          <span className="text-xs text-gray-400">
                            za {hoursLeft}h
                          </span>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
              
              {/* Lista wydarzeń na ten tydzień */}
              <div className="mt-4">
                <h4 className="text-sm font-semibold mb-2">Wydarzenia w tym tygodniu:</h4>
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {events.length === 0 ? (
                    <p className="text-sm text-gray-400">Brak zaplanowanych wydarzeń</p>
                  ) : (
                    events.map((event, idx) => {
                      const eventDate = new Date(event.date);
                      const dayName = eventDate.toLocaleDateString('pl-PL', { weekday: 'short' });
                      
                      return (
                        <div 
                          key={idx} 
                          className="flex items-center justify-between p-2 bg-gray-800 rounded hover:bg-gray-700 transition"
                        >
                          <div className="flex items-center flex-1">
                            <i className={`fas ${getEventIcon(event.type)} mr-3`}></i>
                            <div>
                              <p className="text-sm font-medium">{event.title}</p>
                              <p className="text-xs text-gray-400">
                                {dayName}, {eventDate.getDate()}.{eventDate.getMonth() + 1} o {formatTime(event.time)}
                                {event.subject && ` • ${event.subject}`}
                              </p>
                            </div>
                          </div>
                          {event.status === 'cancelled' && (
                            <span className="text-xs text-red-400 ml-2">Anulowane</span>
                          )}
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
              
              {/* Przycisk do pełnego kalendarza */}
              <div className="text-center mt-4">
                <button 
                  onClick={() => setSelectedWeek(0)}
                  className="text-sm text-purple-400 hover:text-purple-300"
                >
                  <i className="fas fa-calendar mr-2"></i>
                  Powrót do bieżącego tygodnia
                </button>
              </div>
            </div>
          );
        }

        // Komponent wyników ucznia
        function StudentResults({ results }) {
          const [comments, setComments] = useState({});
          
          // Załaduj komentarze z localStorage
          useEffect(() => {
            const savedComments = JSON.parse(localStorage.getItem('examComments') || '{}');
            setComments(savedComments);
          }, []);
          
          if (results.length === 0) {
            return <p className="text-gray-400">Nie rozwiązałeś jeszcze żadnego arkusza</p>;
          }

          return (
            <div className="space-y-3 max-h-96 overflow-y-auto">
              {results.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt)).map((result, idx) => {
                const resultId = `${result.studentId}_${result.examId}_${result.completedAt}`;
                const teacherComment = comments[resultId];
                
                return (
                  <div key={idx} className="p-4 bg-gray-800 rounded">
                    <h3 className="font-medium">{result.examTitle}</h3>
                    <p className="text-sm text-gray-400">
                      Data: {new Date(result.completedAt).toLocaleDateString()}
                    </p>
                    <p className={`text-lg font-bold ${result.percentage >= 50 ? 'text-green-400' : 'text-red-400'}`}>
                      Wynik: {result.percentage}%
                    </p>
                    <p className="text-xs text-gray-500">
                      Czas: {Math.floor((result.timeSpent || 0) / 60)} min
                    </p>
                    {teacherComment && (
                      <div className="mt-3 p-3 bg-purple-900 bg-opacity-30 rounded-lg border border-purple-600">
                        <p className="text-xs text-purple-400 mb-1">
                          <i className="fas fa-comment mr-1"></i>Komentarz nauczyciela:
                        </p>
                        <p className="text-sm text-gray-300">{teacherComment}</p>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          );
        }

        // Komponent statystyk ucznia
        function StudentStatistics({ userId }) {
          const results = JSON.parse(localStorage.getItem('examResults') || '[]')
            .filter(r => r.studentId === userId);
          
          const [activeTab, setActiveTab] = useState('overview');
          const chartRefs = {
            trend: useRef(null),
            subject: useRef(null),
            topic: useRef(null)
          };
          const chartInstances = useRef({});
          
          useEffect(() => {
            // Cleanup wykresów przy unmount
            return () => {
              Object.values(chartInstances.current).forEach(chart => {
                if (chart) chart.destroy();
              });
            };
          }, []);
          
          useEffect(() => {
            if (results.length > 0) {
              if (activeTab === 'trend') drawTrendChart();
              if (activeTab === 'subjects') drawSubjectChart();
              if (activeTab === 'topics') drawTopicChart();
            }
          }, [activeTab, results]);
          
          if (results.length === 0) {
            return <p className="text-gray-400">Brak danych do wyświetlenia</p>;
          }
          
          const stats = {
            totalExams: results.length,
            avgScore: results.reduce((sum, r) => sum + r.percentage, 0) / results.length,
            bestScore: Math.max(...results.map(r => r.percentage)),
            worstScore: Math.min(...results.map(r => r.percentage)),
            totalTime: results.reduce((sum, r) => sum + (r.timeSpent || 0), 0),
            passedExams: results.filter(r => r.percentage >= 50).length
          };
          
          // Oblicz wskaźnik poprawy/pogorszenia (ostatnie 10 egzaminów vs poprzednie 10)
          const calculateImprovement = () => {
            if (results.length < 2) return null;
            
            const sortedResults = [...results].sort((a, b) => 
              new Date(b.completedAt) - new Date(a.completedAt)
            );
            
            const recent = sortedResults.slice(0, Math.min(10, Math.floor(results.length / 2)));
            const older = sortedResults.slice(recent.length, recent.length * 2);
            
            if (older.length === 0) return null;
            
            const recentAvg = recent.reduce((sum, r) => sum + r.percentage, 0) / recent.length;
            const olderAvg = older.reduce((sum, r) => sum + r.percentage, 0) / older.length;
            
            return {
              change: recentAvg - olderAvg,
              recentAvg,
              olderAvg,
              recentCount: recent.length,
              olderCount: older.length
            };
          };
          
          const improvement = calculateImprovement();
          
          // Funkcja do rysowania wykresu trendu
          const drawTrendChart = () => {
            const ctx = chartRefs.trend.current?.getContext('2d');
            if (!ctx) return;
            
            // Zniszcz poprzedni wykres jeśli istnieje
            if (chartInstances.current.trend) {
              chartInstances.current.trend.destroy();
            }
            
            // Przygotuj dane dla ostatnich 30 dni
            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            
            const recentResults = results
              .filter(r => new Date(r.completedAt) >= thirtyDaysAgo)
              .sort((a, b) => new Date(a.completedAt) - new Date(b.completedAt));
            
            // Grupuj wyniki po dniach
            const dailyScores = {};
            recentResults.forEach(result => {
              const date = new Date(result.completedAt).toLocaleDateString();
              if (!dailyScores[date]) {
                dailyScores[date] = [];
              }
              dailyScores[date].push(result.percentage);
            });
            
            // Oblicz średnie dzienne
            const labels = Object.keys(dailyScores);
            const data = labels.map(date => {
              const scores = dailyScores[date];
              return scores.reduce((sum, score) => sum + score, 0) / scores.length;
            });
            
            chartInstances.current.trend = new Chart(ctx, {
              type: 'line',
              data: {
                labels,
                datasets: [{
                  label: 'Średni wynik dzienny',
                  data,
                  borderColor: '#8b5cf6',
                  backgroundColor: 'rgba(139, 92, 246, 0.1)',
                  tension: 0.4,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: (context) => `Wynik: ${context.parsed.y.toFixed(1)}%`
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                      callback: (value) => value + '%',
                      color: '#9ca3af'
                    },
                    grid: {
                      color: 'rgba(156, 163, 175, 0.1)'
                    }
                  },
                  x: {
                    ticks: {
                      color: '#9ca3af',
                      maxRotation: 45,
                      minRotation: 45
                    },
                    grid: {
                      display: false
                    }
                  }
                }
              }
            });
          };
          
          // Funkcja do rysowania wykresu kołowego przedmiotów
          const drawSubjectChart = () => {
            const ctx = chartRefs.subject.current?.getContext('2d');
            if (!ctx) return;
            
            if (chartInstances.current.subject) {
              chartInstances.current.subject.destroy();
            }
            
            // Przygotuj dane per przedmiot
            const subjectStats = {};
            results.forEach(result => {
              if (result.questions) {
                result.questions.forEach((q, idx) => {
                  const subject = q.przedmiot || 'Inne';
                  if (!subjectStats[subject]) {
                    subjectStats[subject] = { correct: 0, total: 0 };
                  }
                  subjectStats[subject].total++;
                  if (result.answers && result.answers[q.id] === q.poprawna) {
                    subjectStats[subject].correct++;
                  }
                });
              }
            });
            
            const labels = Object.keys(subjectStats);
            const data = labels.map(subject => 
              (subjectStats[subject].correct / subjectStats[subject].total) * 100
            );
            
            chartInstances.current.subject = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels,
                datasets: [{
                  data,
                  backgroundColor: [
                    '#8b5cf6',
                    '#ec4899',
                    '#f59e0b',
                    '#10b981',
                    '#3b82f6',
                    '#ef4444'
                  ],
                  borderWidth: 2,
                  borderColor: '#1f2937'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'right',
                    labels: {
                      color: '#9ca3af',
                      padding: 10,
                      font: {
                        size: 12
                      }
                    }
                  },
                  tooltip: {
                    callbacks: {
                      label: (context) => {
                        const label = context.label || '';
                        const value = context.parsed.toFixed(1);
                        const total = subjectStats[label].total;
                        return `${label}: ${value}% (${subjectStats[label].correct}/${total})`;
                      }
                    }
                  }
                }
              }
            });
          };
          
          // Funkcja do rysowania statystyk per temat
          const drawTopicChart = () => {
            const ctx = chartRefs.topic.current?.getContext('2d');
            if (!ctx) return;
            
            if (chartInstances.current.topic) {
              chartInstances.current.topic.destroy();
            }
            
            // Przygotuj dane per temat
            const topicStats = {};
            results.forEach(result => {
              if (result.questions) {
                result.questions.forEach((q, idx) => {
                  const topic = q.temat || 'Inne';
                  if (!topicStats[topic]) {
                    topicStats[topic] = { correct: 0, total: 0 };
                  }
                  topicStats[topic].total++;
                  if (result.answers && result.answers[q.id] === q.poprawna) {
                    topicStats[topic].correct++;
                  }
                });
              }
            });
            
            // Sortuj tematy według liczby pytań
            const sortedTopics = Object.entries(topicStats)
              .sort((a, b) => b[1].total - a[1].total)
              .slice(0, 10); // Top 10 tematów
            
            const labels = sortedTopics.map(([topic]) => topic);
            const correctData = sortedTopics.map(([_, stats]) => stats.correct);
            const incorrectData = sortedTopics.map(([_, stats]) => stats.total - stats.correct);
            
            chartInstances.current.topic = new Chart(ctx, {
              type: 'bar',
              data: {
                labels,
                datasets: [
                  {
                    label: 'Poprawne',
                    data: correctData,
                    backgroundColor: '#10b981'
                  },
                  {
                    label: 'Błędne',
                    data: incorrectData,
                    backgroundColor: '#ef4444'
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    stacked: true,
                    ticks: {
                      color: '#9ca3af',
                      maxRotation: 45,
                      minRotation: 45
                    },
                    grid: {
                      display: false
                    }
                  },
                  y: {
                    stacked: true,
                    ticks: {
                      color: '#9ca3af'
                    },
                    grid: {
                      color: 'rgba(156, 163, 175, 0.1)'
                    }
                  }
                },
                plugins: {
                  legend: {
                    labels: {
                      color: '#9ca3af'
                    }
                  },
                  tooltip: {
                    callbacks: {
                      afterLabel: (context) => {
                        const topic = context.label;
                        const stats = topicStats[topic];
                        const percentage = ((stats.correct / stats.total) * 100).toFixed(1);
                        return `Skuteczność: ${percentage}%`;
                      }
                    }
                  }
                }
              }
            });
          };
          
          return (
            <div className="space-y-6">
              {/* Podstawowe statystyki */}
              <div className="grid md:grid-cols-3 gap-4">
                <div className="text-center">
                  <p className="text-sm text-gray-400">Średni wynik</p>
                  <p className="text-2xl font-bold gradient-text">{stats.avgScore.toFixed(1)}%</p>
                </div>
                <div className="text-center">
                  <p className="text-sm text-gray-400">Najlepszy wynik</p>
                  <p className="text-2xl font-bold text-green-400">{stats.bestScore}%</p>
                </div>
                <div className="text-center">
                  <p className="text-sm text-gray-400">Zdane egzaminy</p>
                  <p className="text-2xl font-bold">{stats.passedExams}/{stats.totalExams}</p>
                </div>
                <div className="text-center">
                  <p className="text-sm text-gray-400">Łączny czas</p>
                  <p className="text-2xl font-bold">{Math.floor(stats.totalTime / 60)} min</p>
                </div>
                <div className="text-center">
                  <p className="text-sm text-gray-400">Najgorszy wynik</p>
                  <p className="text-2xl font-bold text-red-400">{stats.worstScore}%</p>
                </div>
                <div className="text-center">
                  <p className="text-sm text-gray-400">Procent zdanych</p>
                  <p className="text-2xl font-bold">{((stats.passedExams / stats.totalExams) * 100).toFixed(0)}%</p>
                </div>
              </div>
              
              {/* Wskaźnik poprawy/pogorszenia */}
              {improvement && (
                <div className="card-modern p-4">
                  <h4 className="text-sm font-semibold mb-2 text-gray-400">Trend wyników</h4>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-500">
                        Ostatnie {improvement.recentCount} egzaminów: {improvement.recentAvg.toFixed(1)}%
                      </p>
                      <p className="text-sm text-gray-500">
                        Poprzednie {improvement.olderCount} egzaminów: {improvement.olderAvg.toFixed(1)}%
                      </p>
                    </div>
                    <div className={`text-2xl font-bold flex items-center gap-2 ${
                      improvement.change > 0 ? 'text-green-400' : 'text-red-400'
                    }`}>
                      <i className={`fas fa-arrow-${improvement.change > 0 ? 'up' : 'down'}`}></i>
                      {Math.abs(improvement.change).toFixed(1)}%
                    </div>
                  </div>
                </div>
              )}
              
              {/* Zakładki z wykresami */}
              <div className="card-modern">
                <div className="flex border-b border-gray-700 mb-4">
                  <button
                    onClick={() => setActiveTab('overview')}
                    className={`px-4 py-2 font-medium transition ${
                      activeTab === 'overview' 
                        ? 'text-purple-400 border-b-2 border-purple-400' 
                        : 'text-gray-400 hover:text-gray-300'
                    }`}
                  >
                    Przegląd
                  </button>
                  <button
                    onClick={() => setActiveTab('trend')}
                    className={`px-4 py-2 font-medium transition ${
                      activeTab === 'trend' 
                        ? 'text-purple-400 border-b-2 border-purple-400' 
                        : 'text-gray-400 hover:text-gray-300'
                    }`}
                  >
                    Trend (30 dni)
                  </button>
                  <button
                    onClick={() => setActiveTab('subjects')}
                    className={`px-4 py-2 font-medium transition ${
                      activeTab === 'subjects' 
                        ? 'text-purple-400 border-b-2 border-purple-400' 
                        : 'text-gray-400 hover:text-gray-300'
                    }`}
                  >
                    Przedmioty
                  </button>
                  <button
                    onClick={() => setActiveTab('topics')}
                    className={`px-4 py-2 font-medium transition ${
                      activeTab === 'topics' 
                        ? 'text-purple-400 border-b-2 border-purple-400' 
                        : 'text-gray-400 hover:text-gray-300'
                    }`}
                  >
                    Tematy
                  </button>
                </div>
                
                <div className="min-h-[300px]">
                  {activeTab === 'overview' && (
                    <div className="text-center py-8">
                      <p className="text-gray-400 mb-4">
                        Wybierz zakładkę, aby zobaczyć szczegółowe wykresy
                      </p>
                      <div className="grid md:grid-cols-2 gap-4 text-left max-w-2xl mx-auto">
                        <div className="bg-gray-800/50 p-4 rounded-lg">
                          <h5 className="font-semibold text-purple-400 mb-2">
                            <i className="fas fa-chart-line mr-2"></i>Trend
                          </h5>
                          <p className="text-sm text-gray-400">
                            Wykres pokazujący jak zmieniały się Twoje wyniki w ciągu ostatnich 30 dni
                          </p>
                        </div>
                        <div className="bg-gray-800/50 p-4 rounded-lg">
                          <h5 className="font-semibold text-pink-400 mb-2">
                            <i className="fas fa-chart-pie mr-2"></i>Przedmioty
                          </h5>
                          <p className="text-sm text-gray-400">
                            Rozkład skuteczności odpowiedzi w podziale na przedmioty
                          </p>
                        </div>
                        <div className="bg-gray-800/50 p-4 rounded-lg md:col-span-2">
                          <h5 className="font-semibold text-yellow-400 mb-2">
                            <i className="fas fa-chart-bar mr-2"></i>Tematy
                          </h5>
                          <p className="text-sm text-gray-400">
                            Top 10 najczęściej pojawiających się tematów z podziałem na poprawne i błędne odpowiedzi
                          </p>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {activeTab === 'trend' && (
                    <div className="h-[300px]">
                      <canvas ref={chartRefs.trend}></canvas>
                    </div>
                  )}
                  
                  {activeTab === 'subjects' && (
                    <div className="h-[300px]">
                      <canvas ref={chartRefs.subject}></canvas>
                    </div>
                  )}
                  
                  {activeTab === 'topics' && (
                    <div className="h-[300px]">
                      <canvas ref={chartRefs.topic}></canvas>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // Komponent panelu rywalizacji
        function CompetitionPanel({ userId, userCategory }) {
          const [activeTab, setActiveTab] = useState('ranking');
          const [rankingType, setRankingType] = useState('global');
          const [rankings, setRankings] = useState([]);
          const [userStats, setUserStats] = useState(null);
          const [challenges, setChallenges] = useState([]);
          const [tournaments, setTournaments] = useState([]);
          const [students, setStudents] = useState([]);
          const [selectedStudent, setSelectedStudent] = useState('');
          const [challengeMessage, setChallengeMessage] = useState('');

          useEffect(() => {
            loadRankings();
            loadUserStats();
            loadChallenges();
            loadTournaments();
            loadStudents();
          }, [rankingType]);

          const loadRankings = () => {
            const results = JSON.parse(localStorage.getItem('examResults') || '[]');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            // Oblicz punkty dla każdego ucznia
            const studentScores = {};
            
            results.forEach(result => {
              if (!studentScores[result.studentId]) {
                const user = users.find(u => u.userId === result.studentId);
                studentScores[result.studentId] = {
                  userId: result.studentId,
                  name: result.studentName || user?.username || 'Nieznany',
                  category: user?.category || 'Brak',
                  totalPoints: 0,
                  examCount: 0,
                  avgScore: 0,
                  wins: 0
                };
              }
              
              // Filtruj wyniki w zależności od typu rankingu
              const resultDate = new Date(result.completedAt);
              const now = new Date();
              const daysDiff = Math.floor((now - resultDate) / (1000 * 60 * 60 * 24));
              
              if (rankingType === 'weekly' && daysDiff > 7) return;
              if (rankingType === 'monthly' && daysDiff > 30) return;
              
              studentScores[result.studentId].totalPoints += result.earnedPoints || 0;
              studentScores[result.studentId].examCount++;
            });
            
            // Oblicz średni wynik i rangę
            Object.values(studentScores).forEach(student => {
              student.avgScore = student.examCount > 0 
                ? Math.round(student.totalPoints / student.examCount) 
                : 0;
            });
            
            // Sortuj i przypisz rangi
            const sorted = Object.values(studentScores)
              .sort((a, b) => b.totalPoints - a.totalPoints)
              .slice(0, 10);
            
            sorted.forEach((student, index) => {
              student.rank = index + 1;
            });
            
            setRankings(sorted);
          };

          const loadUserStats = () => {
            const results = JSON.parse(localStorage.getItem('examResults') || '[]');
            const userResults = results.filter(r => r.studentId === userId);
            
            const stats = {
              totalPoints: userResults.reduce((sum, r) => sum + (r.earnedPoints || 0), 0),
              examCount: userResults.length,
              avgScore: 0,
              rank: 0,
              wins: 0
            };
            
            if (stats.examCount > 0) {
              stats.avgScore = Math.round(stats.totalPoints / stats.examCount);
            }
            
            // Znajdź pozycję w rankingu
            const allStudents = JSON.parse(localStorage.getItem('examResults') || '[]')
              .reduce((acc, result) => {
                if (!acc[result.studentId]) {
                  acc[result.studentId] = { totalPoints: 0 };
                }
                acc[result.studentId].totalPoints += result.earnedPoints || 0;
                return acc;
              }, {});
            
            const sortedIds = Object.entries(allStudents)
              .sort((a, b) => b[1].totalPoints - a[1].totalPoints)
              .map(([id]) => id);
            
            stats.rank = sortedIds.indexOf(userId) + 1;
            
            setUserStats(stats);
          };

          const loadChallenges = () => {
            const challengesData = JSON.parse(localStorage.getItem('challenges') || '[]');
            const myChallenges = challengesData.filter(
              c => c.challengerId === userId || c.challengedId === userId
            );
            setChallenges(myChallenges);
          };

          const loadTournaments = () => {
            const tournamentsData = JSON.parse(localStorage.getItem('tournaments') || '[]');
            const activeTournaments = tournamentsData.filter(
              t => t.status === 'active' && 
              (!t.categories || t.categories.includes(userCategory))
            );
            setTournaments(activeTournaments);
          };

          const loadStudents = () => {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const studentUsers = users.filter(
              u => u.role === 'student' && 
              u.userId !== userId &&
              u.category === userCategory
            );
            setStudents(studentUsers);
          };

          const sendChallenge = () => {
            if (!selectedStudent || !challengeMessage) {
              alert('Wybierz ucznia i wpisz wiadomość');
              return;
            }

            const challenges = JSON.parse(localStorage.getItem('challenges') || '[]');
            const newChallenge = {
              id: Date.now(),
              challengerId: userId,
              challengerName: userStats?.name || 'Nieznany',
              challengedId: selectedStudent,
              challengedName: students.find(s => s.userId === selectedStudent)?.username || 'Nieznany',
              message: challengeMessage,
              status: 'pending',
              createdAt: new Date().toISOString()
            };

            challenges.push(newChallenge);
            localStorage.setItem('challenges', JSON.stringify(challenges));
            
            setChallengeMessage('');
            setSelectedStudent('');
            loadChallenges();
            alert('Wyzwanie zostało wysłane!');
          };

          const joinTournament = (tournamentId) => {
            const tournamentsData = JSON.parse(localStorage.getItem('tournaments') || '[]');
            const tournament = tournamentsData.find(t => t.id === tournamentId);
            
            if (tournament) {
              if (!tournament.participants) tournament.participants = [];
              if (!tournament.participants.includes(userId)) {
                tournament.participants.push(userId);
                localStorage.setItem('tournaments', JSON.stringify(tournamentsData));
                loadTournaments();
                alert('Dołączyłeś do turnieju!');
              } else {
                alert('Już jesteś uczestnikiem tego turnieju');
              }
            }
          };

          return (
            <div>
              <div className="flex gap-2 mb-4">
                <button
                  onClick={() => setActiveTab('ranking')}
                  className={`px-4 py-2 rounded ${activeTab === 'ranking' ? 'btn-primary' : 'btn-secondary'}`}
                >
                  Ranking
                </button>
                <button
                  onClick={() => setActiveTab('challenges')}
                  className={`px-4 py-2 rounded ${activeTab === 'challenges' ? 'btn-primary' : 'btn-secondary'}`}
                >
                  Wyzwania
                </button>
                <button
                  onClick={() => setActiveTab('stats')}
                  className={`px-4 py-2 rounded ${activeTab === 'stats' ? 'btn-primary' : 'btn-secondary'}`}
                >
                  Moje statystyki
                </button>
                <button
                  onClick={() => setActiveTab('tournaments')}
                  className={`px-4 py-2 rounded ${activeTab === 'tournaments' ? 'btn-primary' : 'btn-secondary'}`}
                >
                  Turnieje
                </button>
              </div>

              {activeTab === 'ranking' && (
                <div>
                  <div className="flex gap-2 mb-4">
                    <button
                      onClick={() => {setRankingType('global'); loadRankings();}}
                      className={`px-3 py-1 rounded text-sm ${rankingType === 'global' ? 'bg-purple-600' : 'bg-gray-700'}`}
                    >
                      Globalny
                    </button>
                    <button
                      onClick={() => {setRankingType('weekly'); loadRankings();}}
                      className={`px-3 py-1 rounded text-sm ${rankingType === 'weekly' ? 'bg-purple-600' : 'bg-gray-700'}`}
                    >
                      Tygodniowy
                    </button>
                    <button
                      onClick={() => {setRankingType('monthly'); loadRankings();}}
                      className={`px-3 py-1 rounded text-sm ${rankingType === 'monthly' ? 'bg-purple-600' : 'bg-gray-700'}`}
                    >
                      Miesięczny
                    </button>
                  </div>

                  <div className="space-y-2">
                    {rankings.map((student) => (
                      <div 
                        key={student.userId} 
                        className={`p-3 rounded flex justify-between items-center ${
                          student.userId === userId ? 'bg-purple-500/20 border border-purple-500' : 'bg-gray-800'
                        }`}
                      >
                        <div className="flex items-center gap-3">
                          <span className={`text-2xl font-bold ${
                            student.rank === 1 ? 'text-yellow-400' :
                            student.rank === 2 ? 'text-gray-300' :
                            student.rank === 3 ? 'text-orange-400' : 'text-gray-500'
                          }`}>
                            #{student.rank}
                          </span>
                          <div>
                            <p className="font-medium">{student.name}</p>
                            <p className="text-sm text-gray-400">{student.category}</p>
                          </div>
                        </div>
                        <div className="text-right">
                          <p className="font-bold text-purple-400">{student.totalPoints} pkt</p>
                          <p className="text-sm text-gray-400">{student.examCount} egzaminów</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {activeTab === 'challenges' && (
                <div>
                  <div className="mb-6">
                    <h3 className="text-lg font-semibold mb-3">Wyślij wyzwanie</h3>
                    <div className="space-y-3">
                      <select
                        value={selectedStudent}
                        onChange={(e) => setSelectedStudent(e.target.value)}
                        className="w-full p-2 bg-gray-800 rounded"
                      >
                        <option value="">Wybierz ucznia</option>
                        {students.map(student => (
                          <option key={student.userId} value={student.userId}>
                            {student.username} ({student.category})
                          </option>
                        ))}
                      </select>
                      <input
                        type="text"
                        value={challengeMessage}
                        onChange={(e) => setChallengeMessage(e.target.value)}
                        placeholder="Wiadomość wyzwania..."
                        className="w-full p-2 bg-gray-800 rounded"
                      />
                      <button onClick={sendChallenge} className="btn-primary w-full">
                        <i className="fas fa-paper-plane mr-2"></i>Wyślij wyzwanie
                      </button>
                    </div>
                  </div>

                  <div>
                    <h3 className="text-lg font-semibold mb-3">Moje wyzwania</h3>
                    {challenges.length === 0 ? (
                      <p className="text-gray-400">Brak aktywnych wyzwań</p>
                    ) : (
                      <div className="space-y-2">
                        {challenges.map(challenge => (
                          <div key={challenge.id} className="p-3 bg-gray-800 rounded">
                            <div className="flex justify-between items-start">
                              <div>
                                <p className="font-medium">
                                  {challenge.challengerId === userId ? 
                                    `Wyzwałeś: ${challenge.challengedName}` :
                                    `Wyzwał Cię: ${challenge.challengerName}`
                                  }
                                </p>
                                <p className="text-sm text-gray-400">{challenge.message}</p>
                              </div>
                              <span className={`text-sm px-2 py-1 rounded ${
                                challenge.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400' :
                                challenge.status === 'accepted' ? 'bg-green-500/20 text-green-400' :
                                'bg-red-500/20 text-red-400'
                              }`}>
                                {challenge.status === 'pending' ? 'Oczekuje' :
                                 challenge.status === 'accepted' ? 'Zaakceptowane' : 'Odrzucone'}
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeTab === 'stats' && userStats && (
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-gray-800 p-4 rounded">
                      <p className="text-sm text-gray-400">Pozycja w rankingu</p>
                      <p className="text-2xl font-bold text-purple-400">#{userStats.rank}</p>
                    </div>
                    <div className="bg-gray-800 p-4 rounded">
                      <p className="text-sm text-gray-400">Punkty łącznie</p>
                      <p className="text-2xl font-bold text-purple-400">{userStats.totalPoints}</p>
                    </div>
                    <div className="bg-gray-800 p-4 rounded">
                      <p className="text-sm text-gray-400">Średni wynik</p>
                      <p className="text-2xl font-bold text-purple-400">{userStats.avgScore} pkt</p>
                    </div>
                    <div className="bg-gray-800 p-4 rounded">
                      <p className="text-sm text-gray-400">Rozegranych egzaminów</p>
                      <p className="text-2xl font-bold text-purple-400">{userStats.examCount}</p>
                    </div>
                  </div>
                </div>
              )}

              {activeTab === 'tournaments' && (
                <div>
                  <h3 className="text-lg font-semibold mb-3">Aktywne turnieje</h3>
                  {tournaments.length === 0 ? (
                    <p className="text-gray-400">Brak aktywnych turniejów</p>
                  ) : (
                    <div className="space-y-3">
                      {tournaments.map(tournament => (
                        <div key={tournament.id} className="p-4 bg-gray-800 rounded">
                          <h4 className="font-medium mb-2">{tournament.name}</h4>
                          <p className="text-sm text-gray-400 mb-3">{tournament.description}</p>
                          <div className="flex justify-between items-center">
                            <div className="text-sm">
                              <span className="text-gray-400">Uczestnicy: </span>
                              <span className="text-purple-400">
                                {tournament.participants?.length || 0}/{tournament.maxParticipants || '∞'}
                              </span>
                            </div>
                            <button
                              onClick={() => joinTournament(tournament.id)}
                              className="btn-primary text-sm"
                              disabled={tournament.participants?.includes(userId)}
                            >
                              {tournament.participants?.includes(userId) ? 
                                'Już uczestniczysz' : 'Dołącz do turnieju'}
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        }

        // Komponent wyświetlający osiągnięcia ucznia
        function AchievementsPanel({ userId }) {
          const [achievements, setAchievements] = useState([]);
          const [stats, setStats] = useState({ total: 0, earned: 0, percentage: 0, totalPoints: 0 });
          const achievementsSystem = useRef(null);

          useEffect(() => {
            // Inicjalizuj system osiągnięć
            achievementsSystem.current = new AchievementsSystem();
            
            // Pobierz osiągnięcia
            const allAchievements = achievementsSystem.current.getAllAchievements();
            setAchievements(allAchievements);
            
            // Pobierz statystyki
            const achievementStats = achievementsSystem.current.getAchievementStats();
            setStats(achievementStats);
          }, [userId]);

          const earnedAchievements = achievements.filter(a => a.earned);
          const unearnedAchievements = achievements.filter(a => !a.earned);

          return (
            <div className="achievements-panel">
              <div className="mb-6">
                <h3 className="text-lg font-semibold mb-3">Postęp osiągnięć</h3>
                <div className="bg-gray-800 rounded-full h-6 overflow-hidden mb-2">
                  <div 
                    className="bg-gradient-to-r from-purple-500 to-pink-500 h-full transition-all duration-500 flex items-center justify-center text-xs font-semibold"
                    style={{ width: `${stats.percentage}%` }}
                  >
                    {stats.percentage}%
                  </div>
                </div>
                <div className="flex justify-between text-sm text-gray-400">
                  <span>{stats.earned} z {stats.total} osiągnięć</span>
                  <span className="text-yellow-400">
                    <i className="fas fa-coins mr-1"></i>{stats.totalPoints} punktów
                  </span>
                </div>
              </div>

              <div className="space-y-4">
                {earnedAchievements.length > 0 && (
                  <div>
                    <h4 className="text-md font-semibold mb-2 text-green-400">
                      <i className="fas fa-trophy mr-2"></i>Zdobyte osiągnięcia
                    </h4>
                    <div className="grid gap-3">
                      {earnedAchievements.map(achievement => (
                        <div key={achievement.id} className="bg-green-900/20 border border-green-500/30 rounded-lg p-3 flex items-center gap-3">
                          <div className="text-2xl">{achievement.icon}</div>
                          <div className="flex-1">
                            <h5 className="font-semibold text-green-300">{achievement.name}</h5>
                            <p className="text-sm text-gray-400">{achievement.description}</p>
                            <p className="text-xs text-gray-500 mt-1">
                              Zdobyte: {new Date(achievement.earnedAt).toLocaleDateString()}
                            </p>
                          </div>
                          <div className="text-yellow-400 font-semibold">
                            +{achievement.points}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {unearnedAchievements.length > 0 && (
                  <div>
                    <h4 className="text-md font-semibold mb-2 text-gray-400">
                      <i className="fas fa-lock mr-2"></i>Dostępne osiągnięcia
                    </h4>
                    <div className="grid gap-3">
                      {unearnedAchievements.map(achievement => (
                        <div key={achievement.id} className="bg-gray-800/50 border border-gray-700 rounded-lg p-3 flex items-center gap-3 opacity-75">
                          <div className="text-2xl grayscale">{achievement.icon}</div>
                          <div className="flex-1">
                            <h5 className="font-semibold text-gray-400">{achievement.name}</h5>
                            <p className="text-sm text-gray-500">{achievement.description}</p>
                          </div>
                          <div className="text-gray-500 font-semibold">
                            +{achievement.points}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        // Komponent personalizowanych rekomendacji
        function PersonalizedRecommendations({ userId, selectedStudentId }) {
          const [recommendations, setRecommendations] = useState(null);
          const [loading, setLoading] = useState(true);
          const [selectedTask, setSelectedTask] = useState(null);
          const [studyPlan, setStudyPlan] = useState([]);

          useEffect(() => {
            generateRecommendations();
          }, [userId, selectedStudentId]);

          const generateRecommendations = () => {
            setLoading(true);
            
            // Określ ID ucznia do analizy
            const studentId = selectedStudentId || userId;
            
            // Pobierz wyniki ucznia
            const results = JSON.parse(localStorage.getItem('examResults') || '[]')
              .filter(r => r.studentId === studentId);
            
            if (results.length === 0) {
              setRecommendations({
                strengths: [],
                weaknesses: [],
                recommendedTasks: [],
                summary: "Brak wystarczających danych do wygenerowania rekomendacji. Rozwiąż kilka testów, aby otrzymać spersonalizowane sugestie."
              });
              setLoading(false);
              return;
            }

            // Analiza wyników
            const subjectStats = {};
            const topicStats = {};
            const difficultyStats = { podstawowy: { correct: 0, total: 0 }, średni: { correct: 0, total: 0 }, zaawansowany: { correct: 0, total: 0 } };
            
            results.forEach(result => {
              result.answers.forEach((answer, index) => {
                const question = result.questions[index];
                if (!question) return;
                
                const isCorrect = answer === question.poprawna;
                
                // Statystyki przedmiotów
                if (!subjectStats[question.przedmiot]) {
                  subjectStats[question.przedmiot] = { correct: 0, total: 0 };
                }
                subjectStats[question.przedmiot].total++;
                if (isCorrect) subjectStats[question.przedmiot].correct++;
                
                // Statystyki tematów
                const topic = question.temat || question.dział || 'Inne';
                if (!topicStats[topic]) {
                  topicStats[topic] = { correct: 0, total: 0 };
                }
                topicStats[topic].total++;
                if (isCorrect) topicStats[topic].correct++;
                
                // Statystyki poziomów trudności
                const level = question.poziom || 'podstawowy';
                if (difficultyStats[level]) {
                  difficultyStats[level].total++;
                  if (isCorrect) difficultyStats[level].correct++;
                }
              });
            });

            // Identyfikacja mocnych i słabych stron
            const strengths = [];
            const weaknesses = [];
            
            // Analiza przedmiotów
            Object.entries(subjectStats).forEach(([subject, stats]) => {
              const percentage = (stats.correct / stats.total) * 100;
              if (percentage >= 80) {
                strengths.push({
                  type: 'przedmiot',
                  name: subject,
                  percentage: Math.round(percentage),
                  details: `${stats.correct}/${stats.total} poprawnych odpowiedzi`
                });
              } else if (percentage < 60) {
                weaknesses.push({
                  type: 'przedmiot',
                  name: subject,
                  percentage: Math.round(percentage),
                  details: `${stats.correct}/${stats.total} poprawnych odpowiedzi`
                });
              }
            });
            
            // Analiza tematów
            Object.entries(topicStats).forEach(([topic, stats]) => {
              const percentage = (stats.correct / stats.total) * 100;
              if (stats.total >= 3) { // Analizuj tylko tematy z min. 3 zadaniami
                if (percentage >= 80) {
                  strengths.push({
                    type: 'temat',
                    name: topic,
                    percentage: Math.round(percentage),
                    details: `${stats.correct}/${stats.total} poprawnych odpowiedzi`
                  });
                } else if (percentage < 60) {
                  weaknesses.push({
                    type: 'temat',
                    name: topic,
                    percentage: Math.round(percentage),
                    details: `${stats.correct}/${stats.total} poprawnych odpowiedzi`
                  });
                }
              }
            });

            // Generowanie rekomendacji zadań
            const recommendedTasks = [];
            const allTasks = window.zadania.filter(z => !z.deleted);
            
            // Rekomenduj zadania z słabych obszarów
            weaknesses.forEach(weakness => {
              const relevantTasks = allTasks.filter(task => {
                if (weakness.type === 'przedmiot') {
                  return task.przedmiot === weakness.name;
                } else if (weakness.type === 'temat') {
                  return task.temat === weakness.name || task.dział === weakness.name;
                }
                return false;
              });
              
              // Wybierz do 3 zadań z każdego słabego obszaru
              const selectedTasks = relevantTasks
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(task => ({
                  ...task,
                  reason: `Rekomendowane do poprawy wyników w: ${weakness.name} (obecnie ${weakness.percentage}% poprawnych)`,
                  priority: 'high'
                }));
              
              recommendedTasks.push(...selectedTasks);
            });

            // Dodaj zadania o wyższym poziomie trudności dla mocnych obszarów
            strengths.forEach(strength => {
              const advancedTasks = allTasks.filter(task => {
                const matchesArea = (strength.type === 'przedmiot' && task.przedmiot === strength.name) ||
                                  (strength.type === 'temat' && (task.temat === strength.name || task.dział === strength.name));
                return matchesArea && (task.poziom === 'średni' || task.poziom === 'zaawansowany');
              });
              
              const selectedTasks = advancedTasks
                .sort(() => Math.random() - 0.5)
                .slice(0, 2)
                .map(task => ({
                  ...task,
                  reason: `Wyzwanie dla Twojej mocnej strony: ${strength.name}`,
                  priority: 'medium'
                }));
              
              recommendedTasks.push(...selectedTasks);
            });

            // Usuń duplikaty
            const uniqueTasks = Array.from(new Map(recommendedTasks.map(t => [t.id, t])).values());

            // Generuj plan nauki
            const plan = generateStudyPlan(weaknesses, strengths);
            setStudyPlan(plan);

            setRecommendations({
              strengths: strengths.sort((a, b) => b.percentage - a.percentage),
              weaknesses: weaknesses.sort((a, b) => a.percentage - b.percentage),
              recommendedTasks: uniqueTasks.slice(0, 10),
              summary: generateSummary(strengths, weaknesses)
            });
            
            setLoading(false);
          };

          const generateStudyPlan = (weaknesses, strengths) => {
            const plan = [];
            const days = ['Poniedziałek', 'Wtorek', 'Środa', 'Czwartek', 'Piątek'];
            
            weaknesses.forEach((weakness, index) => {
              if (index < days.length) {
                plan.push({
                  day: days[index],
                  focus: weakness.name,
                  type: weakness.type,
                  duration: '45 minut',
                  tasks: '3-5 zadań',
                  goal: `Poprawić wynik z ${weakness.percentage}% do min. 70%`
                });
              }
            });
            
            return plan;
          };

          const generateSummary = (strengths, weaknesses) => {
            if (strengths.length === 0 && weaknesses.length === 0) {
              return "Kontynuuj rozwiązywanie zadań, aby otrzymać bardziej szczegółową analizę.";
            }
            
            let summary = "";
            if (strengths.length > 0) {
              summary += `Twoje mocne strony to: ${strengths.slice(0, 3).map(s => s.name).join(', ')}. `;
            }
            if (weaknesses.length > 0) {
              summary += `Obszary do poprawy: ${weaknesses.slice(0, 3).map(w => w.name).join(', ')}. `;
            }
            summary += "Skup się na regularnej praktyce w słabszych obszarach.";
            
            return summary;
          };

          const startTask = (task) => {
            // Zapisz wybrane zadanie do lokalnego storage
            const practiceExam = {
              id: Date.now(),
              title: `Ćwiczenie: ${task.przedmiot} - ${task.temat}`,
              questions: [task],
              timeLimit: 10,
              targetCategories: ['all'],
              status: 'practice',
              createdBy: 'System rekomendacji'
            };
            
            localStorage.setItem('currentPracticeExam', JSON.stringify(practiceExam));
            
            // Przekieruj do strony ćwiczeń
            window.location.href = 'test-practice.html?mode=single';
          };

          if (loading) {
            return (
              <div className="text-center py-8">
                <i className="fas fa-spinner fa-spin text-3xl text-purple-400"></i>
                <p className="mt-4 text-gray-400">Analizuję Twoje wyniki...</p>
              </div>
            );
          }

          if (!recommendations) {
            return (
              <div className="text-center py-8">
                <p className="text-gray-400">Brak danych do analizy</p>
              </div>
            );
          }

          return (
            <div className="space-y-6">
              {/* Podsumowanie */}
              <div className="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                <h3 className="text-lg font-semibold mb-2">
                  <i className="fas fa-chart-line mr-2"></i>Podsumowanie analizy
                </h3>
                <p className="text-gray-300">{recommendations.summary}</p>
              </div>

              {/* Mocne i słabe strony */}
              <div className="grid md:grid-cols-2 gap-6">
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-lg font-semibold mb-3 text-green-400">
                    <i className="fas fa-star mr-2"></i>Twoje mocne strony
                  </h3>
                  {recommendations.strengths.length === 0 ? (
                    <p className="text-gray-400">Rozwiąż więcej zadań, aby odkryć swoje mocne strony</p>
                  ) : (
                    <div className="space-y-2">
                      {recommendations.strengths.map((strength, index) => (
                        <div key={index} className="flex justify-between items-center">
                          <div>
                            <span className="font-medium">{strength.name}</span>
                            <span className="text-xs text-gray-400 ml-2">({strength.type})</span>
                          </div>
                          <div className="text-right">
                            <span className="text-green-400 font-semibold">{strength.percentage}%</span>
                            <p className="text-xs text-gray-400">{strength.details}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                  <h3 className="text-lg font-semibold mb-3 text-red-400">
                    <i className="fas fa-exclamation-triangle mr-2"></i>Obszary do poprawy
                  </h3>
                  {recommendations.weaknesses.length === 0 ? (
                    <p className="text-gray-400">Świetnie! Nie wykryto znaczących słabych punktów</p>
                  ) : (
                    <div className="space-y-2">
                      {recommendations.weaknesses.map((weakness, index) => (
                        <div key={index} className="flex justify-between items-center">
                          <div>
                            <span className="font-medium">{weakness.name}</span>
                            <span className="text-xs text-gray-400 ml-2">({weakness.type})</span>
                          </div>
                          <div className="text-right">
                            <span className="text-red-400 font-semibold">{weakness.percentage}%</span>
                            <p className="text-xs text-gray-400">{weakness.details}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Rekomendowane zadania */}
              <div className="bg-gray-800/50 rounded-lg p-4">
                <h3 className="text-lg font-semibold mb-4">
                  <i className="fas fa-tasks mr-2"></i>Rekomendowane zadania
                </h3>
                {recommendations.recommendedTasks.length === 0 ? (
                  <p className="text-gray-400">Brak rekomendacji - rozwiąż więcej testów</p>
                ) : (
                  <div className="space-y-3">
                    {recommendations.recommendedTasks.map((task, index) => (
                      <div key={task.id} className={`p-4 rounded-lg border ${
                        task.priority === 'high' ? 'bg-red-900/20 border-red-500/30' : 'bg-blue-900/20 border-blue-500/30'
                      }`}>
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <h4 className="font-medium mb-1">
                              {task.przedmiot} - {task.temat}
                              <span className={`ml-2 text-xs px-2 py-1 rounded ${
                                task.poziom === 'podstawowy' ? 'bg-green-500/20 text-green-400' :
                                task.poziom === 'średni' ? 'bg-yellow-500/20 text-yellow-400' :
                                'bg-red-500/20 text-red-400'
                              }`}>
                                {task.poziom}
                              </span>
                            </h4>
                            <p className="text-sm text-gray-400 mb-2">{task.reason}</p>
                            <p className="text-sm text-gray-300 line-clamp-2">{task.tresc}</p>
                          </div>
                          <button
                            onClick={() => startTask(task)}
                            className="ml-4 btn-primary text-sm"
                          >
                            <i className="fas fa-play mr-1"></i>Rozwiąż
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Plan nauki */}
              {studyPlan.length > 0 && (
                <div className="bg-gray-800/50 rounded-lg p-4">
                  <h3 className="text-lg font-semibold mb-4">
                    <i className="fas fa-calendar-alt mr-2"></i>Sugerowany plan nauki
                  </h3>
                  <div className="grid md:grid-cols-5 gap-3">
                    {studyPlan.map((day, index) => (
                      <div key={index} className="bg-gray-700/50 rounded-lg p-3">
                        <h4 className="font-semibold text-purple-400 mb-2">{day.day}</h4>
                        <p className="text-sm font-medium mb-1">{day.focus}</p>
                        <p className="text-xs text-gray-400">
                          <i className="fas fa-clock mr-1"></i>{day.duration}
                        </p>
                        <p className="text-xs text-gray-400">
                          <i className="fas fa-tasks mr-1"></i>{day.tasks}
                        </p>
                        <p className="text-xs text-green-400 mt-2">
                          <i className="fas fa-target-arrow mr-1"></i>{day.goal}
                        </p>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          );
        }

        // Widok rodzica
        function ParentView({ user, onLogout }) {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [selectedChild, setSelectedChild] = useState(null);
          const parentPanel = window.navigationIntegration?.modules?.parentPanel || new ParentPanel();
          
          useEffect(() => {
            // Zapisz dane rodzica
            localStorage.setItem('currentParent', JSON.stringify(user));
            parentPanel.loadParentData();
            setSelectedChild(parentPanel.linkedChildren[0]?.userId || null);
          }, []);

          const renderContent = () => {
            switch(activeTab) {
              case 'dashboard':
                return (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold mb-4">Panel Rodzica</h2>
                    {parentPanel.linkedChildren.length === 0 ? (
                      <div className="glass p-8 rounded-xl text-center">
                        <i className="fas fa-user-plus text-6xl text-gray-400 mb-4"></i>
                        <h3 className="text-xl mb-2">Brak połączonych kont</h3>
                        <p className="text-gray-400 mb-4">Poproś dziecko o udostępnienie kodu połączenia</p>
                        <button 
                          onClick={() => setActiveTab('add-child')}
                          className="btn-primary"
                        >
                          <i className="fas fa-plus mr-2"></i>
                          Dodaj dziecko
                        </button>
                      </div>
                    ) : (
                      <>
                        {/* Quick Actions */}
                        <div className="grid md:grid-cols-4 gap-4 mb-6">
                          <div className="card-modern text-center hover:bg-blue-600/20 transition-all cursor-pointer"
                               onClick={() => setActiveTab('reports')}>
                            <div className="text-4xl mb-3">
                              <i className="fas fa-chart-line text-blue-400"></i>
                            </div>
                            <h3 className="font-semibold mb-2">Raporty</h3>
                            <p className="text-sm text-gray-400">
                              Szczegółowe analizy
                            </p>
                          </div>
                          
                          <div className="card-modern text-center hover:bg-green-600/20 transition-all cursor-pointer"
                               onClick={() => window.navigationIntegration?.modules?.pdfExport?.generateParentReport(selectedChild)}>
                            <div className="text-4xl mb-3">
                              <i className="fas fa-file-pdf text-green-400"></i>
                            </div>
                            <h3 className="font-semibold mb-2">Raport PDF</h3>
                            <p className="text-sm text-gray-400">
                              Eksportuj podsumowanie
                            </p>
                          </div>
                          
                          <div className="card-modern text-center hover:bg-purple-600/20 transition-all cursor-pointer"
                               onClick={() => setActiveTab('settings')}>
                            <div className="text-4xl mb-3">
                              <i className="fas fa-cog text-purple-400"></i>
                            </div>
                            <h3 className="font-semibold mb-2">Ustawienia</h3>
                            <p className="text-sm text-gray-400">
                              Konfiguracja konta
                            </p>
                          </div>
                          
                          <div className="card-modern text-center hover:bg-yellow-600/20 transition-all cursor-pointer"
                               onClick={() => setActiveTab('add-child')}>
                            <div className="text-4xl mb-3">
                              <i className="fas fa-user-plus text-yellow-400"></i>
                            </div>
                            <h3 className="font-semibold mb-2">Dodaj dziecko</h3>
                            <p className="text-sm text-gray-400">
                              Połącz nowe konto
                            </p>
                          </div>
                        </div>
                        
                        {/* Child Selection */}
                        <div className="card-modern">
                          <h3 className="text-lg font-semibold mb-4">
                            <i className="fas fa-users mr-2 text-purple-400"></i>
                            Wybierz dziecko
                          </h3>
                          <div className="flex gap-2 mb-4">
                            {parentPanel.linkedChildren.map(child => (
                              <button
                                key={child.userId}
                                onClick={() => setSelectedChild(child.userId)}
                                className={`px-4 py-2 rounded-lg transition-all ${
                                  selectedChild === child.userId 
                                    ? 'bg-purple-600 text-white' 
                                    : 'glass hover:bg-purple-600/20'
                                }`}
                              >
                                {child.fullName || child.username}
                              </button>
                            ))}
                          </div>
                        </div>
                        
                        {/* Child Dashboard */}
                        <div className="card-modern">
                          <h3 className="text-lg font-semibold mb-4">
                            <i className="fas fa-chart-bar mr-2 text-blue-400"></i>
                            Dashboard dziecka
                          </h3>
                          <div dangerouslySetInnerHTML={{ 
                            __html: parentPanel.renderChildDashboard(selectedChild) 
                          }} />
                        </div>
                      </>
                    )}
                  </div>
                );
              
              case 'reports':
                return (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold mb-4">Raporty</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <button 
                        onClick={() => window.navigationIntegration?.modules?.pdfExport?.generateParentReport(selectedChild)}
                        className="glass p-6 rounded-xl hover:bg-purple-600/20 transition-all text-left"
                      >
                        <i className="fas fa-file-pdf text-3xl text-red-400 mb-3"></i>
                        <h3 className="font-semibold mb-1">Raport miesięczny</h3>
                        <p className="text-sm text-gray-400">Szczegółowe podsumowanie postępów</p>
                      </button>
                      
                      <button 
                        onClick={() => window.navigationIntegration?.modules?.pdfExport?.generateProgressReport(selectedChild)}
                        className="glass p-6 rounded-xl hover:bg-purple-600/20 transition-all text-left"
                      >
                        <i className="fas fa-chart-line text-3xl text-green-400 mb-3"></i>
                        <h3 className="font-semibold mb-1">Analiza postępów</h3>
                        <p className="text-sm text-gray-400">Trendy i obszary do poprawy</p>
                      </button>
                    </div>
                  </div>
                );
              
              case 'settings':
                return (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold mb-4">Ustawienia</h2>
                    <div dangerouslySetInnerHTML={{ 
                      __html: parentPanel.renderSettings() 
                    }} />
                  </div>
                );
              
              case 'add-child':
                return (
                  <div className="space-y-6">
                    <h2 className="text-2xl font-bold mb-4">Dodaj dziecko</h2>
                    <div className="glass p-6 rounded-xl max-w-md mx-auto">
                      <p className="mb-4">Wprowadź kod połączenia udostępniony przez dziecko:</p>
                      <input 
                        type="text" 
                        id="link-code"
                        placeholder="XXXX-XXXX-XXXX"
                        className="input-modern w-full mb-4"
                      />
                      <button 
                        onClick={() => {
                          const code = document.getElementById('link-code').value;
                          if (parentPanel.linkChildAccount(code)) {
                            alert('Konto zostało połączone!');
                            setActiveTab('dashboard');
                            window.location.reload();
                          } else {
                            alert('Nieprawidłowy kod');
                          }
                        }}
                        className="btn-primary w-full"
                      >
                        Połącz konto
                      </button>
                    </div>
                  </div>
                );
              
              default:
                return null;
            }
          };

          return (
            <div className="container mx-auto p-6">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold gradient-text">Panel Rodzica</h1>
                <div className="flex items-center gap-4">
                  <span className="text-gray-300">
                    <i className="fas fa-user-circle mr-2"></i>
                    {user.fullName || user.username}
                  </span>
                  <button 
                    onClick={onLogout}
                    className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
                  >
                    <i className="fas fa-sign-out-alt mr-2"></i>
                    Wyloguj
                  </button>
                </div>
              </div>

              <div className="flex gap-2 mb-6">
                <button
                  onClick={() => setActiveTab('dashboard')}
                  className={`px-4 py-2 rounded-lg transition-all ${
                    activeTab === 'dashboard' 
                      ? 'bg-purple-600 text-white' 
                      : 'glass hover:bg-purple-600/20'
                  }`}
                >
                  <i className="fas fa-home mr-2"></i>
                  Panel główny
                </button>
                <button
                  onClick={() => setActiveTab('reports')}
                  className={`px-4 py-2 rounded-lg transition-all ${
                    activeTab === 'reports' 
                      ? 'bg-purple-600 text-white' 
                      : 'glass hover:bg-purple-600/20'
                  }`}
                >
                  <i className="fas fa-chart-bar mr-2"></i>
                  Raporty
                </button>
                <button
                  onClick={() => setActiveTab('settings')}
                  className={`px-4 py-2 rounded-lg transition-all ${
                    activeTab === 'settings' 
                      ? 'bg-purple-600 text-white' 
                      : 'glass hover:bg-purple-600/20'
                  }`}
                >
                  <i className="fas fa-cog mr-2"></i>
                  Ustawienia
                </button>
                <button
                  onClick={() => setActiveTab('add-child')}
                  className={`px-4 py-2 rounded-lg transition-all ${
                    activeTab === 'add-child' 
                      ? 'bg-purple-600 text-white' 
                      : 'glass hover:bg-purple-600/20'
                  }`}
                >
                  <i className="fas fa-user-plus mr-2"></i>
                  Dodaj dziecko
                </button>
              </div>

              <div className="fade-in">
                {renderContent()}
              </div>
            </div>
          );
        }

        // Widok egzaminu
        function ExamView({ exam, user, onFinish }) {
          const [currentQuestion, setCurrentQuestion] = useState(0);
          const [answers, setAnswers] = useState({});
          const [timeLeft, setTimeLeft] = useState(exam.timeLimit * 60);
          const [reportedTasks, setReportedTasks] = useState([]);
          const intervalRef = useRef(null);
          const startTime = useRef(Date.now());

          useEffect(() => {
            intervalRef.current = setInterval(() => {
              setTimeLeft(prev => {
                if (prev <= 1) {
                  handleFinish();
                  return 0;
                }
                return prev - 1;
              });
            }, 1000);

            return () => clearInterval(intervalRef.current);
          }, []);

          const handleAnswer = (answer) => {
            setAnswers({
              ...answers,
              [exam.questions[currentQuestion].id]: answer
            });
          };

          const handleFinish = () => {
            if (intervalRef.current) clearInterval(intervalRef.current);
            
            // Oblicz wynik
            let correctAnswers = 0;
            let totalPoints = 0;
            let earnedPoints = 0;

            exam.questions.forEach(question => {
              totalPoints += question.punkty;
              if (answers[question.id] === question.poprawna) {
                correctAnswers++;
                earnedPoints += question.punkty;
              }
            });

            const result = {
              examId: exam.id,
              examTitle: exam.title,
              studentName: user.username.replace('.', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
              studentId: user.userId,
              category: user.category,
              correctAnswers,
              totalQuestions: exam.questions.length,
              earnedPoints,
              totalPoints,
              percentage: Math.round((earnedPoints / totalPoints) * 100),
              completedAt: new Date(),
              timeSpent: Math.floor((Date.now() - startTime.current) / 1000),
              answers,
              questions: exam.questions // Dodaj pytania do wyniku dla statystyk
            };

            // Zapisz wynik
            const results = JSON.parse(localStorage.getItem('examResults') || '[]');
            results.push(result);
            localStorage.setItem('examResults', JSON.stringify(results));

            // Aktualizuj ranking
            updateRanking(result);

            // Sprawdź nowe osiągnięcia
            const achievementsSystem = new AchievementsSystem();
            const newAchievements = achievementsSystem.updateProgress(result);
            
            // Przekaż informację o nowych osiągnięciach
            onFinish({ ...result, newAchievements });
          };

          const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
          };

          const question = exam.questions[currentQuestion];
          const isTeacher = user.role === 'teacher';

          // Funkcja usuwania zadania (tylko dla nauczyciela)
          const handleDeleteTask = (taskId) => {
            if (!isTeacher) return;
            
            if (confirm('Czy na pewno chcesz usunąć to zadanie z bazy danych?')) {
              // Oznacz zadanie jako usunięte
              const tasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]');
              const updatedTasks = tasks.map(task => {
                if (task.id === taskId) {
                  return { ...task, deleted: true, deletedBy: user.username, deletedAt: new Date() };
                }
                return task;
              });
              
              localStorage.setItem('zadaniaDB', JSON.stringify(updatedTasks));
              window.zadania = updatedTasks.filter(t => !t.deleted);
              
              alert('Zadanie zostało oznaczone jako usunięte');
            }
          };

          // Funkcja zgłaszania zadania (tylko dla ucznia)
          const handleReportTask = (taskId, comment = '') => {
            if (isTeacher) return;
            
            // Sprawdź czy uczeń już zgłosił to zadanie
            const reports = JSON.parse(localStorage.getItem('taskReports') || '[]');
            const existingReport = reports.find(r => r.taskId === taskId && r.studentId === user.userId);
            
            if (existingReport) {
              alert('Już zgłosiłeś to zadanie');
              return;
            }
            
            const report = {
              id: Date.now(),
              taskId: taskId,
              studentId: user.userId,
              studentName: user.username,
              timestamp: new Date(),
              comment: comment,
              examId: exam.id,
              examTitle: exam.title
            };
            
            reports.push(report);
            localStorage.setItem('taskReports', JSON.stringify(reports));
            setReportedTasks([...reportedTasks, taskId]);
            
            alert('Zadanie zostało zgłoszone do nauczyciela');
          };

          return (
            <div className="container mx-auto p-6 max-w-4xl">
              <div className="glass-dark rounded-2xl shadow-2xl p-6">
                <div className="flex justify-between items-center mb-6">
                  <h1 className="text-2xl font-bold">{exam.title}</h1>
                  <div className={`text-xl font-bold ${timeLeft < 300 ? 'text-red-400 pulse-glow' : 'text-gray-300'}`}>
                    <i className="fas fa-clock mr-2"></i>{formatTime(timeLeft)}
                  </div>
                </div>

                <div className="mb-4">
                  <div className="flex gap-2 mb-4 flex-wrap">
                    {exam.questions.map((q, idx) => (
                      <button
                        key={idx}
                        onClick={() => setCurrentQuestion(idx)}
                        className={`w-10 h-10 rounded transition ${
                          idx === currentQuestion ? 'bg-purple-600 text-white' : 
                          answers[q.id] ? 'bg-green-600/30 text-green-400' : 'bg-gray-700 text-gray-400'
                        }`}
                      >
                        {idx + 1}
                      </button>
                    ))}
                  </div>
                  <div className="bg-gray-700 rounded-full h-2 mb-4">
                    <div 
                      className="bg-gradient-to-r from-purple-600 to-pink-600 h-full rounded-full transition-all"
                      style={{ width: `${((currentQuestion + 1) / exam.questions.length) * 100}%` }}
                    ></div>
                  </div>
                </div>

                <div className="mb-6 card-modern">
                  <h2 className="text-lg font-medium mb-2">
                    Zadanie {currentQuestion + 1} z {exam.questions.length}
                  </h2>
                  <p className="text-sm text-gray-400 mb-4">
                    {question.przedmiot} - {question.temat} ({question.punkty} pkt)
                  </p>
                  <p className="text-lg mb-4">{question.tresc}</p>
                  
                  {question.obrazek && (
                    <div className="geometry-image mb-4" dangerouslySetInnerHTML={{ __html: question.obrazek }} />
                  )}

                  {question.typ === 'zamkniete' && (
                    <div className="space-y-2">
                      {question.odpowiedzi.map((odp, idx) => (
                        <label key={idx} className="flex items-center p-3 bg-gray-800 rounded hover:bg-gray-700 cursor-pointer transition">
                          <input
                            type="radio"
                            name="answer"
                            value={odp}
                            checked={answers[question.id] === odp}
                            onChange={() => handleAnswer(odp)}
                            className="mr-3"
                          />
                          <span>{String.fromCharCode(65 + idx)}. {odp}</span>
                        </label>
                      ))}
                    </div>
                  )}
                  
                  {question.typ === 'otwarte' && (
                    <textarea
                      value={answers[question.id] || ''}
                      onChange={(e) => handleAnswer(e.target.value)}
                      className="input-modern w-full h-32"
                      placeholder="Wpisz swoją odpowiedź..."
                    />
                  )}
                  
                  {/* Przyciski akcji */}
                  <div className="mt-4 flex gap-2">
                    {isTeacher && (
                      <button
                        onClick={() => handleDeleteTask(question.id)}
                        className="btn-secondary text-red-400 border-red-400 hover:bg-red-400 hover:text-white"
                      >
                        <i className="fas fa-trash mr-2"></i>Usuń zadanie
                      </button>
                    )}
                    {!isTeacher && (
                      <button
                        onClick={() => {
                          const comment = prompt('Dodaj komentarz do zgłoszenia (opcjonalnie):');
                          handleReportTask(question.id, comment || '');
                        }}
                        disabled={reportedTasks.includes(question.id)}
                        className="btn-secondary text-yellow-400 border-yellow-400 hover:bg-yellow-400 hover:text-black disabled:opacity-50"
                      >
                        <i className="fas fa-flag mr-2"></i>
                        {reportedTasks.includes(question.id) ? 'Zgłoszone' : 'Zgłoś zadanie'}
                      </button>
                    )}
                  </div>
                </div>

                <div className="flex justify-between">
                  <button
                    onClick={() => setCurrentQuestion(Math.max(0, currentQuestion - 1))}
                    disabled={currentQuestion === 0}
                    className="btn-secondary disabled:opacity-50"
                  >
                    <i className="fas fa-arrow-left mr-2"></i>Poprzednie
                  </button>
                  
                  {currentQuestion < exam.questions.length - 1 ? (
                    <button
                      onClick={() => setCurrentQuestion(currentQuestion + 1)}
                      className="btn-primary"
                    >
                      Następne<i className="fas fa-arrow-right ml-2"></i>
                    </button>
                  ) : (
                    <button
                      onClick={handleFinish}
                      className="btn-primary"
                    >
                      <i className="fas fa-check mr-2"></i>Zakończ egzamin
                    </button>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // Widok wyników
        function ResultsView({ results, onBack }) {
          return (
            <div className="container mx-auto p-6 max-w-2xl">
              <div className="glass-dark rounded-2xl shadow-2xl p-8 text-center fade-in">
                <h1 className="text-3xl font-bold mb-6 gradient-text">Wyniki egzaminu</h1>
                
                <div className={`text-6xl font-bold mb-4 ${results.percentage >= 50 ? 'text-green-400' : 'text-red-400'}`}>
                  {results.percentage}%
                </div>
                
                <p className="text-xl mb-6">
                  {results.percentage >= 90 ? 'Doskonale! 🎉' :
                   results.percentage >= 75 ? 'Bardzo dobrze! 👏' :
                   results.percentage >= 50 ? 'Zaliczone! ✅' : 'Spróbuj ponownie 💪'}
                </p>

                <div className="card-modern mb-6">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <p className="text-sm text-gray-400">Poprawne odpowiedzi</p>
                      <p className="text-2xl font-bold">{results.correctAnswers} / {results.totalQuestions}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-400">Punkty</p>
                      <p className="text-2xl font-bold">{results.earnedPoints} / {results.totalPoints}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-400">Czas rozwiązywania</p>
                      <p className="text-2xl font-bold">{Math.floor(results.timeSpent / 60)} min</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-400">Status</p>
                      <p className={`text-2xl font-bold ${results.percentage >= 50 ? 'text-green-400' : 'text-red-400'}`}>
                        {results.percentage >= 50 ? 'Zdany' : 'Niezdany'}
                      </p>
                    </div>
                  </div>
                </div>

                {results.newAchievements && results.newAchievements.length > 0 && (
                  <div className="mb-6 p-4 bg-yellow-500/20 border border-yellow-500 rounded-lg">
                    <h3 className="text-lg font-semibold text-yellow-400 mb-3">
                      <i className="fas fa-trophy mr-2"></i>Nowe osiągnięcia!
                    </h3>
                    <div className="space-y-2">
                      {results.newAchievements.map(achievement => (
                        <div key={achievement.id} className="flex items-center justify-between bg-gray-800/50 rounded p-3">
                          <div className="flex items-center gap-3">
                            <span className="text-2xl">{achievement.icon}</span>
                            <div>
                              <p className="font-semibold text-yellow-300">{achievement.name}</p>
                              <p className="text-sm text-gray-400">{achievement.description}</p>
                            </div>
                          </div>
                          <span className="text-yellow-400 font-bold">+{achievement.points}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <button
                  onClick={onBack}
                  className="btn-primary"
                >
                  <i className="fas fa-home mr-2"></i>Powrót do panelu
                </button>
              </div>
            </div>
          );
        }

        // Funkcja aktualizująca ranking
        function updateRanking(newResult) {
          // Pobierz wszystkie wyniki
          const allResults = JSON.parse(localStorage.getItem('examResults') || '[]');
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          
          // Oblicz statystyki dla każdego ucznia
          const studentStats = {};
          
          allResults.forEach(result => {
            if (!studentStats[result.studentId]) {
              const user = users.find(u => u.userId === result.studentId);
              studentStats[result.studentId] = {
                userId: result.studentId,
                name: result.studentName || user?.username || 'Nieznany',
                category: user?.category || result.category || 'Brak',
                totalPoints: 0,
                examCount: 0,
                avgScore: 0,
                lastUpdate: new Date().toISOString()
              };
            }
            
            studentStats[result.studentId].totalPoints += result.earnedPoints || 0;
            studentStats[result.studentId].examCount++;
          });
          
          // Oblicz średnie wyniki
          Object.values(studentStats).forEach(student => {
            student.avgScore = student.examCount > 0 
              ? Math.round(student.totalPoints / student.examCount) 
              : 0;
          });
          
          // Zapisz zaktualizowane statystyki rankingowe
          localStorage.setItem('rankingStats', JSON.stringify(studentStats));
          
          // Sprawdź i zaktualizuj turnieje
          updateTournamentStandings(newResult);
        }

        // Funkcja aktualizująca wyniki turniejowe
        function updateTournamentStandings(result) {
          const tournaments = JSON.parse(localStorage.getItem('tournaments') || '[]');
          const activeTournaments = tournaments.filter(t => 
            t.status === 'active' && 
            t.participants?.includes(result.studentId)
          );
          
          activeTournaments.forEach(tournament => {
            if (!tournament.standings) tournament.standings = {};
            
            if (!tournament.standings[result.studentId]) {
              tournament.standings[result.studentId] = {
                userId: result.studentId,
                name: result.studentName,
                points: 0,
                examsCount: 0
              };
            }
            
            tournament.standings[result.studentId].points += result.earnedPoints || 0;
            tournament.standings[result.studentId].examsCount++;
          });
          
          localStorage.setItem('tournaments', JSON.stringify(tournaments));
        }

        // Funkcje pomocnicze do eksportu
        function exportStatisticsToExcel(results, filterType) {
          const wb = XLSX.utils.book_new();
          
          // Arkusz główny z wynikami
          const wsData = results.map(r => ({
            'Uczeń': r.studentName,
            'Kategoria': r.category || 'Brak',
            'Arkusz': r.examTitle,
            'Data': new Date(r.completedAt).toLocaleDateString(),
            'Godzina': new Date(r.completedAt).toLocaleTimeString(),
            'Wynik (%)': r.percentage,
            'Punkty': `${r.earnedPoints}/${r.totalPoints}`,
            'Czas (min)': Math.floor((r.timeSpent || 0) / 60),
            'Status': r.percentage >= 50 ? 'Zdany' : 'Niezdany'
          }));
          
          const ws = XLSX.utils.json_to_sheet(wsData);
          XLSX.utils.book_append_sheet(wb, ws, 'Wyniki');
          
          // Arkusz ze statystykami
          const stats = calculateStatistics(results);
          const wsStats = XLSX.utils.json_to_sheet([stats]);
          XLSX.utils.book_append_sheet(wb, wsStats, 'Statystyki');
          
          // Zapisz plik
          const fileName = `statystyki_${filterType}_${new Date().toISOString().split('T')[0]}.xlsx`;
          XLSX.writeFile(wb, fileName);
        }

        function calculateStatistics(results) {
          if (results.length === 0) return {};
          
          const scores = results.map(r => r.percentage);
          const times = results.map(r => r.timeSpent || 0);
          
          return {
            'Liczba egzaminów': results.length,
            'Średni wynik (%)': (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2),
            'Najlepszy wynik (%)': Math.max(...scores),
            'Najgorszy wynik (%)': Math.min(...scores),
            'Procent zdanych': ((scores.filter(s => s >= 50).length / scores.length) * 100).toFixed(2) + '%',
            'Średni czas (min)': Math.floor(times.reduce((a, b) => a + b, 0) / times.length / 60)
          };
        }

        function generateStatisticsReport(results, stats, filterType) {
          // Generuj prosty raport HTML do wydruku
          const reportWindow = window.open('', '_blank');
          const reportDate = new Date().toLocaleDateString();
          
          const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
              <title>Raport statystyk - ${reportDate}</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #333; }
                .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
                .stat-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                .stat-value { font-size: 24px; font-weight: bold; color: #7c3aed; }
                .stat-label { color: #666; font-size: 14px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f4f4f4; }
                @media print { body { padding: 0; } }
              </style>
            </head>
            <body>
              <h1>Raport statystyk egzaminacyjnych</h1>
              <p>Data wygenerowania: ${reportDate}</p>
              <p>Filtr: ${filterType === 'all' ? 'Wszystkie wyniki' : filterType}</p>
              
              <div class="stats-grid">
                <div class="stat-box">
                  <div class="stat-label">Średni wynik</div>
                  <div class="stat-value">${stats.avgScore.toFixed(1)}%</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Liczba egzaminów</div>
                  <div class="stat-value">${stats.totalExams}</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Procent zdanych</div>
                  <div class="stat-value">${stats.passRate.toFixed(1)}%</div>
                </div>
              </div>
              
              <h2>Szczegółowe wyniki</h2>
              <table>
                <thead>
                  <tr>
                    <th>Uczeń</th>
                    <th>Arkusz</th>
                    <th>Data</th>
                    <th>Wynik</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${results.map(r => `
                    <tr>
                      <td>${r.studentName}</td>
                      <td>${r.examTitle}</td>
                      <td>${new Date(r.completedAt).toLocaleDateString()}</td>
                      <td>${r.percentage}%</td>
                      <td>${r.percentage >= 50 ? '✅ Zdany' : '❌ Niezdany'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <${'script'}>
                window.print();
              </${'script'}>
            </body>
            </html>
          `;
          
          reportWindow.document.write(reportHTML);
          reportWindow.document.close();
        }

        // Funkcja eksportu analizy klas do Excel
        function exportClassAnalytics(results, groupStats, difficultTopics, studentRanking, errorAnalysis) {
          // Przygotuj dane do eksportu
          const workbook = [];
          
          // Arkusz 1: Podsumowanie grup
          const groupSummary = Object.entries(groupStats).map(([key, stats]) => ({
            'Grupa': stats.name,
            'Liczba uczniów': stats.studentCount,
            'Liczba egzaminów': stats.examCount,
            'Średni wynik (%)': stats.avgScore.toFixed(1)
          }));
          
          // Arkusz 2: Najtrudniejsze tematy
          const difficultTopicsData = difficultTopics.map(topic => ({
            'Temat': topic.topic,
            'Procent poprawnych (%)': topic.percentage.toFixed(1),
            'Liczba zadań': topic.taskCount,
            'Liczba odpowiedzi': topic.total
          }));
          
          // Arkusz 3: Ranking uczniów
          const studentRankingData = studentRanking.map((student, idx) => ({
            'Miejsce': idx + 1,
            'Uczeń': student.name,
            'Liczba egzaminów': student.totalExams,
            'Średni wynik (%)': student.avgScore.toFixed(1),
            'Najlepszy wynik (%)': student.bestScore.toFixed(0),
            'Najgorszy wynik (%)': student.worstScore.toFixed(0)
          }));
          
          // Arkusz 4: Analiza błędów
          const errorAnalysisData = errorAnalysis.map(task => ({
            'Zadanie': task.question,
            'Temat': task.topic,
            'Przedmiot': task.subject,
            'Procent błędów (%)': task.errorRate.toFixed(1),
            'Błędne odpowiedzi': task.errors,
            'Wszystkie próby': task.attempts
          }));
          
          // Konwertuj dane do CSV
          const csvContent = [
            'ANALIZA GRUP\n' + convertToCSV(groupSummary),
            '\n\nNAJTRUDNIEJSZE TEMATY\n' + convertToCSV(difficultTopicsData),
            '\n\nRANKING UCZNIÓW\n' + convertToCSV(studentRankingData),
            '\n\nANALIZA BŁĘDÓW\n' + convertToCSV(errorAnalysisData)
          ].join('\n');
          
          // Pobierz plik
          downloadFile(csvContent, `analiza_klas_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8');
        }
        
        // Funkcja generowania raportu PDF dla analizy klas
        function generateClassReport(results, groupStats, difficultTopics, studentRanking, errorAnalysis, studentsNeedingHelp) {
          const reportWindow = window.open('', '_blank');
          const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
              <title>Raport analizy klas</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
                h1, h2 { color: #333; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f4f4f4; font-weight: bold; }
                .stat-box { background-color: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 5px; }
                .warning { background-color: #fff3cd; padding: 10px; border-left: 4px solid #ffc107; margin: 20px 0; }
                .success { color: #28a745; }
                .danger { color: #dc3545; }
                @media print {
                  body { margin: 0; }
                  .page-break { page-break-after: always; }
                }
              </style>
            </head>
            <body>
              <h1>Raport analizy klas i grup</h1>
              <p>Data wygenerowania: ${new Date().toLocaleDateString()}</p>
              
              <h2>Podsumowanie grup</h2>
              <table>
                <thead>
                  <tr>
                    <th>Grupa</th>
                    <th>Liczba uczniów</th>
                    <th>Liczba egzaminów</th>
                    <th>Średni wynik</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(groupStats).map(([key, stats]) => `
                    <tr>
                      <td>${stats.name}</td>
                      <td>${stats.studentCount}</td>
                      <td>${stats.examCount}</td>
                      <td class="${stats.avgScore >= 50 ? 'success' : 'danger'}">${stats.avgScore.toFixed(1)}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              ${studentsNeedingHelp.length > 0 ? `
                <div class="warning">
                  <h3>Uczniowie potrzebujący pomocy (średnia < 50%)</h3>
                  <ul>
                    ${studentsNeedingHelp.map(student => `
                      <li>${student.name} - średni wynik: ${student.avgScore.toFixed(1)}%</li>
                    `).join('')}
                  </ul>
                </div>
              ` : ''}
              
              <div class="page-break"></div>
              
              <h2>Najtrudniejsze tematy</h2>
              <table>
                <thead>
                  <tr>
                    <th>Temat</th>
                    <th>Procent poprawnych</th>
                    <th>Liczba zadań</th>
                    <th>Liczba odpowiedzi</th>
                  </tr>
                </thead>
                <tbody>
                  ${difficultTopics.map(topic => `
                    <tr>
                      <td>${topic.topic}</td>
                      <td class="${topic.percentage < 50 ? 'danger' : ''}">${topic.percentage.toFixed(1)}%</td>
                      <td>${topic.taskCount}</td>
                      <td>${topic.total}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <div class="page-break"></div>
              
              <h2>Ranking uczniów (TOP 20)</h2>
              <table>
                <thead>
                  <tr>
                    <th>Miejsce</th>
                    <th>Uczeń</th>
                    <th>Liczba egzaminów</th>
                    <th>Średni wynik</th>
                    <th>Najlepszy</th>
                    <th>Najgorszy</th>
                  </tr>
                </thead>
                <tbody>
                  ${studentRanking.slice(0, 20).map((student, idx) => `
                    <tr>
                      <td>${idx + 1}</td>
                      <td>${student.name}</td>
                      <td>${student.totalExams}</td>
                      <td class="${student.avgScore >= 50 ? 'success' : 'danger'}">${student.avgScore.toFixed(1)}%</td>
                      <td class="success">${student.bestScore.toFixed(0)}%</td>
                      <td class="danger">${student.worstScore.toFixed(0)}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <div class="page-break"></div>
              
              <h2>Zadania sprawiające największe problemy</h2>
              <table>
                <thead>
                  <tr>
                    <th>Zadanie</th>
                    <th>Temat</th>
                    <th>Przedmiot</th>
                    <th>Procent błędów</th>
                    <th>Statystyki</th>
                  </tr>
                </thead>
                <tbody>
                  ${errorAnalysis.map(task => `
                    <tr>
                      <td>${task.question}</td>
                      <td>${task.topic}</td>
                      <td>${task.subject}</td>
                      <td class="danger">${task.errorRate.toFixed(1)}%</td>
                      <td>${task.errors}/${task.attempts}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <div class="stat-box">
                <p><strong>Podsumowanie:</strong></p>
                <ul>
                  <li>Przeanalizowano ${results.length} wyników egzaminów</li>
                  <li>Liczba uczniów potrzebujących pomocy: ${studentsNeedingHelp.length}</li>
                  <li>Najtrudniejszy temat: ${difficultTopics[0]?.topic || 'Brak danych'} (${difficultTopics[0]?.percentage.toFixed(1) || 0}% poprawnych)</li>
                  <li>Najlepszy uczeń: ${studentRanking[0]?.name || 'Brak danych'} (${studentRanking[0]?.avgScore.toFixed(1) || 0}%)</li>
                </ul>
              </div>
              
              <${'script'}>
                window.print();
              </${'script'}>
            </body>
            </html>
          `;
          
          reportWindow.document.write(reportHTML);
          reportWindow.document.close();
        }
        
        // Funkcja pomocnicza do konwersji danych na CSV
        function convertToCSV(data) {
          if (data.length === 0) return '';
          
          const headers = Object.keys(data[0]);
          const csvHeaders = headers.join(',');
          
          const csvRows = data.map(row => 
            headers.map(header => {
              const value = row[header];
              // Escape quotes and wrap in quotes if contains comma
              const escaped = String(value).replace(/"/g, '""');
              return escaped.includes(',') ? `"${escaped}"` : escaped;
            }).join(',')
          );
          
          return [csvHeaders, ...csvRows].join('\n');
        }
        
        // Funkcja pomocnicza do pobierania pliku
        function downloadFile(content, filename, mimeType) {
          const blob = new Blob([content], { type: mimeType });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        // Renderuj aplikację
        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>