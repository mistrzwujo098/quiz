<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ładowania bazy danych</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #e9e9e9;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Test ładowania bazy danych</h1>
    
    <div class="section">
        <h2>Obecny stan bazy</h2>
        <button onclick="checkDatabase()">Sprawdź bazę</button>
        <div id="currentStatus"></div>
    </div>

    <div class="section">
        <h2>Załaduj pliki</h2>
        <button onclick="loadQuizData()">Załaduj quiz_data.json</button>
        <button onclick="loadUpdatedDatabase()">Załaduj updated-exam-database.json</button>
        <div id="loadStatus"></div>
    </div>

    <div class="section">
        <h2>Eksportuj bazę</h2>
        <button onclick="exportDatabase()">Eksportuj do pliku</button>
    </div>

    <div class="section">
        <h2>Wyczyść bazę</h2>
        <button onclick="clearDatabase()" style="background: #dc3545;">Wyczyść bazę</button>
    </div>

    <script>
        function checkDatabase() {
            try {
                const tasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]');
                const status = document.getElementById('currentStatus');
                
                const stats = {
                    total: tasks.length,
                    osmoklasisty: tasks.filter(t => t.przedmiot === 'egzamin ósmoklasisty').length,
                    matura: tasks.filter(t => t.przedmiot === 'matura podstawowa').length,
                    rozszerzona: tasks.filter(t => t.przedmiot === 'matura rozszerzona').length
                };
                
                status.innerHTML = `
                    <p class="success">Baza zawiera ${stats.total} zadań:</p>
                    <ul>
                        <li>Egzamin ósmoklasisty: ${stats.osmoklasisty}</li>
                        <li>Matura podstawowa: ${stats.matura}</li>
                        <li>Matura rozszerzona: ${stats.rozszerzona}</li>
                    </ul>
                    <pre>${JSON.stringify(tasks.slice(0, 2), null, 2)}</pre>
                `;
            } catch (error) {
                document.getElementById('currentStatus').innerHTML = 
                    `<p class="error">Błąd: ${error.message}</p>`;
            }
        }

        async function loadQuizData() {
            try {
                const response = await fetch('./quiz_data.json');
                const data = await response.json();
                
                // Konwertuj format
                const tasksToLoad = data.questions.map((question) => ({
                    id: `quiz_2025_${question.id}`,
                    przedmiot: 'egzamin ósmoklasisty',
                    temat: question.department,
                    tresc: question.question,
                    typ: 'zamkniete',
                    odpowiedzi: [
                        question.options.a,
                        question.options.b,
                        question.options.c,
                        question.options.d
                    ],
                    poprawna: question.correctAnswer.toUpperCase(),
                    punkty: 1,
                    poziom: 'podstawowy',
                    rok: '2025',
                    sesja: 'główna',
                    obrazek: question.hasImage && question.imageSvg ? question.imageSvg : null,
                    wyjaśnienie: question.explanation || null
                }));

                // Pobierz istniejące zadania
                const existingTasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]');
                const existingIds = new Set(existingTasks.map(t => t.id));
                const newTasks = tasksToLoad.filter(t => !existingIds.has(t.id));
                
                if (newTasks.length === 0) {
                    document.getElementById('loadStatus').innerHTML = 
                        '<p class="error">Wszystkie zadania już istnieją w bazie</p>';
                    return;
                }

                // Dodaj nowe zadania
                const allTasks = [...existingTasks, ...newTasks];
                localStorage.setItem('zadaniaDB', JSON.stringify(allTasks));
                
                document.getElementById('loadStatus').innerHTML = 
                    `<p class="success">Dodano ${newTasks.length} nowych zadań z quiz_data.json</p>`;
                
                checkDatabase();
            } catch (error) {
                document.getElementById('loadStatus').innerHTML = 
                    `<p class="error">Błąd: ${error.message}</p>`;
            }
        }

        async function loadUpdatedDatabase() {
            try {
                const response = await fetch('./updated-exam-database.json');
                const tasksToLoad = await response.json();
                
                // Pobierz istniejące zadania
                const existingTasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]');
                const existingIds = new Set(existingTasks.map(t => t.id));
                const newTasks = tasksToLoad.filter(t => !existingIds.has(t.id));
                
                if (newTasks.length === 0) {
                    document.getElementById('loadStatus').innerHTML = 
                        '<p class="error">Wszystkie zadania już istnieją w bazie</p>';
                    return;
                }

                // Dodaj nowe zadania
                const allTasks = [...existingTasks, ...newTasks];
                localStorage.setItem('zadaniaDB', JSON.stringify(allTasks));
                
                document.getElementById('loadStatus').innerHTML = 
                    `<p class="success">Dodano ${newTasks.length} nowych zadań z updated-exam-database.json</p>`;
                
                checkDatabase();
            } catch (error) {
                document.getElementById('loadStatus').innerHTML = 
                    `<p class="error">Błąd: ${error.message}</p>`;
            }
        }

        function exportDatabase() {
            try {
                const tasks = JSON.parse(localStorage.getItem('zadaniaDB') || '[]');
                const dataStr = JSON.stringify(tasks, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `baza-zadan-export-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                alert(`Wyeksportowano ${tasks.length} zadań`);
            } catch (error) {
                alert(`Błąd: ${error.message}`);
            }
        }

        function clearDatabase() {
            if (confirm('Czy na pewno chcesz usunąć wszystkie zadania?')) {
                localStorage.setItem('zadaniaDB', JSON.stringify([]));
                alert('Baza została wyczyszczona');
                checkDatabase();
            }
        }

        // Sprawdź bazę przy starcie
        window.onload = () => {
            checkDatabase();
        };
    </script>
</body>
</html>