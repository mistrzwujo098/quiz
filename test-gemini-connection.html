<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test połączenia z Gemini API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/task-variant-generator.js"></script>
    <style>
        body {
            background: #0a0a0a;
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-6 max-w-4xl">
        <div class="glass rounded-lg p-6">
            <h1 class="text-2xl font-bold mb-6">Test połączenia z Gemini API</h1>
            
            <div id="status" class="mb-6"></div>
            
            <div id="tests" class="space-y-4"></div>
            
            <button id="runTests" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">
                <i class="fas fa-play mr-2"></i>Uruchom testy
            </button>
        </div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const testsDiv = document.getElementById('tests');
        const runButton = document.getElementById('runTests');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `p-3 rounded mb-2 ${
                type === 'error' ? 'bg-red-900/50 text-red-300' : 
                type === 'success' ? 'bg-green-900/50 text-green-300' : 
                'bg-blue-900/50 text-blue-300'
            }`;
            div.innerHTML = `<i class="fas fa-${
                type === 'error' ? 'times-circle' : 
                type === 'success' ? 'check-circle' : 
                'info-circle'
            } mr-2"></i>${message}`;
            testsDiv.appendChild(div);
        }
        
        async function runTests() {
            testsDiv.innerHTML = '';
            runButton.disabled = true;
            
            log('Rozpoczynam testy połączenia z Gemini API...');
            
            // Test 1: Sprawdzenie serwera proxy
            try {
                log('Test 1: Sprawdzanie dostępności serwera proxy...');
                const healthResponse = await fetch('http://localhost:3001/api/health');
                if (healthResponse.ok) {
                    const health = await healthResponse.json();
                    log(`Serwer proxy działa poprawnie: ${health.status}`, 'success');
                } else {
                    throw new Error('Serwer proxy nie odpowiada');
                }
            } catch (error) {
                log(`Błąd połączenia z serwerem proxy: ${error.message}`, 'error');
                log('Upewnij się, że serwer jest uruchomiony: cd server && npm start', 'error');
                runButton.disabled = false;
                return;
            }
            
            // Test 2: Autoryzacja
            try {
                log('Test 2: Autoryzacja w systemie...');
                const generator = new TaskVariantGenerator();
                const authSuccess = await generator.authenticate('test_user', 'teacher');
                if (authSuccess) {
                    log('Autoryzacja zakończona sukcesem', 'success');
                } else {
                    throw new Error('Autoryzacja nie powiodła się');
                }
            } catch (error) {
                log(`Błąd autoryzacji: ${error.message}`, 'error');
                runButton.disabled = false;
                return;
            }
            
            // Test 3: Sprawdzenie statusu sesji
            try {
                log('Test 3: Sprawdzanie statusu sesji...');
                const token = localStorage.getItem('geminiSessionToken');
                const statusResponse = await fetch('http://localhost:3001/api/auth/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    log(`Status sesji: użytkownik ${status.userId}, rola: ${status.role}, limit: ${status.dailyLimit}`, 'success');
                } else {
                    throw new Error('Nie można pobrać statusu sesji');
                }
            } catch (error) {
                log(`Błąd sprawdzania sesji: ${error.message}`, 'error');
            }
            
            // Test 4: Testowe zadanie
            const testTask = {
                id: 'test_1',
                tresc: 'Oblicz pole prostokąta o bokach 5 cm i 8 cm.',
                typ: 'zamkniete',
                odpowiedzi: ['40 cm²', '13 cm²', '35 cm²', '45 cm²'],
                poprawna: '40 cm²',
                przedmiot: 'Matematyka',
                temat: 'Geometria',
                poziom: 'podstawowy',
                punkty: 1
            };
            
            // Test 5: Sprawdzenie możliwości generacji
            try {
                log('Test 4: Sprawdzanie możliwości generacji wariantu...');
                const generator = new TaskVariantGenerator();
                const canGenerate = generator.canGenerateVariant(testTask);
                log(`Zadanie może być generowane: ${canGenerate.canGenerate}`, 'success');
                log(`Wymaga AI: ${canGenerate.requiresAI}`, 'info');
                log(`Szacowany koszt: $${canGenerate.estimatedCost}`, 'info');
            } catch (error) {
                log(`Błąd sprawdzania możliwości generacji: ${error.message}`, 'error');
            }
            
            // Test 6: Generacja wariantu
            try {
                log('Test 5: Generowanie wariantu zadania...');
                const generator = new TaskVariantGenerator();
                
                // Najpierw autoryzuj
                await generator.authenticate('test_user', 'teacher');
                
                const result = await generator.generateVariant(testTask, { useAI: true });
                
                if (result.success) {
                    log('Wariant wygenerowany pomyślnie!', 'success');
                    log(`Nowa treść: ${result.variant.tresc}`, 'info');
                    log(`Poprawna odpowiedź: ${result.variant.poprawna}`, 'info');
                    log(`Użyto AI: ${result.usedAI}`, 'info');
                    log(`Koszt: $${result.estimatedCost}`, 'info');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                log(`Błąd generowania wariantu: ${error.message}`, 'error');
                console.error('Szczegóły błędu:', error);
            }
            
            // Test 7: Test bezpośredniego wywołania API
            try {
                log('Test 6: Bezpośrednie wywołanie API Gemini przez proxy...');
                const token = localStorage.getItem('geminiSessionToken');
                const response = await fetch('http://localhost:3001/api/gemini/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        prompt: 'Odpowiedz tylko "TEST OK" jeśli to widzisz.',
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 10
                        }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    log(`Odpowiedź Gemini: ${text}`, 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Nieznany błąd');
                }
            } catch (error) {
                log(`Błąd wywołania Gemini API: ${error.message}`, 'error');
            }
            
            runButton.disabled = false;
            log('Testy zakończone', 'info');
        }
        
        runButton.addEventListener('click', runTests);
        
        // Sprawdź status serwera przy załadowaniu
        fetch('http://localhost:3001/api/health')
            .then(res => res.ok ? 'Serwer proxy jest dostępny' : 'Serwer proxy nie odpowiada')
            .then(msg => statusDiv.innerHTML = `<div class="p-3 rounded ${msg.includes('dostępny') ? 'bg-green-900/50 text-green-300' : 'bg-red-900/50 text-red-300'}">${msg}</div>`)
            .catch(() => statusDiv.innerHTML = '<div class="p-3 rounded bg-red-900/50 text-red-300">Serwer proxy nie jest uruchomiony. Uruchom go poleceniem: cd server && npm start</div>');
    </script>
</body>
</html>